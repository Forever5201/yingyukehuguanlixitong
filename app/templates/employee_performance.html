{% extends "base.html" %}

{% block title %}员工业绩管理 - 教育培训管理系统{% endblock %}
{% block page_title %}员工业绩中心{% endblock %}

{% block head %}
<style>
/* 员工业绩页面专属样式 */
.performance-header {
    text-align: center;
    margin-bottom: 40px;
}

.performance-title {
    font-size: 32px;
    font-weight: 700;
    color: var(--edu-gray-900);
    margin-bottom: 12px;
}

.performance-subtitle {
    font-size: 16px;
    color: var(--edu-gray-600);
}

/* 员工网格布局 */
.employees-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 24px;
    margin-top: 24px;
}

.employee-card {
    background: white;
    border-radius: var(--edu-radius-xl);
    padding: 28px;
    box-shadow: var(--edu-shadow-md);
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.employee-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--edu-gradient-primary);
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.3s ease;
}

.employee-card:hover::before {
    transform: scaleX(1);
}

.employee-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--edu-shadow-lg);
}

.employee-avatar {
    width: 72px;
    height: 72px;
    margin: 0 auto 20px;
    background: var(--edu-gradient-primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    color: white;
    box-shadow: var(--edu-shadow-colored);
}

.employee-info {
    text-align: center;
}

.employee-info h4 {
    font-size: 20px;
    font-weight: 700;
    color: var(--edu-gray-900);
    margin-bottom: 16px;
}

.employee-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 20px;
}

.stat-item {
    padding: 12px;
    background: var(--edu-gray-50);
    border-radius: var(--edu-radius-md);
    text-align: center;
}

.stat-label {
    display: block;
    font-size: 12px;
    color: var(--edu-gray-600);
    margin-bottom: 4px;
}

.stat-value {
    display: block;
    font-size: 18px;
    font-weight: 700;
    color: var(--edu-gray-900);
}

/* 业绩排行榜 */
.ranking-section {
    background: white;
    border-radius: var(--edu-radius-xl);
    padding: 32px;
    box-shadow: var(--edu-shadow-md);
    margin-top: 40px;
}

.ranking-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 24px;
}

.ranking-icon {
    width: 48px;
    height: 48px;
    background: var(--edu-gradient-warm);
    border-radius: var(--edu-radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
}

.ranking-title {
    font-size: 24px;
    font-weight: 700;
    color: var(--edu-gray-900);
}

.ranking-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.ranking-item {
    display: flex;
    align-items: center;
    padding: 20px;
    background: var(--edu-gray-50);
    border-radius: var(--edu-radius-lg);
    transition: all 0.3s ease;
}

.ranking-item:hover {
    background: white;
    box-shadow: var(--edu-shadow-md);
    transform: translateX(8px);
}

/* 前三名特殊样式 */
.ranking-item.rank-1 {
    background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
    color: white;
}

.ranking-item.rank-2 {
    background: linear-gradient(135deg, #C0C0C0 0%, #B8B8B8 100%);
    color: white;
}

.ranking-item.rank-3 {
    background: linear-gradient(135deg, #CD7F32 0%, #B87333 100%);
    color: white;
}

.ranking-position {
    width: 40px;
    height: 40px;
    background: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 18px;
    margin-right: 16px;
    color: var(--edu-gray-900);
}

.ranking-item.rank-1 .ranking-position,
.ranking-item.rank-2 .ranking-position,
.ranking-item.rank-3 .ranking-position {
    background: rgba(255, 255, 255, 0.9);
}

.ranking-employee {
    flex: 1;
}

.ranking-employee-name {
    font-weight: 600;
    font-size: 16px;
    margin-bottom: 4px;
}

.ranking-employee-dept {
    font-size: 14px;
    opacity: 0.8;
}

.ranking-metric {
    text-align: right;
}

.ranking-metric-value {
    font-size: 20px;
    font-weight: 700;
}

.ranking-metric-label {
    font-size: 12px;
    opacity: 0.8;
}

/* 业绩图表 */
.performance-charts {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-top: 32px;
}

.chart-card {
    background: white;
    border-radius: var(--edu-radius-xl);
    padding: 24px;
    box-shadow: var(--edu-shadow-md);
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.chart-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--edu-gray-900);
}

.chart-period {
    display: flex;
    gap: 8px;
}

.period-btn {
    padding: 6px 12px;
    border: 1px solid var(--edu-gray-300);
    background: white;
    border-radius: var(--edu-radius-sm);
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.period-btn.active {
    background: var(--edu-primary);
    color: white;
    border-color: var(--edu-primary);
}

/* 员工详情模态框 */
.employee-detail-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.employee-detail-modal.show {
    opacity: 1;
    visibility: visible;
}

.employee-detail-content {
    background: white;
    border-radius: var(--edu-radius-xl);
    max-width: 800px;
    width: 100%;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: var(--edu-shadow-xl);
    transform: scale(0.9);
    transition: transform 0.3s ease;
}

.employee-detail-modal.show .employee-detail-content {
    transform: scale(1);
}

/* 响应式设计 */
@media (max-width: 1024px) {
    .performance-charts {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .employees-grid {
        grid-template-columns: 1fr;
    }
    
    .employee-stats {
        grid-template-columns: 1fr 1fr;
    }
    
    .ranking-item {
        padding: 16px;
    }
    
    .ranking-position {
        width: 32px;
        height: 32px;
        font-size: 16px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <!-- 员工列表 -->
    <div class="employees-section">
        <div class="section-header">
            <h3><i class="fas fa-users"></i> 员工列表</h3>
            <div class="header-actions">
                <a href="{{ url_for('main.manage_config') }}#employee-config" class="btn btn-primary" target="_blank">
                    <i class="fas fa-cog"></i> 员工管理
                </a>
            </div>
        </div>
        
        <div class="employees-grid">
            {% for employee in employees %}
            <div class="employee-card" onclick="showEmployeeDetail({{ employee.id }})">
                <div class="employee-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="employee-info">
                    <h4>{{ employee.name }}</h4>
                    <div class="employee-stats">
                        <div class="stat-item">
                            <span class="stat-label">试听课</span>
                            <span class="stat-value">{{ employee.stats.trial_count }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">正课</span>
                            <span class="stat-value">{{ employee.stats.formal_count }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">转化率</span>
                            <span class="stat-value">{{ "%.1f"|format(employee.stats.conversion_rate) }}%</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">本月业绩</span>
                            <span class="stat-value">¥{{ "%.2f"|format(employee.stats.monthly_revenue) }}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- 业绩详情区域 -->
    <div id="performanceDetail" style="display: none;">
        <div class="detail-header">
            <h3><i class="fas fa-chart-line"></i> <span id="detailEmployeeName"></span>的业绩详情</h3>
            <button class="btn btn-secondary" onclick="hidePerformanceDetail()">
                <i class="fas fa-times"></i> 关闭
            </button>
        </div>

        <!-- 业绩统计卡片 -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-headphones"></i>
                </div>
                <div class="stat-content">
                    <h3 id="trialCount">0</h3>
                    <p>试听课总数</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-exchange-alt"></i>
                </div>
                <div class="stat-content">
                    <h3 id="convertedCount">0</h3>
                    <p>转化数量</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-percentage"></i>
                </div>
                <div class="stat-content">
                    <h3 id="conversionRate">0%</h3>
                    <p>转化率</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div class="stat-content">
                    <h3 id="formalCount">0</h3>
                    <p>正课总数</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="stat-content">
                    <h3 id="totalRevenue">¥0</h3>
                    <p>总业绩</p>
                </div>
            </div>
        </div>

        <!-- 提成配置显示 -->
        <div class="commission-config-display">
            <h4><i class="fas fa-cog"></i> 提成配置</h4>
            <div class="config-display">
                <div class="config-row">
                    <div class="config-item">
                        <label>底薪：</label>
                        <span id="display_base_salary">¥0</span>
                    </div>
                    <div class="config-item">
                        <label>提成类型：</label>
                        <span id="display_commission_type">利润提成</span>
                    </div>
                </div>
                <div class="config-row">
                    <div class="config-item">
                        <label>新课提成比例：</label>
                        <span id="display_new_course_rate">0%</span>
                    </div>
                    <div class="config-item">
                        <label>续课提成比例：</label>
                        <span id="display_renewal_rate">0%</span>
                    </div>
                </div>
                <div class="config-note">
                    <small><i class="fas fa-info-circle"></i> 提成配置请在 <a href="{{ url_for('main.manage_config') }}#employee-config" target="_blank">系统配置</a> 中修改</small>
                </div>
            </div>
        </div>

        <!-- 业绩明细表格 -->
        <div class="performance-tables">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" data-toggle="tab" href="#trialTab">试听课记录</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#formalTab">正课记录</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#commissionTab">提成明细</a>
                </li>
            </ul>

            <div class="tab-content">
                <!-- 试听课记录 -->
                <div id="trialTab" class="tab-pane active">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>学员姓名</th>
                                <th>试听价格</th>
                                <th>状态</th>
                                <th>报名时间</th>
                                <th>是否转化</th>
                            </tr>
                        </thead>
                        <tbody id="trialTableBody">
                            <!-- 动态加载 -->
                        </tbody>
                    </table>
                </div>

                <!-- 正课记录 -->
                <div id="formalTab" class="tab-pane">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>学员姓名</th>
                                <th>课程类型</th>
                                <th>购买节数</th>
                                <th>总金额</th>
                                <th>利润</th>
                                <th>是否续课</th>
                                <th>报名时间</th>
                            </tr>
                        </thead>
                        <tbody id="formalTableBody">
                            <!-- 动态加载 -->
                        </tbody>
                    </table>
                </div>

                <!-- 提成明细 -->
                <div id="commissionTab" class="tab-pane">
                    <div class="commission-summary">
                        <h5>本月提成汇总</h5>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <label>新课提成：</label>
                                <span id="newCourseCommission">¥0.00</span>
                            </div>
                            <div class="summary-item">
                                <label>续课提成：</label>
                                <span id="renewalCommission">¥0.00</span>
                            </div>
                            <div class="summary-item total">
                                <label>提成合计：</label>
                                <span id="totalCommission">¥0.00</span>
                            </div>
                            <div class="summary-item total">
                                <label>底薪：</label>
                                <span id="baseSalaryDisplay">¥0.00</span>
                            </div>
                            <div class="summary-item total">
                                <label>本月薪资：</label>
                                <span id="totalSalary">¥0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 员工管理功能已移至系统配置页面 -->

<script>
let currentEmployeeId = null;

// 员工管理功能已移至系统配置页面
// 如需添加、编辑、删除员工，请点击右上角的"员工管理"按钮

// 显示员工详情
function showEmployeeDetail(employeeId) {
    currentEmployeeId = employeeId;
    document.getElementById('performanceDetail').style.display = 'block';
    
    // 加载员工业绩数据
    fetch(`/api/employees/${employeeId}/performance`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updatePerformanceDisplay(data);
            }
        });
    
    // 加载提成配置
    fetch(`/api/employees/${employeeId}/commission-config`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateCommissionDisplay(data);
            }
        });
}

// 更新业绩显示
function updatePerformanceDisplay(data) {
    // 更新员工姓名
    document.getElementById('detailEmployeeName').textContent = data.employee_name;
    
    // 更新统计数据
    document.getElementById('trialCount').textContent = data.stats.trial_count;
    document.getElementById('convertedCount').textContent = data.stats.converted_count;
    document.getElementById('conversionRate').textContent = data.stats.conversion_rate.toFixed(1) + '%';
    document.getElementById('formalCount').textContent = data.stats.formal_count || 0;
    document.getElementById('totalRevenue').textContent = '¥' + data.stats.total_revenue.toFixed(2);
    
    // 更新试听课表格
    const trialTableBody = document.getElementById('trialTableBody');
    trialTableBody.innerHTML = '';
    data.trial_courses.forEach(course => {
        const row = `
            <tr>
                <td>${course.customer_name}</td>
                <td>¥${course.trial_price.toFixed(2)}</td>
                <td>${course.trial_status}</td>
                <td>${course.created_at}</td>
                <td>${course.is_converted ? '是' : '否'}</td>
            </tr>
        `;
        trialTableBody.innerHTML += row;
    });
    
    // 更新正课表格
    const formalTableBody = document.getElementById('formalTableBody');
    formalTableBody.innerHTML = '';
    data.formal_courses.forEach(course => {
        const row = `
            <tr>
                <td>${course.customer_name}</td>
                <td>${course.course_type}</td>
                <td>${course.sessions}</td>
                <td>¥${course.total_amount.toFixed(2)}</td>
                <td>¥${course.profit.toFixed(2)}</td>
                <td>${course.is_renewal ? '是' : '否'}</td>
                <td>${course.created_at}</td>
            </tr>
        `;
        formalTableBody.innerHTML += row;
    });
    
    // 更新提成明细
    // 试听课不参与提成，所以不显示trialCommission
    document.getElementById('newCourseCommission').textContent = '¥' + data.commission.new_course_commission.toFixed(2);
    document.getElementById('renewalCommission').textContent = '¥' + data.commission.renewal_commission.toFixed(2);
    document.getElementById('totalCommission').textContent = '¥' + data.commission.total_commission.toFixed(2);
    document.getElementById('baseSalaryDisplay').textContent = '¥' + data.commission.base_salary.toFixed(2);
    document.getElementById('totalSalary').textContent = '¥' + data.commission.total_salary.toFixed(2);
}

// 隐藏业绩详情
function hidePerformanceDetail() {
    document.getElementById('performanceDetail').style.display = 'none';
}

// 更新提成配置显示
function updateCommissionDisplay(data) {
    if (data.config) {
        document.getElementById('display_base_salary').textContent = '¥' + (data.config.base_salary || 0).toFixed(2);
        document.getElementById('display_commission_type').textContent = data.config.commission_type === 'profit' ? '利润提成' : '销售额提成';
        document.getElementById('display_new_course_rate').textContent = (data.config.new_course_rate || 0) + '%';
        document.getElementById('display_renewal_rate').textContent = (data.config.renewal_rate || 0) + '%';
    }
}
</script>

<style>
.employees-section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.section-header h3 {
    margin: 0;
    color: #333;
}

.header-actions {
    display: flex;
    gap: 10px;
    align-items: center;
}

.header-actions .btn {
    display: flex;
    align-items: center;
    gap: 5px;
}

.employees-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
}

.employee-card {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    border: 2px solid transparent;
}

.employee-card:hover {
    border-color: #007bff;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.employee-avatar {
    text-align: center;
    font-size: 48px;
    color: #6c757d;
    margin-bottom: 10px;
}

.employee-info h4 {
    text-align: center;
    margin: 0 0 15px 0;
    color: #333;
}

.employee-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    text-align: center;
}

.stat-item {
    display: flex;
    flex-direction: column;
}

.stat-label {
    font-size: 12px;
    color: #6c757d;
}

.stat-value {
    font-size: 16px;
    font-weight: bold;
    color: #333;
}

#performanceDetail {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.stats-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 15px;
}

.stat-icon {
    width: 50px;
    height: 50px;
    background: #007bff;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}

.stat-content h3 {
    margin: 0;
    color: #333;
    font-size: 24px;
}

.stat-content p {
    margin: 5px 0 0 0;
    color: #6c757d;
    font-size: 14px;
}

.commission-config {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 30px;
}

.commission-config h4 {
    margin: 0 0 20px 0;
    color: #333;
}

.commission-summary {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
}

.summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    background: white;
    border-radius: 5px;
}

.summary-item.total {
    background: #e7f3ff;
    font-weight: bold;
}

.nav-tabs {
    border-bottom: 2px solid #dee2e6;
    margin-bottom: 20px;
}

.nav-link {
    color: #6c757d;
    border: none;
    padding: 10px 20px;
}

.nav-link.active {
    color: #007bff;
    border-bottom: 2px solid #007bff;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #dee2e6;
}

.data-table th {
    background: #f8f9fa;
    font-weight: 600;
}

.required {
    color: #dc3545;
}

/* 提成配置显示样式 */
.commission-config-display {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.config-display {
    margin-top: 15px;
}

.config-row {
    display: flex;
    gap: 30px;
    margin-bottom: 15px;
}

.config-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.config-item label {
    font-weight: 600;
    color: #495057;
    min-width: 120px;
}

.config-item span {
    color: #007bff;
    font-weight: 500;
}

.config-note {
    margin-top: 15px;
    padding: 10px;
    background: #e3f2fd;
    border-radius: 4px;
    border-left: 4px solid #2196f3;
}

.config-note small {
    color: #1976d2;
}

.config-note a {
    color: #1565c0;
    text-decoration: underline;
}

/* 响应式设计 */
@media (max-width: 768px) {
    .config-row {
        flex-direction: column;
        gap: 10px;
    }
    
    .config-item {
        justify-content: space-between;
    }
}
</style>
{% endblock %}