{% extends "base.html" %}

{% block title %}å‘˜å·¥ä¸šç»©ç®¡ç† - æ•™è‚²åŸ¹è®­ç®¡ç†ç³»ç»Ÿ{% endblock %}
{% block page_title %}å‘˜å·¥ä¸šç»©ä¸­å¿ƒ{% endblock %}

{% block head %}
<style>
/* CSSå˜é‡å®šä¹‰ */
:root {
    /* ä¸šåŠ¡æ¿å—ä¸»é¢˜è‰² */
    --trial-primary: #3b82f6;
    --trial-secondary: #60a5fa;
    --trial-bg: #dbeafe;
    --trial-gradient: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    
    --formal-primary: #10b981;
    --formal-secondary: #34d399;
    --formal-bg: #d1fae5;
    --formal-gradient: linear-gradient(135deg, #10b981 0%, #047857 100%);
    
    --renewal-primary: #f59e0b;
    --renewal-secondary: #fbbf24;
    --renewal-bg: #fef3c7;
    --renewal-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    
    --refund-primary: #ef4444;
    --refund-secondary: #f87171;
    --refund-bg: #fee2e2;
    --refund-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}

/* é¡µé¢æ•´ä½“å¸ƒå±€ */
.performance-container {
    padding: 20px;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    min-height: 100vh;
}

/* é¡µé¢æ ‡é¢˜ */
.page-header {
    text-align: center;
    margin-bottom: 40px;
}

.page-title {
    font-size: 42px;
    font-weight: 800;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 12px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.page-subtitle {
    font-size: 18px;
    color: #64748b;
    font-weight: 500;
}

/* å‘˜å·¥é€‰æ‹©å™¨ */
.employee-selector {
    background: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    margin-bottom: 32px;
    border: 1px solid #e2e8f0;
}

.selector-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
}

.selector-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
}

.selector-title {
    font-size: 20px;
    font-weight: 700;
    color: #1e293b;
}

.employee-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
}

.employee-option {
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    text-align: center;
}

.employee-option:hover {
    border-color: #667eea;
    background: white;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
}

.employee-option.selected {
    border-color: #667eea;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.employee-avatar {
    width: 64px;
    height: 64px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 16px;
    font-size: 28px;
    color: white;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.employee-option.selected .employee-avatar {
    background: rgba(255, 255, 255, 0.2);
}

.employee-name {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 8px;
    color: #1e293b;
}

.employee-option.selected .employee-name {
    color: white;
}

.employee-summary {
    font-size: 14px;
    color: #64748b;
}

.employee-option.selected .employee-summary {
    color: rgba(255, 255, 255, 0.9);
}

/* ä¸šåŠ¡å¡ç‰‡ç½‘æ ¼ */
.business-cards-container {
    display: none;
    animation: fadeInUp 0.6s ease-out;
}

.business-cards-container.show {
    display: block;
}

.business-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 24px;
    margin-bottom: 32px;
}

/* ä¸šåŠ¡å¡ç‰‡åŸºç¡€æ ·å¼ */
.business-card {
    border-radius: 20px;
    padding: 28px;
    color: white;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
}

.business-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.1);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.business-card:hover::before {
    opacity: 1;
}

.business-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 16px 48px rgba(0, 0, 0, 0.2);
}

/* å„ä¸šåŠ¡ç±»å‹ä¸»é¢˜è‰² */
.business-card.trial {
    background: var(--trial-gradient);
}

.business-card.formal {
    background: var(--formal-gradient);
}

.business-card.renewal {
    background: var(--renewal-gradient);
}

.business-card.refund {
    background: var(--refund-gradient);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
}

.card-icon {
    width: 56px;
    height: 56px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
    backdrop-filter: blur(10px);
}

.card-badge {
    background: rgba(255, 255, 255, 0.25);
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    backdrop-filter: blur(10px);
}

.card-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 8px;
    color: white;
}

.card-description {
    font-size: 14px;
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 20px;
    line-height: 1.5;
}

.card-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
}

.stat-item {
    background: rgba(255, 255, 255, 0.15);
    padding: 16px;
    border-radius: 12px;
    backdrop-filter: blur(10px);
}

.stat-label {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-value {
    font-size: 20px;
    font-weight: 700;
    color: white;
}

/* ç©ºçŠ¶æ€æ ·å¼ */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #64748b;
}

.empty-icon {
    font-size: 64px;
    color: #cbd5e1;
    margin-bottom: 20px;
}

.empty-title {
    font-size: 20px;
    font-weight: 600;
    color: #475569;
    margin-bottom: 8px;
}

.empty-description {
    font-size: 14px;
    color: #64748b;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 1024px) {
    .business-grid {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
    }
}

@media (max-width: 768px) {
    .performance-container {
        padding: 16px;
    }
    
    .page-title {
        font-size: 32px;
    }
    
    .business-grid {
        grid-template-columns: 1fr;
    }
    
    .employee-grid {
        grid-template-columns: 1fr;
    }
    
    .card-stats {
        grid-template-columns: 1fr;
    }
}

/* åŠ¨ç”»æ•ˆæœ */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="performance-container">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="page-header">
        <h1 class="page-title">ğŸ“Š å‘˜å·¥ä¸šç»©ä¸­å¿ƒ</h1>
        <p class="page-subtitle">å…¨æ–¹ä½å±•ç¤ºå‘˜å·¥æ•™å­¦ä¸šç»©ï¼ŒåŠ©åŠ›å›¢é˜Ÿåä½œä¸æˆé•¿</p>
    </div>

    <!-- å‘˜å·¥é€‰æ‹©å™¨ -->
    <div class="employee-selector">
        <div class="selector-header">
            <div class="selector-icon">
                <i class="fas fa-users"></i>
            </div>
            <h3 class="selector-title">é€‰æ‹©å‘˜å·¥æŸ¥çœ‹ä¸šç»©è¯¦æƒ…</h3>
        </div>
        
        <div class="employee-grid">
            {% for employee in employees %}
            <div class="employee-option" onclick="selectEmployee({{ employee.id }}, '{{ employee.name }}')">
                <div class="employee-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="employee-name">{{ employee.name }}</div>
                <div class="employee-summary">
                    è¯•å¬è¯¾ {{ employee.stats.trial_count }}èŠ‚ | è½¬åŒ–ç‡ {{ "%.1f"|format(employee.stats.conversion_rate) }}%
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- ä¸šåŠ¡å¡ç‰‡å±•ç¤ºåŒºåŸŸ -->
    <div id="businessCardsContainer" class="business-cards-container">
        <div class="business-grid">
            <!-- è¯•å¬è¯¾å¡ç‰‡ - è“è‰²ä¸»é¢˜ -->
            <div class="business-card trial" onclick="showStudentDetail('trial')">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-headphones"></i>
                    </div>
                    <div class="card-badge" id="trialBadge">0</div>
                </div>
                <h3 class="card-title">ğŸ”µ è¯•å¬è¯¾ç¨‹</h3>
                <p class="card-description">å±•ç¤ºå­¦å‘˜è¯•å¬è¯¾ç¨‹çš„æŠ¥åæƒ…å†µï¼Œè·Ÿè¸ªæ½œåœ¨å®¢æˆ·çš„å­¦ä¹ æ„å‘å’Œåˆæ­¥ä½“éªŒ</p>
                <div class="card-stats">
                    <div class="stat-item">
                        <div class="stat-label">æ€»æ•°é‡</div>
                        <div class="stat-value" id="trialCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">è½¬åŒ–æ•°</div>
                        <div class="stat-value" id="trialConverted">0</div>
                    </div>
                </div>
            </div>

            <!-- æ­£è¯¾å¡ç‰‡ - ç»¿è‰²ä¸»é¢˜ -->
            <div class="business-card formal" onclick="showStudentDetail('formal')">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="card-badge" id="formalBadge">0</div>
                </div>
                <h3 class="card-title">ğŸŸ¢ æ­£å¼è¯¾ç¨‹</h3>
                <p class="card-description">ç®¡ç†æ­£å¼æŠ¥åçš„å­¦å‘˜è¯¾ç¨‹ï¼Œè®°å½•å®Œæ•´çš„å­¦ä¹ å†ç¨‹å’Œè¯¾ç¨‹è¿›åº¦</p>
                <div class="card-stats">
                    <div class="stat-item">
                        <div class="stat-label">å­¦å‘˜æ•°</div>
                        <div class="stat-value" id="formalCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æ€»æ”¶å…¥</div>
                        <div class="stat-value" id="formalRevenue">Â¥0</div>
                    </div>
                </div>
            </div>

            <!-- ç»­è¯¾å¡ç‰‡ - æ©™è‰²ä¸»é¢˜ -->
            <div class="business-card renewal" onclick="showStudentDetail('renewal')">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-redo-alt"></i>
                    </div>
                    <div class="card-badge" id="renewalBadge">0</div>
                </div>
                <h3 class="card-title">ğŸŸ  ç»­è¯¾æœåŠ¡</h3>
                <p class="card-description">å¤„ç†å­¦å‘˜çš„ç»­è¯¾éœ€æ±‚ï¼Œç»´æŠ¤é•¿æœŸçš„å¸ˆç”Ÿå…³ç³»å’ŒæŒç»­çš„å­¦ä¹ ä½“éªŒ</p>
                <div class="card-stats">
                    <div class="stat-item">
                        <div class="stat-label">ç»­è¯¾æ•°</div>
                        <div class="stat-value" id="renewalCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">ç»­è¯¾ç‡</div>
                        <div class="stat-value" id="renewalRate">0%</div>
                    </div>
                </div>
            </div>

            <!-- é€€è¯¾å¡ç‰‡ - çº¢è‰²ä¸»é¢˜ -->
            <div class="business-card refund" onclick="showStudentDetail('refund')">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-undo-alt"></i>
                    </div>
                    <div class="card-badge" id="refundBadge">0</div>
                </div>
                <h3 class="card-title">ğŸ”´ é€€è¯¾å¤„ç†</h3>
                <p class="card-description">å¦¥å–„å¤„ç†å­¦å‘˜é€€è¯¾ç”³è¯·ï¼Œä¿éšœå®¢æˆ·æƒç›Šå¹¶åˆ†ææ”¹è¿›æ•™å­¦è´¨é‡</p>
                <div class="card-stats">
                    <div class="stat-item">
                        <div class="stat-label">é€€è¯¾æ•°</div>
                        <div class="stat-value" id="refundCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">é€€æ¬¾é¢</div>
                        <div class="stat-value" id="refundAmount">Â¥0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç©ºçŠ¶æ€æç¤º -->
    <div id="emptyState" class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-chart-line"></i>
        </div>
        <h3 class="empty-title">è¯·é€‰æ‹©å‘˜å·¥æŸ¥çœ‹ä¸šç»©</h3>
        <p class="empty-description">ç‚¹å‡»ä¸Šæ–¹å‘˜å·¥å¡ç‰‡ï¼ŒæŸ¥çœ‹è¯¦ç»†çš„ä¸šç»©æ•°æ®å’Œå­¦å‘˜ä¿¡æ¯</p>
    </div>
</div>

<script>
let currentEmployeeId = null;
let currentEmployeeName = '';
let studentsData = null;

// é€‰æ‹©å‘˜å·¥
function selectEmployee(employeeId, employeeName) {
    // æ›´æ–°é€‰ä¸­çŠ¶æ€
    document.querySelectorAll('.employee-option').forEach(option => {
        option.classList.remove('selected');
    });
    event.currentTarget.classList.add('selected');
    
    currentEmployeeId = employeeId;
    currentEmployeeName = employeeName;
    
    // æ˜¾ç¤ºä¸šåŠ¡å¡ç‰‡
    document.getElementById('businessCardsContainer').classList.add('show');
    document.getElementById('emptyState').style.display = 'none';
    
    // åŠ è½½å‘˜å·¥å­¦å‘˜æ•°æ®
    loadEmployeeStudents(employeeId);
}

// åŠ è½½å‘˜å·¥å­¦å‘˜æ•°æ®
function loadEmployeeStudents(employeeId) {
    fetch(`/api/employees/${employeeId}/students`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                studentsData = data;
                updateBusinessCards(data);
            } else {
                showError('åŠ è½½å­¦å‘˜æ•°æ®å¤±è´¥');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
        });
}

// æ›´æ–°ä¸šåŠ¡å¡ç‰‡æ•°æ®
function updateBusinessCards(data) {
    // è¯•å¬è¯¾æ•°æ®
    const trialStudents = data.students.filter(s => s.course_type === 'trial');
    const trialConverted = trialStudents.filter(s => s.is_converted).length;
    
    document.getElementById('trialBadge').textContent = trialStudents.length;
    document.getElementById('trialCount').textContent = trialStudents.length;
    document.getElementById('trialConverted').textContent = trialConverted;
    
    // æ­£è¯¾æ•°æ®
    const formalStudents = data.students.filter(s => s.course_type === 'formal');
    const formalRevenue = formalStudents.reduce((sum, s) => sum + (s.total_amount || 0), 0);
    
    document.getElementById('formalBadge').textContent = formalStudents.length;
    document.getElementById('formalCount').textContent = formalStudents.length;
    document.getElementById('formalRevenue').textContent = 'Â¥' + formalRevenue.toFixed(2);
    
    // ç»­è¯¾æ•°æ®
    const renewalStudents = data.students.filter(s => s.is_renewal);
    const renewalRate = formalStudents.length > 0 ? (renewalStudents.length / formalStudents.length * 100) : 0;
    
    document.getElementById('renewalBadge').textContent = renewalStudents.length;
    document.getElementById('renewalCount').textContent = renewalStudents.length;
    document.getElementById('renewalRate').textContent = renewalRate.toFixed(1) + '%';
    
    // é€€è¯¾æ•°æ®
    const refundStudents = data.students.filter(s => s.refund_status === 'refunded');
    const refundAmount = refundStudents.reduce((sum, s) => sum + (s.refund_amount || 0), 0);
    
    document.getElementById('refundBadge').textContent = refundStudents.length;
    document.getElementById('refundCount').textContent = refundStudents.length;
    document.getElementById('refundAmount').textContent = 'Â¥' + refundAmount.toFixed(2);
}

// æ˜¾ç¤ºå­¦å‘˜è¯¦æƒ…ï¼ˆç®€åŒ–ç‰ˆï¼‰
function showStudentDetail(type) {
    if (!studentsData) {
        alert('è¯·å…ˆé€‰æ‹©å‘˜å·¥');
        return;
    }
    
    // ç®€åŒ–ç‰ˆï¼šç›´æ¥æ˜¾ç¤ºæç¤º
    const messages = {
        'trial': 'è¯•å¬è¯¾å­¦å‘˜è¯¦æƒ…åŠŸèƒ½å¼€å‘ä¸­...',
        'formal': 'æ­£è¯¾å­¦å‘˜è¯¦æƒ…åŠŸèƒ½å¼€å‘ä¸­...',
        'renewal': 'ç»­è¯¾å­¦å‘˜è¯¦æƒ…åŠŸèƒ½å¼€å‘ä¸­...',
        'refund': 'é€€è¯¾å­¦å‘˜è¯¦æƒ…åŠŸèƒ½å¼€å‘ä¸­...'
    };
    
    alert(messages[type] || 'åŠŸèƒ½å¼€å‘ä¸­...');
}

// é”™è¯¯æç¤º
function showError(message) {
    alert('é”™è¯¯: ' + message);
}
</script>
{% endblock %}