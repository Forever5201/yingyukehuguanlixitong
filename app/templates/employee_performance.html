{% extends "base.html" %}

{% block title %}员工业绩管理 - 教育培训管理系统{% endblock %}
{% block page_title %}员工业绩中心{% endblock %}

{% block head %}
<style>
/* CSS变量定义 */
:root {
    /* 业务板块主题色 */
    --trial-primary: #3b82f6;
    --trial-secondary: #60a5fa;
    --trial-bg: #dbeafe;
    --trial-gradient: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    
    --formal-primary: #10b981;
    --formal-secondary: #34d399;
    --formal-bg: #d1fae5;
    --formal-gradient: linear-gradient(135deg, #10b981 0%, #047857 100%);
    
    --renewal-primary: #f59e0b;
    --renewal-secondary: #fbbf24;
    --renewal-bg: #fef3c7;
    --renewal-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    
    --refund-primary: #ef4444;
    --refund-secondary: #f87171;
    --refund-bg: #fee2e2;
    --refund-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}

/* 页面整体布局 */
.performance-container {
    padding: 20px;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    min-height: 100vh;
}

/* 页面标题 */
.page-header {
    text-align: center;
    margin-bottom: 40px;
}

.page-title {
    font-size: 42px;
    font-weight: 800;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 12px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.page-subtitle {
    font-size: 18px;
    color: #64748b;
    font-weight: 500;
}

/* 员工选择器 */
.employee-selector {
    background: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    margin-bottom: 32px;
    border: 1px solid #e2e8f0;
}

.selector-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
}

.selector-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
}

.selector-title {
    font-size: 20px;
    font-weight: 700;
    color: #1e293b;
}

.employee-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
}

.employee-option {
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    text-align: center;
}

.employee-option:hover {
    border-color: #667eea;
    background: white;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
}

.employee-option.selected {
    border-color: #667eea;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.employee-avatar {
    width: 64px;
    height: 64px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 16px;
    font-size: 28px;
    color: white;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.employee-option.selected .employee-avatar {
    background: rgba(255, 255, 255, 0.2);
}

.employee-name {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 8px;
    color: #1e293b;
}

.employee-option.selected .employee-name {
    color: white;
}

.employee-summary {
    font-size: 14px;
    color: #64748b;
}

.employee-option.selected .employee-summary {
    color: rgba(255, 255, 255, 0.9);
}

/* 业务卡片网格 */
.business-cards-container {
    display: none;
    animation: fadeInUp 0.6s ease-out;
}

.business-cards-container.show {
    display: block;
}

.business-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 24px;
    margin-bottom: 32px;
}

/* 业务卡片基础样式 */
.business-card {
    border-radius: 20px;
    padding: 28px;
    color: white;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
}

.business-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.1);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.business-card:hover::before {
    opacity: 1;
}

.business-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 16px 48px rgba(0, 0, 0, 0.2);
}

/* 各业务类型主题色 */
.business-card.trial {
    background: var(--trial-gradient);
}

.business-card.formal {
    background: var(--formal-gradient);
}

.business-card.renewal {
    background: var(--renewal-gradient);
}

.business-card.refund {
    background: var(--refund-gradient);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
}

.card-icon {
    width: 56px;
    height: 56px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
    backdrop-filter: blur(10px);
}

.card-badge {
    background: rgba(255, 255, 255, 0.25);
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    backdrop-filter: blur(10px);
}

.card-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 8px;
    color: white;
}

.card-description {
    font-size: 14px;
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 20px;
    line-height: 1.5;
}

.card-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
}

.stat-item {
    background: rgba(255, 255, 255, 0.15);
    padding: 16px;
    border-radius: 12px;
    backdrop-filter: blur(10px);
}

.stat-label {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-value {
    font-size: 20px;
    font-weight: 700;
    color: white;
}

/* 空状态样式 */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #64748b;
}

.empty-icon {
    font-size: 64px;
    color: #cbd5e1;
    margin-bottom: 20px;
}

.empty-title {
    font-size: 20px;
    font-weight: 600;
    color: #475569;
    margin-bottom: 8px;
}

.empty-description {
    font-size: 14px;
    color: #64748b;
}

/* 响应式设计 */
@media (max-width: 1024px) {
    .business-grid {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
    }
}

@media (max-width: 768px) {
    .performance-container {
        padding: 16px;
    }
    
    .page-title {
        font-size: 32px;
    }
    
    .business-grid {
        grid-template-columns: 1fr;
    }
    
    .employee-grid {
        grid-template-columns: 1fr;
    }
    
    .card-stats {
        grid-template-columns: 1fr;
    }
}

/* 动画效果 */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="performance-container">
    <!-- 页面标题 -->
    <div class="page-header">
        <h1 class="page-title">📊 员工业绩中心</h1>
        <p class="page-subtitle">全方位展示员工教学业绩，助力团队协作与成长</p>
    </div>

    <!-- 员工选择器 -->
    <div class="employee-selector">
        <div class="selector-header">
            <div class="selector-icon">
                <i class="fas fa-users"></i>
            </div>
            <h3 class="selector-title">选择员工查看业绩详情</h3>
        </div>
        
        <div class="employee-grid">
            {% for employee in employees %}
            <div class="employee-option" onclick="selectEmployee({{ employee.id }}, '{{ employee.name }}')">
                <div class="employee-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="employee-name">{{ employee.name }}</div>
                <div class="employee-summary">
                    试听课 {{ employee.stats.trial_count }}节 | 转化率 {{ "%.1f"|format(employee.stats.conversion_rate) }}%
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- 业务卡片展示区域 -->
    <div id="businessCardsContainer" class="business-cards-container">
        <div class="business-grid">
            <!-- 试听课卡片 - 蓝色主题 -->
            <div class="business-card trial" onclick="showStudentDetail('trial')">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-headphones"></i>
                    </div>
                    <div class="card-badge" id="trialBadge">0</div>
                </div>
                <h3 class="card-title">🔵 试听课程</h3>
                <p class="card-description">展示学员试听课程的报名情况，跟踪潜在客户的学习意向和初步体验</p>
                <div class="card-stats">
                    <div class="stat-item">
                        <div class="stat-label">总数量</div>
                        <div class="stat-value" id="trialCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">转化数</div>
                        <div class="stat-value" id="trialConverted">0</div>
                    </div>
                </div>
            </div>

            <!-- 正课卡片 - 绿色主题 -->
            <div class="business-card formal" onclick="showStudentDetail('formal')">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="card-badge" id="formalBadge">0</div>
                </div>
                <h3 class="card-title">🟢 正式课程</h3>
                <p class="card-description">管理正式报名的学员课程，记录完整的学习历程和课程进度</p>
                <div class="card-stats">
                    <div class="stat-item">
                        <div class="stat-label">学员数</div>
                        <div class="stat-value" id="formalCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">总收入</div>
                        <div class="stat-value" id="formalRevenue">¥0</div>
                    </div>
                </div>
            </div>

            <!-- 续课卡片 - 橙色主题 -->
            <div class="business-card renewal" onclick="showStudentDetail('renewal')">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-redo-alt"></i>
                    </div>
                    <div class="card-badge" id="renewalBadge">0</div>
                </div>
                <h3 class="card-title">🟠 续课服务</h3>
                <p class="card-description">处理学员的续课需求，维护长期的师生关系和持续的学习体验</p>
                <div class="card-stats">
                    <div class="stat-item">
                        <div class="stat-label">续课数</div>
                        <div class="stat-value" id="renewalCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">续课率</div>
                        <div class="stat-value" id="renewalRate">0%</div>
                    </div>
                </div>
            </div>

            <!-- 退课卡片 - 红色主题 -->
            <div class="business-card refund" onclick="showStudentDetail('refund')">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-undo-alt"></i>
                    </div>
                    <div class="card-badge" id="refundBadge">0</div>
                </div>
                <h3 class="card-title">🔴 退课处理</h3>
                <p class="card-description">妥善处理学员退课申请，保障客户权益并分析改进教学质量</p>
                <div class="card-stats">
                    <div class="stat-item">
                        <div class="stat-label">退课数</div>
                        <div class="stat-value" id="refundCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">退款额</div>
                        <div class="stat-value" id="refundAmount">¥0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 空状态提示 -->
    <div id="emptyState" class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-chart-line"></i>
        </div>
        <h3 class="empty-title">请选择员工查看业绩</h3>
        <p class="empty-description">点击上方员工卡片，查看详细的业绩数据和学员信息</p>
    </div>
</div>

<script>
let currentEmployeeId = null;
let currentEmployeeName = '';
let studentsData = null;

// 选择员工
function selectEmployee(employeeId, employeeName) {
    // 更新选中状态
    document.querySelectorAll('.employee-option').forEach(option => {
        option.classList.remove('selected');
    });
    event.currentTarget.classList.add('selected');
    
    currentEmployeeId = employeeId;
    currentEmployeeName = employeeName;
    
    // 显示业务卡片
    document.getElementById('businessCardsContainer').classList.add('show');
    document.getElementById('emptyState').style.display = 'none';
    
    // 加载员工学员数据
    loadEmployeeStudents(employeeId);
}

// 加载员工学员数据
function loadEmployeeStudents(employeeId) {
    fetch(`/api/employees/${employeeId}/students`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                studentsData = data;
                updateBusinessCards(data);
            } else {
                showError('加载学员数据失败');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('网络错误，请重试');
        });
}

// 更新业务卡片数据
function updateBusinessCards(data) {
    // 试听课数据
    const trialStudents = data.students.filter(s => s.course_type === 'trial');
    const trialConverted = trialStudents.filter(s => s.is_converted).length;
    
    document.getElementById('trialBadge').textContent = trialStudents.length;
    document.getElementById('trialCount').textContent = trialStudents.length;
    document.getElementById('trialConverted').textContent = trialConverted;
    
    // 正课数据
    const formalStudents = data.students.filter(s => s.course_type === 'formal');
    const formalRevenue = formalStudents.reduce((sum, s) => sum + (s.total_amount || 0), 0);
    
    document.getElementById('formalBadge').textContent = formalStudents.length;
    document.getElementById('formalCount').textContent = formalStudents.length;
    document.getElementById('formalRevenue').textContent = '¥' + formalRevenue.toFixed(2);
    
    // 续课数据
    const renewalStudents = data.students.filter(s => s.is_renewal);
    const renewalRate = formalStudents.length > 0 ? (renewalStudents.length / formalStudents.length * 100) : 0;
    
    document.getElementById('renewalBadge').textContent = renewalStudents.length;
    document.getElementById('renewalCount').textContent = renewalStudents.length;
    document.getElementById('renewalRate').textContent = renewalRate.toFixed(1) + '%';
    
    // 退课数据
    const refundStudents = data.students.filter(s => s.refund_status === 'refunded');
    const refundAmount = refundStudents.reduce((sum, s) => sum + (s.refund_amount || 0), 0);
    
    document.getElementById('refundBadge').textContent = refundStudents.length;
    document.getElementById('refundCount').textContent = refundStudents.length;
    document.getElementById('refundAmount').textContent = '¥' + refundAmount.toFixed(2);
}

// 显示学员详情（简化版）
function showStudentDetail(type) {
    if (!studentsData) {
        alert('请先选择员工');
        return;
    }
    
    // 简化版：直接显示提示
    const messages = {
        'trial': '试听课学员详情功能开发中...',
        'formal': '正课学员详情功能开发中...',
        'renewal': '续课学员详情功能开发中...',
        'refund': '退课学员详情功能开发中...'
    };
    
    alert(messages[type] || '功能开发中...');
}

// 错误提示
function showError(message) {
    alert('错误: ' + message);
}
</script>
{% endblock %}