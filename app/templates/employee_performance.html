{% extends "base.html" %}

{% block title %}员工业绩管理 - 客户管理系统{% endblock %}
{% block page_title %}员工业绩管理{% endblock %}

{% block content %}
<div class="page-container">
    <!-- 员工列表 -->
    <div class="employees-section">
        <div class="section-header">
            <h3><i class="fas fa-users"></i> 员工列表</h3>
            <button class="btn btn-primary" onclick="showAddEmployeeModal()">
                <i class="fas fa-plus"></i> 添加员工
            </button>
        </div>
        
        <div class="employees-grid">
            {% for employee in employees %}
            <div class="employee-card" onclick="showEmployeeDetail({{ employee.id }})">
                <div class="employee-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="employee-info">
                    <h4>{{ employee.name }}</h4>
                    <div class="employee-stats">
                        <div class="stat-item">
                            <span class="stat-label">试听课</span>
                            <span class="stat-value">{{ employee.stats.trial_count }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">转化率</span>
                            <span class="stat-value">{{ "%.1f"|format(employee.stats.conversion_rate) }}%</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">本月业绩</span>
                            <span class="stat-value">¥{{ "%.2f"|format(employee.stats.monthly_revenue) }}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- 业绩详情区域 -->
    <div id="performanceDetail" style="display: none;">
        <div class="detail-header">
            <h3><i class="fas fa-chart-line"></i> <span id="detailEmployeeName"></span>的业绩详情</h3>
            <button class="btn btn-secondary" onclick="hidePerformanceDetail()">
                <i class="fas fa-times"></i> 关闭
            </button>
        </div>

        <!-- 业绩统计卡片 -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-headphones"></i>
                </div>
                <div class="stat-content">
                    <h3 id="trialCount">0</h3>
                    <p>试听课总数</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-exchange-alt"></i>
                </div>
                <div class="stat-content">
                    <h3 id="convertedCount">0</h3>
                    <p>转化数量</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-percentage"></i>
                </div>
                <div class="stat-content">
                    <h3 id="conversionRate">0%</h3>
                    <p>转化率</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="stat-content">
                    <h3 id="totalRevenue">¥0</h3>
                    <p>总业绩</p>
                </div>
            </div>
        </div>

        <!-- 提成配置 -->
        <div class="commission-config">
            <h4><i class="fas fa-cog"></i> 提成配置</h4>
            <form id="commissionConfigForm">
                <input type="hidden" id="config_employee_id" name="employee_id">
                <div class="form-row">
                    <div class="form-group">
                        <label>底薪（元/月）</label>
                        <input type="number" id="base_salary" name="base_salary" step="100" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label>提成类型</label>
                        <select id="commission_type" name="commission_type" onchange="toggleCommissionFields()">
                            <option value="profit">利润提成</option>
                            <option value="sales">销售额提成</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>试听课提成比例（%）</label>
                        <input type="number" id="trial_rate" name="trial_rate" step="0.1" min="0" max="100" value="0">
                    </div>
                    <div class="form-group">
                        <label>新课提成比例（%）</label>
                        <input type="number" id="new_course_rate" name="new_course_rate" step="0.1" min="0" max="100" value="0">
                    </div>
                    <div class="form-group">
                        <label>续课提成比例（%）</label>
                        <input type="number" id="renewal_rate" name="renewal_rate" step="0.1" min="0" max="100" value="0">
                    </div>
                </div>
                <button type="button" class="btn btn-primary" onclick="saveCommissionConfig()">
                    <i class="fas fa-save"></i> 保存配置
                </button>
            </form>
        </div>

        <!-- 业绩明细表格 -->
        <div class="performance-tables">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" data-toggle="tab" href="#trialTab">试听课记录</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#formalTab">正课记录</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#commissionTab">提成明细</a>
                </li>
            </ul>

            <div class="tab-content">
                <!-- 试听课记录 -->
                <div id="trialTab" class="tab-pane active">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>学员姓名</th>
                                <th>试听价格</th>
                                <th>状态</th>
                                <th>报名时间</th>
                                <th>是否转化</th>
                            </tr>
                        </thead>
                        <tbody id="trialTableBody">
                            <!-- 动态加载 -->
                        </tbody>
                    </table>
                </div>

                <!-- 正课记录 -->
                <div id="formalTab" class="tab-pane">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>学员姓名</th>
                                <th>课程类型</th>
                                <th>购买节数</th>
                                <th>总金额</th>
                                <th>利润</th>
                                <th>是否续课</th>
                                <th>报名时间</th>
                            </tr>
                        </thead>
                        <tbody id="formalTableBody">
                            <!-- 动态加载 -->
                        </tbody>
                    </table>
                </div>

                <!-- 提成明细 -->
                <div id="commissionTab" class="tab-pane">
                    <div class="commission-summary">
                        <h5>本月提成汇总</h5>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <label>试听课提成：</label>
                                <span id="trialCommission">¥0.00</span>
                            </div>
                            <div class="summary-item">
                                <label>新课提成：</label>
                                <span id="newCourseCommission">¥0.00</span>
                            </div>
                            <div class="summary-item">
                                <label>续课提成：</label>
                                <span id="renewalCommission">¥0.00</span>
                            </div>
                            <div class="summary-item total">
                                <label>提成合计：</label>
                                <span id="totalCommission">¥0.00</span>
                            </div>
                            <div class="summary-item total">
                                <label>底薪：</label>
                                <span id="baseSalaryDisplay">¥0.00</span>
                            </div>
                            <div class="summary-item total">
                                <label>本月薪资：</label>
                                <span id="totalSalary">¥0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加员工模态框 -->
<div id="addEmployeeModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加员工</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addEmployeeForm">
                    <div class="form-group">
                        <label>员工姓名 <span class="required">*</span></label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>联系电话</label>
                        <input type="tel" class="form-control" name="phone">
                    </div>
                    <div class="form-group">
                        <label>邮箱</label>
                        <input type="email" class="form-control" name="email">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveNewEmployee()">保存</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentEmployeeId = null;

// 显示添加员工模态框
function showAddEmployeeModal() {
    const modal = document.getElementById('addEmployeeModal');
    modal.style.display = 'block';
    modal.classList.add('show');
}

// 保存新员工
function saveNewEmployee() {
    const formData = new FormData(document.getElementById('addEmployeeForm'));
    
    fetch('/api/employees', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const modal = document.getElementById('addEmployeeModal');
            modal.style.display = 'none';
            modal.classList.remove('show');
            location.reload();
        } else {
            alert(data.message || '添加失败');
        }
    });
}

// 显示员工详情
function showEmployeeDetail(employeeId) {
    currentEmployeeId = employeeId;
    document.getElementById('performanceDetail').style.display = 'block';
    
    // 加载员工业绩数据
    fetch(`/api/employees/${employeeId}/performance`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updatePerformanceDisplay(data);
            }
        });
    
    // 加载提成配置
    fetch(`/api/employees/${employeeId}/commission-config`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.config) {
                document.getElementById('config_employee_id').value = employeeId;
                document.getElementById('base_salary').value = data.config.base_salary || 0;
                document.getElementById('commission_type').value = data.config.commission_type || 'profit';
                document.getElementById('trial_rate').value = data.config.trial_rate || 0;
                document.getElementById('new_course_rate').value = data.config.new_course_rate || 0;
                document.getElementById('renewal_rate').value = data.config.renewal_rate || 0;
            }
        });
}

// 更新业绩显示
function updatePerformanceDisplay(data) {
    // 更新员工姓名
    document.getElementById('detailEmployeeName').textContent = data.employee_name;
    
    // 更新统计数据
    document.getElementById('trialCount').textContent = data.stats.trial_count;
    document.getElementById('convertedCount').textContent = data.stats.converted_count;
    document.getElementById('conversionRate').textContent = data.stats.conversion_rate.toFixed(1) + '%';
    document.getElementById('totalRevenue').textContent = '¥' + data.stats.total_revenue.toFixed(2);
    
    // 更新试听课表格
    const trialTableBody = document.getElementById('trialTableBody');
    trialTableBody.innerHTML = '';
    data.trial_courses.forEach(course => {
        const row = `
            <tr>
                <td>${course.customer_name}</td>
                <td>¥${course.trial_price.toFixed(2)}</td>
                <td>${course.trial_status}</td>
                <td>${course.created_at}</td>
                <td>${course.is_converted ? '是' : '否'}</td>
            </tr>
        `;
        trialTableBody.innerHTML += row;
    });
    
    // 更新正课表格
    const formalTableBody = document.getElementById('formalTableBody');
    formalTableBody.innerHTML = '';
    data.formal_courses.forEach(course => {
        const row = `
            <tr>
                <td>${course.customer_name}</td>
                <td>${course.course_type}</td>
                <td>${course.sessions}</td>
                <td>¥${course.total_amount.toFixed(2)}</td>
                <td>¥${course.profit.toFixed(2)}</td>
                <td>${course.is_renewal ? '是' : '否'}</td>
                <td>${course.created_at}</td>
            </tr>
        `;
        formalTableBody.innerHTML += row;
    });
    
    // 更新提成明细
    document.getElementById('trialCommission').textContent = '¥' + data.commission.trial_commission.toFixed(2);
    document.getElementById('newCourseCommission').textContent = '¥' + data.commission.new_course_commission.toFixed(2);
    document.getElementById('renewalCommission').textContent = '¥' + data.commission.renewal_commission.toFixed(2);
    document.getElementById('totalCommission').textContent = '¥' + data.commission.total_commission.toFixed(2);
    document.getElementById('baseSalaryDisplay').textContent = '¥' + data.commission.base_salary.toFixed(2);
    document.getElementById('totalSalary').textContent = '¥' + data.commission.total_salary.toFixed(2);
}

// 隐藏业绩详情
function hidePerformanceDetail() {
    document.getElementById('performanceDetail').style.display = 'none';
}

// 保存提成配置
function saveCommissionConfig() {
    const formData = new FormData(document.getElementById('commissionConfigForm'));
    
    fetch(`/api/employees/${currentEmployeeId}/commission-config`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('提成配置保存成功');
            showEmployeeDetail(currentEmployeeId); // 刷新数据
        } else {
            alert(data.message || '保存失败');
        }
    });
}
</script>

<style>
.employees-section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.section-header h3 {
    margin: 0;
    color: #333;
}

.employees-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
}

.employee-card {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    border: 2px solid transparent;
}

.employee-card:hover {
    border-color: #007bff;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.employee-avatar {
    text-align: center;
    font-size: 48px;
    color: #6c757d;
    margin-bottom: 10px;
}

.employee-info h4 {
    text-align: center;
    margin: 0 0 15px 0;
    color: #333;
}

.employee-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    text-align: center;
}

.stat-item {
    display: flex;
    flex-direction: column;
}

.stat-label {
    font-size: 12px;
    color: #6c757d;
}

.stat-value {
    font-size: 16px;
    font-weight: bold;
    color: #333;
}

#performanceDetail {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.stats-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 15px;
}

.stat-icon {
    width: 50px;
    height: 50px;
    background: #007bff;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}

.stat-content h3 {
    margin: 0;
    color: #333;
    font-size: 24px;
}

.stat-content p {
    margin: 5px 0 0 0;
    color: #6c757d;
    font-size: 14px;
}

.commission-config {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 30px;
}

.commission-config h4 {
    margin: 0 0 20px 0;
    color: #333;
}

.commission-summary {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
}

.summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    background: white;
    border-radius: 5px;
}

.summary-item.total {
    background: #e7f3ff;
    font-weight: bold;
}

.nav-tabs {
    border-bottom: 2px solid #dee2e6;
    margin-bottom: 20px;
}

.nav-link {
    color: #6c757d;
    border: none;
    padding: 10px 20px;
}

.nav-link.active {
    color: #007bff;
    border-bottom: 2px solid #007bff;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #dee2e6;
}

.data-table th {
    background: #f8f9fa;
    font-weight: 600;
}

.required {
    color: #dc3545;
}
</style>
{% endblock %}