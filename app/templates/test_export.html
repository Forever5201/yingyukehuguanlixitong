<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel导出功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-button {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Excel导出功能测试</h1>
        <p>测试刷单管理的Excel导出功能是否正常工作</p>
        
        <button class="test-button" onclick="testMethod1()">方法1: 创建隐藏链接下载</button>
        <button class="test-button" onclick="testMethod2()">方法2: 直接跳转下载</button>
        <button class="test-button" onclick="testMethod3()">方法3: Fetch API测试</button>
        <button class="test-button" onclick="testMethod4()">方法4: XMLHttpRequest测试</button>
        <button class="test-button" onclick="clearLog()">清空日志</button>
        
        <div class="log-area" id="logArea"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logArea').innerHTML = '';
        }

        // 方法1: 创建隐藏链接下载（原始方法）
        function testMethod1() {
            log('开始测试方法1: 创建隐藏链接下载');
            
            try {
                const link = document.createElement('a');
                link.href = '/api/export/taobao-orders';
                link.download = '';
                link.style.display = 'none';
                
                log('创建链接元素成功');
                
                document.body.appendChild(link);
                log('链接已添加到DOM');
                
                link.click();
                log('触发点击事件', 'success');
                
                document.body.removeChild(link);
                log('清理链接元素完成');
                
                // 检查是否有错误
                setTimeout(() => {
                    log('方法1测试完成，请检查是否有文件下载', 'success');
                }, 1000);
                
            } catch (error) {
                log(`方法1出错: ${error.message}`, 'error');
            }
        }

        // 方法2: 直接跳转下载
        function testMethod2() {
            log('开始测试方法2: 直接跳转下载');
            
            try {
                window.location.href = '/api/export/taobao-orders';
                log('直接跳转成功', 'success');
            } catch (error) {
                log(`方法2出错: ${error.message}`, 'error');
            }
        }

        // 方法3: Fetch API测试
        function testMethod3() {
            log('开始测试方法3: Fetch API测试');
            
            fetch('/api/export/taobao-orders')
                .then(response => {
                    log(`响应状态: ${response.status} ${response.statusText}`);
                    log(`Content-Type: ${response.headers.get('Content-Type')}`);
                    log(`Content-Length: ${response.headers.get('Content-Length')}`);
                    log(`Content-Disposition: ${response.headers.get('Content-Disposition')}`);
                    
                    if (response.ok) {
                        return response.blob();
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                })
                .then(blob => {
                    log(`接收到文件，大小: ${blob.size} bytes`);
                    
                    // 创建下载链接
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = '刷单数据_测试.xlsx';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    
                    log('方法3测试完成，文件下载成功', 'success');
                })
                .catch(error => {
                    log(`方法3出错: ${error.message}`, 'error');
                });
        }

        // 方法4: XMLHttpRequest测试
        function testMethod4() {
            log('开始测试方法4: XMLHttpRequest测试');
            
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/export/taobao-orders', true);
            xhr.responseType = 'blob';
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    log(`XHR响应状态: ${xhr.status}`);
                    log(`响应类型: ${xhr.response.type}`);
                    log(`文件大小: ${xhr.response.size} bytes`);
                    
                    // 创建下载链接
                    const url = window.URL.createObjectURL(xhr.response);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = '刷单数据_XHR测试.xlsx';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    
                    log('方法4测试完成，文件下载成功', 'success');
                } else {
                    log(`方法4出错: HTTP ${xhr.status}`, 'error');
                }
            };
            
            xhr.onerror = function() {
                log('方法4出错: 网络错误', 'error');
            };
            
            xhr.send();
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            log('页面加载完成，开始测试Excel导出功能');
            log('后端API地址: /api/export/taobao-orders');
            log('请点击上方按钮进行测试');
        });
    </script>
</body>
</html>