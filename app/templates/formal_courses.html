{% extends "base.html" %}
{% block title %}正课管理 - 英语培训管理系统{% endblock %}
{% block page_title %}正课管理{% endblock %}

{% block head %}
{% endblock %}

{% block content %}
<div class="animate-in">
    <!-- 统计卡片 -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-graduation-cap"></i></div>
            <div class="stat-info">
                <h3>正课总数</h3>
                <p class="stat-number" id="stat-total-courses">{{ stats.total_courses }}</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-layer-group"></i></div>
            <div class="stat-info">
                <h3>销售总节数</h3>
                <p class="stat-number" id="stat-total-sessions">0</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-money-bill-wave"></i></div>
            <div class="stat-info">
                <h3>总收入</h3>
                <p class="stat-number" id="stat-total-revenue">¥{{ "%.2f"|format(stats.total_revenue) }}</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-plus-circle"></i></div>
            <div class="stat-info">
                <h3>新购收入</h3>
                <p class="stat-number" id="stat-new-revenue">¥0.00</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-redo-alt"></i></div>
            <div class="stat-info">
                <h3>续课收入</h3>
                <p class="stat-number" id="stat-renewal-revenue">¥0.00</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-coins"></i></div>
            <div class="stat-info">
                <h3>总成本</h3>
                <p class="stat-number" id="stat-total-cost">¥{{ "%.2f"|format(stats.total_cost) }}</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
            <div class="stat-info">
                <h3>总利润</h3>
                <p class="stat-number" id="stat-total-profit">¥{{ "%.2f"|format(stats.total_profit) }}</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-percentage"></i></div>
            <div class="stat-info">
                <h3>总手续费</h3>
                <p class="stat-number" id="stat-total-fees">¥{{ "%.2f"|format(stats.total_fees) }}</p>
            </div>
        </div>
    </div>

    <!-- 说明卡片 -->
    <div class="info-card mb-4">
        <div class="info-icon"><i class="fas fa-info-circle"></i></div>
        <div class="info-content">
            <h4>正课管理说明</h4>
            <p>正课记录只能通过试听课转化生成，不支持直接添加。请前往<a href="{{ url_for('main.manage_trial_courses') }}"
                    class="link">试听课管理</a>页面进行转化操作。</p>
        </div>
    </div>

    <!-- 操作栏 -->
    <div class="action-bar">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="search" id="searchInput" placeholder="搜索学员姓名..." autocomplete="new-password"
                data-form-type="other" data-lpignore="true" readonly onfocus="this.removeAttribute('readonly');">
        </div>
        <div class="action-buttons">
            <button class="btn btn-success" onclick="exportFormalData()"><i class="fas fa-download"></i> 导出数据</button>
        </div>
    </div>

    <!-- 正课列表 -->
    <div class="table-container mobile-card-view">
        <div class="table-header">
            <h3><i class="fas fa-list"></i> 正课记录</h3>
            <span class="text-muted">共 <span id="totalRecords">0</span> 条记录</span>
        </div>
        <div style="overflow-x:auto;">
            <table class="modern-table" id="formalTable">
                <thead>
                    <tr>
                        <th width="40"><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
                        <th>学员姓名</th>
                        <th>课程状态</th>
                        <th>课程类型</th>
                        <th>购买节数</th>
                        <th>赠课节数</th>
                        <th>单节售价</th>
                        <th>支付渠道</th>
                        <th>实际收入</th>
                        <th>课程成本</th>
                        <th>利润</th>
                        <th>报名时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="formalTableBody">
                    <tr>
                        <td colspan="12" class="text-center text-muted" style="padding:40px;">加载中...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <!-- 分页控件 -->
        <div class="pagination-container"
            style="display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-top:1px solid var(--gray-200);">
            <div class="pagination-info" style="color:var(--gray-500);font-size:13px;">
                显示第 <span id="showStart">1</span>-<span id="showEnd">0</span> 条，共 <span id="showTotal">0</span> 条
            </div>
            <div class="pagination-buttons" style="display:flex;gap:8px;align-items:center;">
                <select id="pageSize" class="form-control" style="width:auto;font-size:13px;padding:4px 8px;"
                    onchange="changePageSize()">
                    <option value="10">10条/页</option>
                    <option value="20" selected>20条/页</option>
                    <option value="50">50条/页</option>
                    <option value="100">100条/页</option>
                </select>
                <button class="btn btn-sm btn-secondary" id="prevPage" onclick="goToPage('prev')" disabled><i
                        class="fas fa-chevron-left"></i> 上一页</button>
                <span style="padding:0 8px;font-size:14px;">第 <span id="currentPage">1</span>/<span
                        id="totalPages">1</span> 页</span>
                <button class="btn btn-sm btn-secondary" id="nextPage" onclick="goToPage('next')">下一页 <i
                        class="fas fa-chevron-right"></i></button>
            </div>
        </div>
    </div>
</div>

<!-- 退费模态框 -->
<div id="refundModal" class="modal">
    <div class="modal-content" style="max-width:450px;">
        <div class="modal-header">
            <h4><i class="fas fa-undo"></i> 正课退费</h4>
            <span class="close" onclick="closeRefundModal()">&times;</span>
        </div>
        <form id="refundForm">
            <input type="hidden" id="refund_course_id">
            <div class="modal-body">
                <div class="form-group"><label>退费金额 *</label><input type="number" id="refund_amount" step="0.01" min="0"
                        class="form-control" required></div>
                <div class="form-group"><label>退费手续费</label><input type="number" id="refund_fee" step="0.01" min="0"
                        class="form-control" value="0"></div>
                <div class="form-group"><label>已上节数</label><input type="number" id="refund_used_sessions" min="0"
                        class="form-control" value="0"></div>
                <div class="form-group"><label>退款渠道 *</label><select id="refund_channel" class="form-control" required>
                        <option value="">请选择</option>
                        <option value="微信">微信</option>
                        <option value="淘宝">淘宝</option>
                        <option value="支付宝">支付宝</option>
                        <option value="银行转账">银行转账</option>
                        <option value="其他">其他</option>
                    </select></div>
                <div class="form-group"><label>退费说明</label><textarea id="refund_note" class="form-control"
                        rows="2"></textarea></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeRefundModal()">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitRefund()"><i class="fas fa-check"></i>
                    确认退费</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    /* 可点击行样式 */
    .clickable-row {
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .clickable-row:hover {
        background-color: #f0f4ff;
    }
</style>
<script>
    // 加载数据
    document.addEventListener('DOMContentLoaded', function () {
        fetch('/api/formal-courses/stats')
            .then(r => r.json())
            .then(data => {
                if (data && !data.error) {
                    updateStats(data);
                    updateTable(data.rows || []);
                }
            });
    });

    // ========== 分页变量 ==========
    let currentPage = 1;
    let pageSize = 20;
    let allRows = [];
    let filteredRows = [];

    function updateStats(data) {
        const rows = data.rows || [];
        const totalSessions = rows.reduce((s, r) => s + (r.sessions || 0) + (r.gift_sessions || 0), 0);
        document.getElementById('stat-total-courses').textContent = rows.length;
        document.getElementById('stat-total-sessions').textContent = totalSessions;
        document.getElementById('stat-total-revenue').textContent = `¥${(data.total_revenue || 0).toFixed(2)}`;
        document.getElementById('stat-new-revenue').textContent = `¥${(data.new_revenue || 0).toFixed(2)}`;
        document.getElementById('stat-renewal-revenue').textContent = `¥${(data.renewal_revenue || 0).toFixed(2)}`;
        document.getElementById('stat-total-cost').textContent = `¥${(data.total_cost || 0).toFixed(2)}`;
        document.getElementById('stat-total-profit').textContent = `¥${(data.total_profit || 0).toFixed(2)}`;
        document.getElementById('stat-total-fees').textContent = `¥${(data.total_fees || 0).toFixed(2)}`;

        // 保存所有数据用于分页
        allRows = rows;
        filteredRows = [...rows];
        currentPage = 1;
        renderTable();
    }

    function renderTable() {
        const tbody = document.getElementById('formalTableBody');
        const totalRecords = filteredRows.length;
        const totalPages = Math.ceil(totalRecords / pageSize) || 1;

        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;

        const start = (currentPage - 1) * pageSize;
        const end = Math.min(start + pageSize, totalRecords);
        const pageRows = filteredRows.slice(start, end);

        if (!pageRows.length) {
            tbody.innerHTML = '<tr><td colspan="12" class="text-center text-muted" style="padding:40px;">暂无正课记录</td></tr>';
        } else {
            tbody.innerHTML = pageRows.map(r => `
            <tr class="clickable-row" data-customer-id="${r.customer_id || ''}" onclick="handleRowClick(event, ${r.customer_id || 'null'})">
                <td data-label="选择"><input type="checkbox" class="course-checkbox" value="${r.id}" onclick="updateBatchBtn()"></td>
                <td data-label="学员">${r.customer_name || '-'}</td>
                <td data-label="状态">${r.is_renewal ? '<span class="badge badge-success">续课</span>' : '<span class="badge badge-primary">新购</span>'}</td>
                <td data-label="类型">${r.course_type || '-'}</td>
                <td data-label="节数">${r.counted_sessions || r.sessions || 0}</td>
                <td data-label="赠课">${r.gift_sessions || 0}</td>
                <td data-label="单价">¥${(r.price || 0).toFixed(2)}</td>
                <td data-label="渠道"><span class="badge badge-info">${r.payment_channel || '-'}</span></td>
                <td data-label="收入">¥${(r.revenue || 0).toFixed(2)}</td>
                <td data-label="成本">¥${(r.adjusted_course_cost || 0).toFixed(2)}</td>
                <td data-label="利润" class="${(r.profit || 0) >= 0 ? 'text-success' : 'text-danger'}">¥${(r.profit || 0).toFixed(2)}</td>
                <td data-label="时间">${r.created_at ? new Date(r.created_at).toLocaleDateString('zh-CN') : '-'}</td>
                <td data-label="操作">
                    <div style="display:flex;gap:4px;flex-wrap:wrap;">
                        <a href="/formal-courses/${r.id}/details" class="btn btn-sm btn-outline-info" title="明细"><i class="fas fa-calculator"></i></a>
                        <a href="/renew-course/${r.id}" class="btn btn-sm btn-outline-success" title="续课"><i class="fas fa-plus-circle"></i></a>
                        <button onclick="showRefundModal(${r.id})" class="btn btn-sm btn-outline-warning" title="退费"><i class="fas fa-undo"></i></button>
                        <button onclick="deleteFormalCourse(${r.id})" class="btn btn-sm btn-outline-danger" title="删除"><i class="fas fa-trash"></i></button>
                    </div>
                </td>
            </tr>
        `).join('');
        }

        // 更新分页信息
        document.getElementById('showStart').textContent = totalRecords > 0 ? start + 1 : 0;
        document.getElementById('showEnd').textContent = end;
        document.getElementById('showTotal').textContent = totalRecords;
        document.getElementById('totalRecords').textContent = totalRecords;
        document.getElementById('currentPage').textContent = currentPage;
        document.getElementById('totalPages').textContent = totalPages;
        document.getElementById('prevPage').disabled = currentPage <= 1;
        document.getElementById('nextPage').disabled = currentPage >= totalPages;
    }

    function updateTable(rows) {
        allRows = rows;
        filteredRows = [...rows];
        currentPage = 1;
        renderTable();
    }

    // 翻页
    function goToPage(direction) {
        const totalPages = Math.ceil(filteredRows.length / pageSize);
        if (direction === 'prev' && currentPage > 1) {
            currentPage--;
        } else if (direction === 'next' && currentPage < totalPages) {
            currentPage++;
        }
        renderTable();
    }

    // 改变每页显示数量
    function changePageSize() {
        pageSize = parseInt(document.getElementById('pageSize').value);
        currentPage = 1;
        renderTable();
    }

    // 行点击处理 - 显示客户详情
    function handleRowClick(event, customerId) {
        // 如果点击的是按钮或链接，不触发弹窗
        if (event.target.closest('button') || event.target.closest('a') || event.target.closest('.btn')) {
            return;
        }
        if (customerId) {
            showCustomerProfile(customerId);
        }
    }

    // 搜索和筛选
    const searchInput = document.getElementById('searchInput');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');

    function filterFormalCourses() {
        const search = searchInput.value.toLowerCase();
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;

        filteredRows = allRows.filter(r => {
            const name = (r.customer_name || '').toLowerCase();
            const date = (r.created_at || '').split('T')[0];

            const matchSearch = name.includes(search);
            let matchDate = true;
            if (startDate && date) matchDate = date >= startDate;
            if (endDate && date && matchDate) matchDate = date <= endDate;

            return matchSearch && matchDate;
        });
        currentPage = 1;
        renderTable();
    }

    searchInput.addEventListener('input', filterFormalCourses);
    startDateInput.addEventListener('change', filterFormalCourses);
    endDateInput.addEventListener('change', filterFormalCourses);

    // 导出
    function exportFormalData() {
        window.location.href = '/api/export/formal-courses';
    }

    // 批量操作
    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.course-checkbox');
        checkboxes.forEach(cb => cb.checked = selectAll.checked);
        updateBatchBtn();
    }

    function updateBatchBtn() {
        const checkboxes = document.querySelectorAll('.course-checkbox:checked');
        const btn = document.getElementById('batchDeleteBtn');
        btn.style.display = checkboxes.length > 0 ? 'inline-block' : 'none';
        btn.textContent = `批量删除 (${checkboxes.length})`;
    }

    function batchDelete() {
        const checkboxes = document.querySelectorAll('.course-checkbox:checked');
        if (checkboxes.length === 0) return;

        if (!confirm(`确定要删除选中的 ${checkboxes.length} 条记录吗？此操作不可恢复！`)) return;

        requireOperationPassword(async function () {
            let successCount = 0;
            const ids = Array.from(checkboxes).map(cb => cb.value);

            // 显示加载状态
            const btn = document.getElementById('batchDeleteBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '删除中...';

            try {
                for (const id of ids) {
                    const res = await fetch(`/api/formal-courses/${id}`, { method: 'DELETE' });
                    const data = await res.json();
                    if (data.success) successCount++;
                }
                alert(`删除成功：${successCount} 条，失败：${ids.length - successCount} 条`);
                location.reload();
            } catch (error) {
                alert('批量删除过程中发生错误');
                console.error(error);
                location.reload();
            }
        });
    }

    // 删除单条
    function deleteFormalCourse(id) {
        if (!confirm('确定要删除这条正课记录吗？')) return;
        requireOperationPassword(function () {
            fetch(`/api/formal-courses/${id}`, { method: 'DELETE' })
                .then(r => r.json())
                .then(data => { if (data.success) location.reload(); else alert(data.message || '删除失败'); });
        });
    }

    // 退费模态框
    function showRefundModal(id) {
        document.getElementById('refund_course_id').value = id;
        document.getElementById('refundModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
    function closeRefundModal() {
        document.getElementById('refundModal').style.display = 'none';
        document.body.style.overflow = 'auto';
        document.getElementById('refundForm').reset();
    }
    function submitRefund() {
        const id = document.getElementById('refund_course_id').value;
        const data = {
            refund_amount: parseFloat(document.getElementById('refund_amount').value) || 0,
            refund_fee: parseFloat(document.getElementById('refund_fee').value) || 0,
            used_sessions: parseInt(document.getElementById('refund_used_sessions').value) || 0,
            refund_channel: document.getElementById('refund_channel').value,
            refund_note: document.getElementById('refund_note').value
        };
        if (!data.refund_amount || !data.refund_channel) { alert('请填写退费金额和渠道'); return; }
        requireOperationPassword(function () {
            fetch(`/api/formal-courses/${id}/refund`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(r => r.json()).then(res => {
                if (res.success) { closeRefundModal(); location.reload(); }
                else alert(res.message || '退费失败');
            });
        });
    }

    window.onclick = (e) => { if (e.target.id === 'refundModal') closeRefundModal(); };
</script>
{% endblock %}