{% extends "base.html" %}
{% block title %}系统配置 - 英语培训管理系统{% endblock %}
{% block page_title %}系统配置{% endblock %}

{% block content %}
<div class="animate-in">
    <!-- 配置标签页 -->
    <div class="card mb-4">
        <div class="card-body" style="padding:8px;">
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button class="btn btn-primary tab-btn active" data-tab="cost"><i class="fas fa-cog"></i> 成本配置</button>
                <button class="btn btn-secondary tab-btn" data-tab="operational"><i class="fas fa-building"></i> 运营成本</button>
                <button class="btn btn-secondary tab-btn" data-tab="shareholder"><i class="fas fa-coins"></i> 股东配置</button>
                <button class="btn btn-secondary tab-btn" data-tab="employee"><i class="fas fa-users"></i> 员工管理</button>
                <button class="btn btn-secondary tab-btn" data-tab="security"><i class="fas fa-lock"></i> 安全设置</button>
                <button class="btn btn-secondary tab-btn" data-tab="backup"><i class="fas fa-database"></i> 数据备份</button>
            </div>
        </div>
    </div>

    <!-- 成本配置 -->
    <div class="tab-content" id="tab-cost">
        <div class="card">
            <div class="card-header"><h3><i class="fas fa-cog"></i> 成本配置</h3></div>
            <div class="card-body">
                <form action="{{ url_for('main.manage_config') }}" method="post">
                    <input type="hidden" name="config_type" value="basic">
                    <div class="form-row">
                        <div class="form-group">
                            <label>试听课成本 (¥)</label>
                            <input type="number" name="trial_cost" class="form-control" step="0.01" min="0" value="{{ config.trial_cost or 0 }}">
                        </div>
                        <div class="form-group">
                            <label>正课成本 (¥/节)</label>
                            <input type="number" name="course_cost" class="form-control" step="0.01" min="0" value="{{ config.course_cost or 0 }}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>淘宝手续费率 (%)</label>
                            <input type="number" name="taobao_fee_rate" class="form-control" step="0.001" min="0" max="100" value="{{ config.taobao_fee_rate or 0 }}">
                        </div>
                        <div class="form-group">
                            <label>刷单商品列表</label>
                            <input type="text" name="shuadan_products" class="form-control" placeholder="多个商品用逗号分隔" value="{{ config.shuadan_products or '' }}">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> 保存配置</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 运营成本 -->
    <div class="tab-content" id="tab-operational" style="display:none;">
        <div class="card">
            <div class="card-header"><h3><i class="fas fa-building"></i> 运营成本</h3></div>
            <div class="card-body">
                <form action="{{ url_for('main.manage_config') }}" method="post">
                    <input type="hidden" name="config_type" value="operational_cost">
                    <div class="form-row">
                        <div class="form-group">
                            <label>成本类型 *</label>
                            <select name="cost_type" class="form-control" required>
                                <option value="rent">租金</option>
                                <option value="utilities">水电费</option>
                                <option value="salary">工资</option>
                                <option value="marketing">营销费用</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>成本名称 *</label>
                            <input type="text" name="cost_name" class="form-control" required placeholder="如：办公室租金">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>金额 (¥) *</label>
                            <input type="number" name="amount" class="form-control" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>日期 *</label>
                            <input type="date" name="cost_date" class="form-control" required value="{{ today }}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>计费周期</label>
                            <select name="billing_period" class="form-control">
                                <option value="month">月度</option>
                                <option value="quarter">季度</option>
                                <option value="year">年度</option>
                                <option value="once">一次性</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>备注</label>
                            <input type="text" name="description" class="form-control" placeholder="可选备注">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> 添加运营成本</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 股东配置 -->
    <div class="tab-content" id="tab-shareholder" style="display:none;">
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-coins"></i> 股东配置</h3>
            </div>
            <div class="card-body">
                <form action="{{ url_for('main.manage_config') }}" method="post">
                    <input type="hidden" name="config_type" value="profit_distribution">
                    <div class="form-row">
                        <div class="form-group">
                            <label>股东A姓名</label>
                            <input type="text" name="shareholder_a_name" class="form-control" value="{{ config.shareholder_a_name or '股东A' }}">
                        </div>
                        <div class="form-group">
                            <label>股东A股份比例 (%)</label>
                            <input type="number" name="shareholder_a_ratio" class="form-control" step="0.1" min="0" max="100" value="{{ config.shareholder_a_ratio or 50 }}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>股东B姓名</label>
                            <input type="text" name="shareholder_b_name" class="form-control" value="{{ config.shareholder_b_name or '股东B' }}">
                        </div>
                        <div class="form-group">
                            <label>股东B股份比例 (%)</label>
                            <input type="number" class="form-control" step="0.1" min="0" max="100" value="{{ config.shareholder_b_ratio or 50 }}" disabled>
                            <small class="form-help">自动计算：100% - 股东A比例</small>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> 保存股东配置</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 员工管理 -->
    <div class="tab-content" id="tab-employee" style="display:none;">
        <div class="card">
            <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
                <h3><i class="fas fa-users"></i> 员工管理</h3>
                <button class="btn btn-primary btn-sm" onclick="showAddEmployeeModal()"><i class="fas fa-plus"></i> 添加员工</button>
            </div>
            <div class="card-body">
                <table class="modern-table">
                    <thead><tr><th>员工姓名</th><th>月薪</th><th>操作</th></tr></thead>
                    <tbody id="employeeList">
                        {% for emp in employees %}
                        <tr>
                            <td><div class="user-info-cell"><div class="user-avatar">{{ emp.name[0] }}</div><span>{{ emp.name }}</span></div></td>
                            <td>¥{{ "%.2f"|format(emp.salary or 0) }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="editEmployee({{ emp.id }}, '{{ emp.name }}', {{ emp.salary or 0 }})"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteEmployee({{ emp.id }})"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="3" class="text-center text-muted">暂无员工</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 安全设置 -->
    <div class="tab-content" id="tab-security" style="display:none;">
        <div class="card">
            <div class="card-header"><h3><i class="fas fa-lock"></i> 安全设置</h3></div>
            <div class="card-body">
                <div class="info-card mb-4">
                    <div class="info-icon"><i class="fas fa-shield-alt"></i></div>
                    <div class="info-content">
                        <h4>操作密码说明</h4>
                        <p>设置操作密码后，执行删除、修改等敏感操作时需要输入密码验证，防止误操作。</p>
                    </div>
                </div>
                
                <div id="passwordStatus"></div>
                
                <!-- 设置/修改密码表单 -->
                <form id="operationPasswordForm">
                    <div id="oldPasswordGroup" class="form-group" style="display:none;">
                        <label>原密码 *</label>
                        <input type="password" id="old_operation_password" class="form-control" placeholder="请输入原密码">
                    </div>
                    <div class="form-group">
                        <label id="newPasswordLabel">设置操作密码 *</label>
                        <input type="password" id="new_operation_password" class="form-control" placeholder="请输入新密码" required>
                    </div>
                    <div class="form-group">
                        <label>确认密码 *</label>
                        <input type="password" id="confirm_operation_password" class="form-control" placeholder="请再次输入密码" required>
                    </div>
                    <button type="submit" class="btn btn-success" id="savePasswordBtn"><i class="fas fa-save"></i> 设置密码</button>
                    <button type="button" class="btn btn-danger" id="clearPasswordBtn" style="display:none;margin-left:10px;" onclick="clearOperationPassword()"><i class="fas fa-trash"></i> 清除密码</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 数据备份 -->
    <div class="tab-content" id="tab-backup" style="display:none;">
        <div class="card">
            <div class="card-header"><h3><i class="fas fa-database"></i> 数据备份与恢复</h3></div>
            <div class="card-body">
                <div class="info-card mb-4">
                    <div class="info-icon"><i class="fas fa-info-circle"></i></div>
                    <div class="info-content">
                        <h4>数据迁移说明</h4>
                        <p>换电脑时，下载数据库文件保存好，在新电脑上恢复即可。建议定期备份数据。</p>
                    </div>
                </div>
                
                <!-- 备份数据 -->
                <div style="margin-bottom:30px;">
                    <h4 style="margin-bottom:15px;color:#333;"><i class="fas fa-download" style="color:#28a745;"></i> 备份数据</h4>
                    <p style="color:#666;margin-bottom:15px;">点击下方按钮下载数据库文件，保存到安全的位置。</p>
                    <button class="btn btn-success" onclick="downloadDatabase()">
                        <i class="fas fa-download"></i> 下载数据库文件
                    </button>
                </div>
                
                <hr style="margin:30px 0;">
                
                <!-- 恢复数据 -->
                <div>
                    <h4 style="margin-bottom:15px;color:#333;"><i class="fas fa-upload" style="color:#f0ad4e;"></i> 恢复数据</h4>
                    <div class="alert alert-warning" style="margin-bottom:15px;">
                        <i class="fas fa-exclamation-triangle"></i> 
                        <strong>警告：</strong>恢复数据会覆盖当前所有数据，此操作不可撤销！
                    </div>
                    <div class="form-group">
                        <label>选择数据库文件 (.sqlite)</label>
                        <input type="file" id="restoreFile" class="form-control" accept=".sqlite,.db">
                    </div>
                    <button class="btn btn-warning" onclick="restoreDatabase()">
                        <i class="fas fa-upload"></i> 恢复数据库
                    </button>
                </div>
                
                <hr style="margin:30px 0;">
                
                <!-- 数据库信息 -->
                <div>
                    <h4 style="margin-bottom:15px;color:#333;"><i class="fas fa-info-circle" style="color:#17a2b8;"></i> 数据库信息</h4>
                    <div id="dbInfo" style="background:#f8f9fa;padding:15px;border-radius:8px;">
                        <p><strong>文件位置：</strong><code>instance/database.sqlite</code></p>
                        <p id="dbSize"><strong>文件大小：</strong>加载中...</p>
                        <p id="dbStats"><strong>数据统计：</strong>加载中...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加员工模态框 -->
<div id="addEmployeeModal" class="modal">
    <div class="modal-content" style="max-width:400px;">
        <div class="modal-header"><h4>添加员工</h4><span class="close" onclick="closeEmployeeModal()">&times;</span></div>
        <form id="addEmployeeForm">
            <div class="modal-body">
                <div class="form-group"><label>员工姓名 *</label><input type="text" id="emp_name" class="form-control" required></div>
                <div class="form-group"><label>月薪</label><input type="number" id="emp_salary" class="form-control" step="0.01" min="0" value="0"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEmployeeModal()">取消</button>
                <button type="submit" class="btn btn-primary">保存</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 标签页切换
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('btn-primary'); b.classList.add('btn-secondary'); });
        this.classList.remove('btn-secondary'); this.classList.add('btn-primary');
        document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
        document.getElementById('tab-' + this.dataset.tab).style.display = 'block';
    });
});

// 员工管理
function showAddEmployeeModal() { document.getElementById('addEmployeeModal').style.display = 'flex'; }
function closeEmployeeModal() { document.getElementById('addEmployeeModal').style.display = 'none'; document.getElementById('addEmployeeForm').reset(); }
document.getElementById('addEmployeeForm').onsubmit = function(e) {
    e.preventDefault();
    const name = document.getElementById('emp_name').value.trim();
    const salary = parseFloat(document.getElementById('emp_salary').value) || 0;
    if (!name) return;
    fetch('/api/employees', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, salary }) })
        .then(r => r.json()).then(d => { if (d.success) location.reload(); else alert(d.message || '添加失败'); });
};
function editEmployee(id, name, salary) {
    const newName = prompt('员工姓名:', name);
    if (!newName) return;
    const newSalary = prompt('月薪:', salary);
    if (newSalary === null) return;
    requireOperationPassword(function() {
        fetch(`/api/employees/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: newName, salary: parseFloat(newSalary) || 0 }) })
            .then(r => r.json()).then(d => { if (d.success) location.reload(); else alert(d.message || '保存失败'); });
    });
}
function deleteEmployee(id) {
    if (!confirm('确定删除？')) return;
    requireOperationPassword(function() {
        fetch(`/api/employees/${id}`, { method: 'DELETE' }).then(r => r.json()).then(d => { if (d.success) location.reload(); else alert(d.message || '删除失败'); });
    });
}

// 操作密码管理
let hasOperationPassword = false;

// 检查是否已设置操作密码
function checkPasswordStatus() {
    fetch('/api/operation-password/status')
        .then(r => r.json())
        .then(data => {
            hasOperationPassword = data.has_password;
            updatePasswordUI();
        });
}

function updatePasswordUI() {
    const statusDiv = document.getElementById('passwordStatus');
    const oldPwdGroup = document.getElementById('oldPasswordGroup');
    const newPwdLabel = document.getElementById('newPasswordLabel');
    const saveBtn = document.getElementById('savePasswordBtn');
    const clearBtn = document.getElementById('clearPasswordBtn');
    
    if (hasOperationPassword) {
        statusDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> 已设置操作密码</div>';
        oldPwdGroup.style.display = 'block';
        document.getElementById('old_operation_password').required = true;
        newPwdLabel.textContent = '新密码 *';
        saveBtn.innerHTML = '<i class="fas fa-save"></i> 修改密码';
        clearBtn.style.display = 'inline-block';
    } else {
        statusDiv.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> 未设置操作密码，建议设置以保护数据安全</div>';
        oldPwdGroup.style.display = 'none';
        document.getElementById('old_operation_password').required = false;
        newPwdLabel.textContent = '设置操作密码 *';
        saveBtn.innerHTML = '<i class="fas fa-save"></i> 设置密码';
        clearBtn.style.display = 'none';
    }
}

// 设置/修改操作密码
document.getElementById('operationPasswordForm').onsubmit = function(e) {
    e.preventDefault();
    const oldPwd = document.getElementById('old_operation_password').value;
    const newPwd = document.getElementById('new_operation_password').value;
    const confirmPwd = document.getElementById('confirm_operation_password').value;
    
    if (newPwd !== confirmPwd) {
        alert('两次输入的密码不一致');
        return;
    }
    if (newPwd.length < 4) {
        alert('密码长度至少4位');
        return;
    }
    
    const data = { new_password: newPwd };
    if (hasOperationPassword) {
        data.old_password = oldPwd;
    }
    
    fetch('/api/operation-password/set', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(d => {
        if (d.success) {
            alert('密码设置成功');
            document.getElementById('operationPasswordForm').reset();
            checkPasswordStatus();
        } else {
            alert(d.message || '设置失败');
        }
    });
};

// 清除操作密码
function clearOperationPassword() {
    const oldPwd = prompt('请输入当前操作密码以确认清除：');
    if (!oldPwd) return;
    
    fetch('/api/operation-password/clear', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ old_password: oldPwd })
    })
    .then(r => r.json())
    .then(d => {
        if (d.success) {
            alert('操作密码已清除');
            checkPasswordStatus();
        } else {
            alert(d.message || '清除失败');
        }
    });
}

// 页面加载时检查密码状态
document.addEventListener('DOMContentLoaded', function() {
    checkPasswordStatus();
    loadDbInfo();
});

// 数据库备份功能
function downloadDatabase() {
    window.location.href = '/api/database/download';
}

function restoreDatabase() {
    const fileInput = document.getElementById('restoreFile');
    if (!fileInput.files || !fileInput.files[0]) {
        alert('请先选择数据库文件');
        return;
    }
    
    const file = fileInput.files[0];
    if (!file.name.endsWith('.sqlite') && !file.name.endsWith('.db')) {
        alert('请选择 .sqlite 或 .db 格式的数据库文件');
        return;
    }
    
    if (!confirm('警告：恢复数据会覆盖当前所有数据，此操作不可撤销！\n\n确定要继续吗？')) {
        return;
    }
    
    // 需要操作密码验证
    requireOperationPassword(function() {
        const formData = new FormData();
        formData.append('file', file);
        
        fetch('/api/database/restore', {
            method: 'POST',
            body: formData
        })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                alert('数据库恢复成功！页面将刷新。');
                location.reload();
            } else {
                alert(d.message || '恢复失败');
            }
        })
        .catch(() => alert('恢复失败，请重试'));
    });
}

function loadDbInfo() {
    fetch('/api/database/info')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                document.getElementById('dbSize').innerHTML = `<strong>文件大小：</strong>${data.size}`;
                document.getElementById('dbStats').innerHTML = `<strong>数据统计：</strong>试听课 ${data.trial_count} 条，正课 ${data.formal_count} 条，客户 ${data.customer_count} 人`;
            }
        })
        .catch(() => {});
}

window.onclick = function(e) {
    if (e.target.id === 'addEmployeeModal') closeEmployeeModal();
};
</script>
{% endblock %}
