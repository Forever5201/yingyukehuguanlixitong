{% extends "base.html" %}

{% block title %}系统配置{% endblock %}
{% block page_title %}系统配置{% endblock %}

{% block content %}
<div class="config-page">
    <div class="config-card">
        <div class="config-header">
            <h2><i class="fas fa-cog"></i> 成本配置</h2>
            <p class="config-description">设置试听课和正课的成本价格</p>
        </div>
        
        <form action="{{ url_for('main.manage_config') }}" method="post" class="config-form">
            <div class="form-section">
                <div class="form-group">
                    <label for="trial_cost">
                        <i class="fas fa-headphones"></i>
                        试听课成本 (¥)
                    </label>
                    <div class="input-group">
                        <span class="input-prefix">¥</span>
                        <input type="number" 
                               id="trial_cost" 
                               name="trial_cost" 
                               value="{{ config.trial_cost or 0 }}" 
                               step="0.01" 
                               min="0"
                               class="form-control"
                               placeholder="0.00">
                    </div>
                    <small class="form-help">试听课的单个客户成本</small>
                </div>
                
                <div class="form-group">
                    <label for="course_cost">
                        <i class="fas fa-graduation-cap"></i>
                        正课成本 (¥)
                    </label>
                    <div class="input-group">
                        <span class="input-prefix">¥</span>
                        <input type="number" 
                               id="course_cost" 
                               name="course_cost" 
                               value="{{ config.course_cost or 0 }}" 
                               step="0.01" 
                               min="0"
                               class="form-control"
                               placeholder="0.00">
                    </div>
                    <small class="form-help">正课的单个客户成本</small>
                </div>
                
                <div class="form-group">
                    <label for="taobao_fee_rate">
                        <i class="fas fa-percentage"></i>
                        淘宝交易手续费率 (%)
                    </label>
                    <div class="input-group">
                        <input type="number" 
                               id="taobao_fee_rate" 
                               name="taobao_fee_rate" 
                               value="{{ config.taobao_fee_rate or 0 }}" 
                               step="0.1" 
                               min="0"
                               max="100"
                               class="form-control"
                               placeholder="0.0">
                        <span class="input-suffix">%</span>
                    </div>
                    <small class="form-help">淘宝交易时的手续费率</small>
                </div>

                <div class="form-group">
                    <label for="shuadan_products">
                        <i class="fas fa-box"></i>
                        刷单商品列表
                    </label>
                    <textarea id="shuadan_products" name="shuadan_products" rows="3" class="form-control"
                              placeholder='例如：["课程A","课程B"] 或 课程A,课程B'>{{ config.shuadan_products }}</textarea>
                    <small class="form-help">支持 JSON 数组或逗号分隔的商品名称；用于“刷单管理”的商品选择与筛选</small>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-save"></i>
                    保存配置
                </button>
                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                    <i class="fas fa-undo"></i>
                    重置
                </button>
            </div>
        </form>
    </div>

    <div class="config-summary">
        <div class="summary-card">
            <h3><i class="fas fa-chart-bar"></i> 成本概览</h3>
            <div class="summary-item">
                <span class="summary-label">试听课成本</span>
                <span class="summary-value" id="summary_trial_cost">¥{{ config.trial_cost or 0 }}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">正课成本</span>
                <span class="summary-value" id="summary_course_cost">¥{{ config.course_cost or 0 }}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">淘宝手续费率</span>
                <span class="summary-value" id="summary_taobao_fee">{{ config.taobao_fee_rate or 0 }}%</span>
            </div>
            <div class="summary-item total">
                <span class="summary-label">总成本</span>
                <span class="summary-value" id="summary_total">¥{{ ((config.trial_cost or 0) + (config.course_cost or 0)) }}</span>
            </div>
        </div>
    </div>
</div>

<script>
function resetForm() {
    document.querySelector('.config-form').reset();
    // 重置后同步更新概览
    if (typeof updateSummary === 'function') {
        updateSummary();
    }
}

// 实时更新概览
function updateSummary() {
    const trialCost = parseFloat(document.getElementById('trial_cost').value) || 0;
    const courseCost = parseFloat(document.getElementById('course_cost').value) || 0;
    const taobaoFeeRate = parseFloat(document.getElementById('taobao_fee_rate').value) || 0;
    const total = trialCost + courseCost;
    
    const elTrial = document.getElementById('summary_trial_cost');
    const elCourse = document.getElementById('summary_course_cost');
    const elFee = document.getElementById('summary_taobao_fee');
    const elTotal = document.getElementById('summary_total');

    if (elTrial) elTrial.textContent = `¥${trialCost}`;
    if (elCourse) elCourse.textContent = `¥${courseCost}`;
    if (elFee) elFee.textContent = `${taobaoFeeRate}%`;
    if (elTotal) elTotal.textContent = `¥${total}`;
}

// 添加输入事件监听
document.getElementById('trial_cost')?.addEventListener('input', updateSummary);
document.getElementById('course_cost')?.addEventListener('input', updateSummary);
document.getElementById('taobao_fee_rate')?.addEventListener('input', updateSummary);
// 页面加载后先刷新一次概览，确保与初始表单值一致
window.addEventListener('DOMContentLoaded', () => {
    updateSummary();
});

// 更新股东B的比例
function updateShareholderB(type) {
    const shareholderA = parseFloat(document.getElementById(`${type}_shareholder_a`).value) || 0;
    const shareholderB = 100 - shareholderA;
    document.getElementById(`${type}_shareholder_b`).value = shareholderB.toFixed(1);
}
</script>

    <!-- 股东利润分配配置 -->
    <div class="config-card">
        <div class="config-header">
            <h2><i class="fas fa-coins"></i> 股东利润分配配置</h2>
            <p class="config-description">设置股东信息和利润分配比例</p>
        </div>
        
        <form action="{{ url_for('main.manage_config') }}" method="post" class="config-form">
            <input type="hidden" name="config_type" value="profit_distribution">
            
            <div class="form-section">
                <!-- 股东信息 -->
                <h3><i class="fas fa-users"></i> 股东信息</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="shareholder_a_name">
                            <i class="fas fa-user"></i>
                            股东A名称
                        </label>
                        <input type="text" 
                               id="shareholder_a_name" 
                               name="shareholder_a_name" 
                               value="{{ config.shareholder_a_name or '股东A' }}" 
                               class="form-control"
                               placeholder="请输入股东A名称">
                    </div>
                    
                    <div class="form-group">
                        <label for="shareholder_b_name">
                            <i class="fas fa-user"></i>
                            股东B名称
                        </label>
                        <input type="text" 
                               id="shareholder_b_name" 
                               name="shareholder_b_name" 
                               value="{{ config.shareholder_b_name or '股东B' }}" 
                               class="form-control"
                               placeholder="请输入股东B名称">
                    </div>
                </div>

                <!-- 正课利润分配 -->
                <h3><i class="fas fa-graduation-cap"></i> 正课利润分配</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="new_course_shareholder_a" class="shareholder-a-label">
                            <span class="shareholder-a-name">{{ config.shareholder_a_name or '股东A' }}</span>分配比例 (%)
                        </label>
                        <div class="input-group">
                            <input type="number" 
                                   id="new_course_shareholder_a" 
                                   name="new_course_shareholder_a" 
                                   value="{{ config.new_course_shareholder_a or 50 }}" 
                                   step="0.1" 
                                   min="0"
                                   max="100"
                                   class="form-control"
                                   oninput="updateShareholderB('new_course')">
                            <span class="input-suffix">%</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="new_course_shareholder_b" class="shareholder-b-label">
                            <span class="shareholder-b-name">{{ config.shareholder_b_name or '股东B' }}</span>分配比例 (%)
                        </label>
                        <div class="input-group">
                            <input type="number" 
                                   id="new_course_shareholder_b" 
                                   name="new_course_shareholder_b" 
                                   value="{{ config.new_course_shareholder_b or 50 }}" 
                                   class="form-control"
                                   readonly
                                   style="background: #e9ecef;">
                            <span class="input-suffix">%</span>
                        </div>
                    </div>
                </div>

                <!-- 续课利润分配 -->
                <h3><i class="fas fa-redo"></i> 续课利润分配</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="renewal_shareholder_a" class="shareholder-a-label">
                            <span class="shareholder-a-name">{{ config.shareholder_a_name or '股东A' }}</span>分配比例 (%)
                        </label>
                        <div class="input-group">
                            <input type="number" 
                                   id="renewal_shareholder_a" 
                                   name="renewal_shareholder_a" 
                                   value="{{ config.renewal_shareholder_a or 40 }}" 
                                   step="0.1" 
                                   min="0"
                                   max="100"
                                   class="form-control"
                                   oninput="updateShareholderB('renewal')">
                            <span class="input-suffix">%</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="renewal_shareholder_b" class="shareholder-b-label">
                            <span class="shareholder-b-name">{{ config.shareholder_b_name or '股东B' }}</span>分配比例 (%)
                        </label>
                        <div class="input-group">
                            <input type="number" 
                                   id="renewal_shareholder_b" 
                                   name="renewal_shareholder_b" 
                                   value="{{ config.renewal_shareholder_b or 60 }}" 
                                   class="form-control"
                                   readonly
                                   style="background: #e9ecef;">
                            <span class="input-suffix">%</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> 保存股东配置
                </button>
                <a href="{{ url_for('main.profit_distribution') }}" class="btn btn-secondary" style="margin-left: 10px;">
                    <i class="fas fa-chart-bar"></i> 查看利润分配报表
                </a>
            </div>
        </form>
    </div>
</div>

<script>
// 监听股东名称变化，实时更新标签
document.getElementById('shareholder_a_name')?.addEventListener('input', function() {
    const name = this.value || '股东A';
    document.querySelectorAll('.shareholder-a-name').forEach(el => {
        el.textContent = name;
    });
});

document.getElementById('shareholder_b_name')?.addEventListener('input', function() {
    const name = this.value || '股东B';
    document.querySelectorAll('.shareholder-b-name').forEach(el => {
        el.textContent = name;
    });
});
</script>

{% endblock %}