<!-- 学员详情模态框组件 -->
<div id="customerDetailModal" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-circle"></i> 学员详情
                </h5>
                <button type="button" class="close" onclick="closeCustomerDetailModal()" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="customerDetailForm">
                    <input type="hidden" id="detail_customer_id" name="customer_id">
                    <input type="hidden" id="detail_course_id" name="course_id">
                    
                    <!-- 学员基本信息 -->
                    <div class="section-card">
                        <h6 class="section-title">
                            <i class="fas fa-info-circle"></i> 基本信息
                        </h6>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label>姓名 <span class="required">*</span></label>
                                <input type="text" class="form-control" id="detail_name" name="name" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label>电话 <span class="required">*</span></label>
                                <input type="text" class="form-control" id="detail_phone" name="phone" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-4">
                                <label>性别</label>
                                <select class="form-control" id="detail_gender" name="gender">
                                    <option value="">请选择</option>
                                    <option value="男">男</option>
                                    <option value="女">女</option>
                                </select>
                            </div>
                            <div class="form-group col-md-4">
                                <label>年级</label>
                                <input type="text" class="form-control" id="detail_grade" name="grade">
                            </div>
                            <div class="form-group col-md-4">
                                <label>地区</label>
                                <input type="text" class="form-control" id="detail_region" name="region">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label>渠道来源</label>
                                <select class="form-control" id="detail_source" name="source">
                                    <option value="">请选择</option>
                                    <option value="淘宝">淘宝</option>
                                    <option value="视频号">视频号</option>
                                    <option value="抖音">抖音</option>
                                    <option value="小红书">小红书</option>
                                    <option value="其他">其他</option>
                                </select>
                            </div>
                            <div class="form-group col-md-6">
                                <label>是否参加过英语课外辅导</label>
                                <select class="form-control" id="detail_tutoring_exp" name="has_tutoring_experience">
                                    <option value="">请选择</option>
                                    <option value="是">是</option>
                                    <option value="否">否</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 试听课信息（如果有） -->
                    <div id="trialCourseSection" class="section-card" style="display: none;">
                        <h6 class="section-title">
                            <i class="fas fa-headphones"></i> 试听课信息
                        </h6>
                        <div class="form-row">
                            <div class="form-group col-md-4">
                                <label>试听价格</label>
                                <input type="number" class="form-control" id="detail_trial_price" name="trial_price" step="0.01">
                            </div>
                            <div class="form-group col-md-4">
                                <label>试听状态</label>
                                <select class="form-control" id="detail_trial_status" name="trial_status">
                                    <option value="registered">已报名</option>
                                    <option value="attended">已试听</option>
                                    <option value="converted">已转化</option>
                                    <option value="cancelled">已取消</option>
                                    <option value="refunded">已退费</option>
                                </select>
                            </div>
                            <div class="form-group col-md-4">
                                <label>试听课成本</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="detail_trial_cost" 
                                           name="trial_cost" step="0.01" 
                                           placeholder="留空使用系统默认">
                                    <div class="input-group-append">
                                        <span class="input-group-text" id="default_trial_cost_hint">
                                            默认: ¥<span id="system_trial_cost">0</span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-row" id="refundSection" style="display: none;">
                            <div class="form-group col-md-4">
                                <label>退费金额</label>
                                <input type="number" class="form-control" id="detail_refund_amount" name="refund_amount" step="0.01">
                            </div>
                            <div class="form-group col-md-4">
                                <label>退费手续费</label>
                                <input type="number" class="form-control" id="detail_refund_fee" name="refund_fee" step="0.01">
                            </div>
                            <div class="form-group col-md-4">
                                <label>退款渠道</label>
                                <select class="form-control" id="detail_refund_channel" name="refund_channel">
                                    <option value="">请选择</option>
                                    <option value="微信">微信</option>
                                    <option value="淘宝">淘宝</option>
                                    <option value="支付宝">支付宝</option>
                                    <option value="其他">其他</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 正课信息（如果有） -->
                    <div id="formalCourseSection" class="section-card" style="display: none;">
                        <h6 class="section-title">
                            <i class="fas fa-graduation-cap"></i> 正课信息
                        </h6>
                        <div class="form-row">
                            <div class="form-group col-md-4">
                                <label>课程类型</label>
                                <select class="form-control" id="detail_course_type" name="course_type">
                                    <option value="">请选择</option>
                                    <option value="单词课">单词课</option>
                                    <option value="语法课">语法课</option>
                                    <option value="阅读课">阅读课</option>
                                    <option value="拼读课">拼读课</option>
                                </select>
                            </div>
                            <div class="form-group col-md-4">
                                <label>购买节数</label>
                                <input type="number" class="form-control" id="detail_sessions" name="sessions" min="1">
                            </div>
                            <div class="form-group col-md-4">
                                <label>赠课节数</label>
                                <input type="number" class="form-control" id="detail_gift_sessions" name="gift_sessions" min="0">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-4">
                                <label>单节售价</label>
                                <input type="number" class="form-control" id="detail_price" name="price" step="0.01">
                            </div>
                            <div class="form-group col-md-4">
                                <label>支付渠道</label>
                                <select class="form-control" id="detail_payment_channel" name="payment_channel">
                                    <option value="">请选择</option>
                                    <option value="淘宝">淘宝</option>
                                    <option value="微信">微信</option>
                                    <option value="支付宝">支付宝</option>
                                    <option value="现金">现金</option>
                                    <option value="银行转账">银行转账</option>
                                </select>
                            </div>
                            <div class="form-group col-md-4">
                                <label>其他成本</label>
                                <input type="number" class="form-control" id="detail_other_cost" name="other_cost" step="0.01">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label>正课单节成本</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="detail_course_cost" 
                                           name="course_cost_per_session" step="0.01" 
                                           placeholder="留空使用系统默认">
                                    <div class="input-group-append">
                                        <span class="input-group-text" id="default_course_cost_hint">
                                            默认: ¥<span id="system_course_cost">0</span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 退课信息模块 -->
                    <div id="refundInfoSection" class="section-card" style="display: none; border-left: 4px solid #dc3545;">
                        <h6 class="section-title" style="color: #dc3545;">
                            <i class="fas fa-undo-alt"></i> 退课信息
                        </h6>
                        
                        <!-- 退课统计信息 -->
                        <div class="form-row">
                            <div class="form-group col-md-3">
                                <label>已退费节数</label>
                                <input type="number" class="form-control" id="refunded_sessions" readonly style="background-color: #f8f9fa;">
                            </div>
                            <div class="form-group col-md-3">
                                <label>实际退款金额</label>
                                <input type="number" class="form-control" id="refunded_amount" readonly style="background-color: #f8f9fa;">
                            </div>
                            <div class="form-group col-md-3">
                                <label>可退费节数</label>
                                <input type="number" class="form-control" id="refundable_sessions" readonly style="color: #dc3545; font-weight: bold; background-color: #fff3cd;">
                            </div>
                            <div class="form-group col-md-3">
                                <label>单节价格</label>
                                <input type="number" class="form-control" id="refund_unit_price" readonly style="background-color: #f8f9fa;">
                            </div>
                        </div>
                        
                        <!-- 退费记录 -->
                        <div id="refundHistorySection" style="display: none;">
                            <h6 class="section-title" style="margin-top: 20px; margin-bottom: 15px; color: #6c757d;">
                                <i class="fas fa-history"></i> 退费记录明细
                            </h6>
                            <div id="refundHistoryList">
                                <!-- 退费记录将在这里动态显示 -->
                            </div>
                        </div>
                    </div>

                    <!-- 利润预览（如果是正课） -->
                    <div id="profitPreviewSection" class="section-card" style="display: none;">
                        <h6 class="section-title">
                            <i class="fas fa-calculator"></i> 利润预览
                        </h6>
                        <div id="profitPreviewContent"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeCustomerDetailModal()">
                    <i class="fas fa-times"></i> 取消
                </button>
                <button type="button" class="btn btn-primary" onclick="saveCustomerDetail()">
                    <i class="fas fa-save"></i> 保存
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.section-card {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.section-title {
    margin: 0 0 15px 0;
    color: #495057;
    font-weight: 600;
    padding-bottom: 10px;
    border-bottom: 2px solid #dee2e6;
}

.required {
    color: #dc3545;
}

.input-group-text {
    font-size: 0.875rem;
    background: #e9ecef;
}

#profitPreviewContent {
    background: white;
    padding: 15px;
    border-radius: 5px;
    border: 1px solid #dee2e6;
}

.profit-positive {
    color: #28a745;
}

.profit-negative {
    color: #dc3545;
}
</style>

<script>
let currentDetailData = {};
let systemConfigs = {
    trial_cost: 0,
    course_cost: 0,
    taobao_fee_rate: 0.006
};

// 初始化获取系统配置
function loadSystemConfigs() {
    // 获取试听课成本
    fetch('/api/config/trial_cost')
        .then(response => response.json())
        .then(data => {
            systemConfigs.trial_cost = parseFloat(data.value) || 0;
            document.getElementById('system_trial_cost').textContent = systemConfigs.trial_cost.toFixed(2);
        });
    
    // 获取正课成本
    fetch('/api/config/course_cost')
        .then(response => response.json())
        .then(data => {
            systemConfigs.course_cost = parseFloat(data.value) || 0;
            document.getElementById('system_course_cost').textContent = systemConfigs.course_cost.toFixed(2);
        });
    
    // 获取淘宝手续费率
    fetch('/api/config/taobao_fee_rate')
        .then(response => response.json())
        .then(data => {
            systemConfigs.taobao_fee_rate = (parseFloat(data.value) || 0.6) / 100;
        });
}

// 关闭学员详情模态框
function closeCustomerDetailModal() {
    const modal = document.getElementById('customerDetailModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// 显示学员详情模态框
function showCustomerDetail(customerId, courseId = null, courseType = null) {
    // 重置表单
    document.getElementById('customerDetailForm').reset();
    currentDetailData = { customerId, courseId, courseType };
    
    // 根据类型显示不同的区块
    document.getElementById('trialCourseSection').style.display = 'none';
    document.getElementById('formalCourseSection').style.display = 'none';
    document.getElementById('profitPreviewSection').style.display = 'none';
    document.getElementById('refundSection').style.display = 'none';
    document.getElementById('refundInfoSection').style.display = 'none'; // 隐藏退课信息模块
    
    // 加载数据
    if (courseType === 'trial' && courseId) {
        loadTrialCourseDetail(courseId);
    } else if (courseType === 'formal' && courseId) {
        loadFormalCourseDetail(courseId);
    } else {
        loadCustomerDetail(customerId);
    }
    
    // 显示模态框
    const modal = document.getElementById('customerDetailModal');
    if (modal) {
        modal.style.display = 'flex';
    }
}

// 加载试听课详情
function loadTrialCourseDetail(courseId) {
    fetch(`/api/trial-courses/${courseId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 填充客户信息
                fillCustomerData(data.customer);
                
                // 填充试听课信息
                document.getElementById('detail_course_id').value = data.course.id;
                document.getElementById('detail_trial_price').value = data.course.trial_price;
                document.getElementById('detail_trial_status').value = data.course.trial_status;
                
                // 如果有自定义成本，显示它
                if (data.course.custom_trial_cost !== undefined && data.course.custom_trial_cost !== null) {
                    document.getElementById('detail_trial_cost').value = data.course.custom_trial_cost;
                }
                
                // 如果是退费状态，显示退费信息
                if (data.course.trial_status === 'refunded') {
                    document.getElementById('refundSection').style.display = 'flex';
                    document.getElementById('detail_refund_amount').value = data.course.refund_amount || 0;
                    document.getElementById('detail_refund_fee').value = data.course.refund_fee || 0;
                    document.getElementById('detail_refund_channel').value = data.course.refund_channel || '';
                }
                
                // 显示试听课区块
                document.getElementById('trialCourseSection').style.display = 'block';
                
                // 监听状态变化
                document.getElementById('detail_trial_status').onchange = function() {
                    document.getElementById('refundSection').style.display = 
                        this.value === 'refunded' ? 'flex' : 'none';
                };
            }
        });
}

// 加载正课详情
function loadFormalCourseDetail(courseId) {
    fetch(`/api/formal-courses/${courseId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 填充客户信息
                fillCustomerData({
                    id: data.customer_id,
                    name: data.customer_name,
                    phone: data.customer_phone,
                    gender: data.customer_gender,
                    grade: data.customer_grade,
                    region: data.customer_region,
                    source: data.customer_source,
                    has_tutoring_experience: data.customer_has_tutoring_experience
                });
                
                // 填充正课信息
                document.getElementById('detail_course_id').value = data.id;
                document.getElementById('detail_course_type').value = data.course_type;
                document.getElementById('detail_sessions').value = data.sessions;
                document.getElementById('detail_gift_sessions').value = data.gift_sessions;
                document.getElementById('detail_price').value = data.price;
                document.getElementById('detail_payment_channel').value = data.payment_channel;
                document.getElementById('detail_other_cost').value = data.other_cost;
                
                // 如果有自定义成本，显示它
                if (data.custom_course_cost !== undefined && data.custom_course_cost !== null) {
                    document.getElementById('detail_course_cost').value = data.custom_course_cost;
                }
                
                // 显示正课区块和利润预览
                document.getElementById('formalCourseSection').style.display = 'block';
                document.getElementById('profitPreviewSection').style.display = 'block';
                
                // 监听变化以更新利润预览
                ['detail_sessions', 'detail_gift_sessions', 'detail_price', 
                 'detail_payment_channel', 'detail_other_cost', 'detail_course_cost'].forEach(id => {
                    document.getElementById(id).onchange = updateProfitPreview;
                    document.getElementById(id).oninput = updateProfitPreview;
                });
                
                // 监听退费信息变化以更新利润预览
                ['refunded_sessions', 'refunded_amount'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.onchange = updateProfitPreview;
                        element.oninput = updateProfitPreview;
                    }
                });
                
                // 获取退费信息 - 在退费信息加载完成后再更新利润预览
                loadRefundInfo(data.id);
                document.getElementById('refundInfoSection').style.display = 'block'; // 显示退课信息模块
            }
        });
}

// 加载客户详情
function loadCustomerDetail(customerId) {
    fetch(`/api/customers/${customerId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                fillCustomerData(data.customer);
            }
        });
}

// 填充客户数据
function fillCustomerData(customer) {
    document.getElementById('detail_customer_id').value = customer.id;
    document.getElementById('detail_name').value = customer.name || '';
    document.getElementById('detail_phone').value = customer.phone || '';
    document.getElementById('detail_gender').value = customer.gender || '';
    document.getElementById('detail_grade').value = customer.grade || '';
    document.getElementById('detail_region').value = customer.region || '';
    document.getElementById('detail_source').value = customer.source || '';
    document.getElementById('detail_tutoring_exp').value = customer.has_tutoring_experience || '';
}

// 加载退费信息
function loadRefundInfo(courseId) {
    fetch(`/api/courses/${courseId}/refund-info`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 更新退费统计信息
                document.getElementById('refunded_sessions').value = data.refund_summary.total_refunded_sessions;
                // 显示实际退款金额（扣除手续费后的金额）
                const actualRefundAmount = data.refund_summary.total_refunded_amount - data.refund_summary.total_refunded_fees;
                document.getElementById('refunded_amount').value = actualRefundAmount.toFixed(2);
                document.getElementById('refundable_sessions').value = data.refund_summary.refundable_sessions;
                document.getElementById('refund_unit_price').value = data.refund_summary.unit_price.toFixed(2);
                
                // 显示退费记录
                if (data.refund_history && data.refund_history.length > 0) {
                    const refundHistoryList = document.getElementById('refundHistoryList');
                    refundHistoryList.innerHTML = data.refund_history.map((refund, index) => `
                        <div class="section-card" style="margin-bottom: 15px; background: #fff; border: 1px solid #dee2e6; border-left: 3px solid #17a2b8;">
                            <div class="form-row">
                                <div class="form-group col-md-12">
                                    <h6 style="color: #17a2b8; margin-bottom: 15px; font-size: 0.9rem;">
                                        <i class="fas fa-file-invoice"></i> 退费记录 #${index + 1}
                                    </h6>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-3">
                                    <label style="font-size: 0.85rem; color: #6c757d;">退费时间</label>
                                    <input type="text" class="form-control form-control-sm" value="${refund.refund_date || '未记录'}" readonly style="background-color: #f8f9fa;">
                                </div>
                                <div class="form-group col-md-3">
                                    <label style="font-size: 0.85rem; color: #6c757d;">退费节数</label>
                                    <input type="number" class="form-control form-control-sm" id="rf_sessions_${refund.id}" value="${refund.refund_sessions}" min="1" step="1">
                                </div>
                                <div class="form-group col-md-3">
                                    <label style="font-size: 0.85rem; color: #6c757d;">实际退款</label>
                                    <input type="number" class="form-control form-control-sm" id="rf_amount_${refund.id}" value="${(refund.refund_amount - (refund.refund_fee || 0)).toFixed(2)}" min="0" step="0.01">
                                </div>
                                <div class="form-group col-md-3">
                                    <label style="font-size: 0.85rem; color: #6c757d;">手续费</label>
                                    <input type="number" class="form-control form-control-sm" id="rf_fee_${refund.id}" value="${(refund.refund_fee || 0).toFixed(2)}" min="0" step="0.01">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-4">
                                    <label style="font-size: 0.85rem; color: #6c757d;">退费原因</label>
                                    <select class="form-control form-control-sm" id="rf_reason_${refund.id}">
                                        <option value="">请选择</option>
                                        <option value="个人原因" ${refund.refund_reason === '个人原因' ? 'selected' : ''}>个人原因</option>
                                        <option value="时间冲突" ${refund.refund_reason === '时间冲突' ? 'selected' : ''}>时间冲突</option>
                                        <option value="教学质量" ${refund.refund_reason === '教学质量' ? 'selected' : ''}>教学质量问题</option>
                                        <option value="搬家" ${refund.refund_reason === '搬家' ? 'selected' : ''}>搬家/地址变更</option>
                                        <option value="经济原因" ${refund.refund_reason === '经济原因' ? 'selected' : ''}>经济原因</option>
                                        <option value="其他" ${refund.refund_reason === '其他' ? 'selected' : ''}>其他原因</option>
                                    </select>
                                </div>
                                <div class="form-group col-md-4">
                                    <label style="font-size: 0.85rem; color: #6c757d;">退费渠道</label>
                                    <select class="form-control form-control-sm" id="rf_channel_${refund.id}">
                                        <option value="">请选择</option>
                                        <option value="微信" ${refund.refund_channel === '微信' ? 'selected' : ''}>微信</option>
                                        <option value="淘宝" ${refund.refund_channel === '淘宝' ? 'selected' : ''}>淘宝</option>
                                        <option value="支付宝" ${refund.refund_channel === '支付宝' ? 'selected' : ''}>支付宝</option>
                                        <option value="其他" ${refund.refund_channel === '其他' ? 'selected' : ''}>其他</option>
                                    </select>
                                </div>
                                <div class="form-group col-md-4">
                                    <label style="font-size: 0.85rem; color: #6c757d;">操作人</label>
                                    <input type="text" class="form-control form-control-sm" value="${refund.operator_name || '未记录'}" readonly style="background-color: #f8f9fa;">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-12">
                                    <label style="font-size: 0.85rem; color: #6c757d;">备注</label>
                                    <textarea class="form-control form-control-sm" id="rf_remark_${refund.id}" rows="2" placeholder="请输入备注信息">${refund.remark || ''}</textarea>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-12">
                                    <button type="button" class="btn btn-sm btn-primary" onclick="saveRefundInModal(${refund.id})">
                                        <i class="fas fa-save"></i> 保存修改
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    document.getElementById('refundHistorySection').style.display = 'block';
                } else {
                    document.getElementById('refundHistorySection').style.display = 'none';
                }
                
                // 显示退课信息模块
                document.getElementById('refundInfoSection').style.display = 'block';
                
                // 更新利润预览，确保退费信息被正确计算
                updateProfitPreview();
            } else {
                console.error('获取退费信息失败:', data.message);
                // 设置默认值
                document.getElementById('refunded_sessions').value = '0';
                document.getElementById('refunded_amount').value = '0.00';
                document.getElementById('refundable_sessions').value = '0';
                document.getElementById('refund_unit_price').value = '0.00';
                document.getElementById('refundHistorySection').style.display = 'none';
                
                // 如果没有退费信息，也显示退课信息模块（显示为0）
                document.getElementById('refundInfoSection').style.display = 'block';
                
                // 更新利润预览，显示无退费的情况
                updateProfitPreview();
            }
        })
        .catch(error => {
            console.error('获取退费信息出错:', error);
            // 设置默认值
            document.getElementById('refunded_sessions').value = '0';
            document.getElementById('refunded_amount').value = '0.00';
            document.getElementById('refundable_sessions').value = '0';
            document.getElementById('refund_unit_price').value = '0.00';
            document.getElementById('refundHistorySection').style.display = 'none';
            
            // 即使出错也显示退课信息模块
            document.getElementById('refundInfoSection').style.display = 'block';
            
            // 更新利润预览，显示无退费的情况
            updateProfitPreview();
        });
}

// 更新利润预览
function updateProfitPreview() {
    const sessions = parseInt(document.getElementById('detail_sessions').value) || 0;
    const giftSessions = parseInt(document.getElementById('detail_gift_sessions').value) || 0;
    const price = parseFloat(document.getElementById('detail_price').value) || 0;
    const paymentChannel = document.getElementById('detail_payment_channel').value;
    const otherCost = parseFloat(document.getElementById('detail_other_cost').value) || 0;
    const customCourseCost = parseFloat(document.getElementById('detail_course_cost').value);
    const courseCostPerSession = isNaN(customCourseCost) ? systemConfigs.course_cost : customCourseCost;
    
    // 获取退费信息 - 从退课信息模块的统计字段读取
    const refundedSessions = parseInt(document.getElementById('refunded_sessions').value) || 0;
    const refundedAmount = parseFloat(document.getElementById('refunded_amount').value) || 0;
    
    if (sessions > 0 && price > 0) {
        const originalRevenue = sessions * price;
        const actualRevenue = originalRevenue - refundedAmount; // 扣除实际退费金额（已扣除手续费）
        const countedSessions = sessions - refundedSessions; // 计入收入的节数
        
        let feeAmount = 0;
        if (paymentChannel === '淘宝') {
            // 手续费基于原始收入计算（退费前）
            feeAmount = originalRevenue * systemConfigs.taobao_fee_rate;
        }
        
        // 课程成本基于实际消耗的节数计算（扣除退费后的节数）
        const actualSessions = sessions - refundedSessions; // 实际消耗的节数
        const actualGiftSessions = Math.max(0, giftSessions - refundedSessions); // 实际赠送节数（不能为负）
        const totalActualSessions = actualSessions + actualGiftSessions;
        const sessionCost = totalActualSessions * courseCostPerSession;
        
        const totalCost = sessionCost + otherCost + feeAmount;
        const netProfit = actualRevenue - totalCost;
        
        document.getElementById('profitPreviewContent').innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <strong>收入明细：</strong>
                    <div>原始收入：${sessions} 节 × ¥${price.toFixed(2)} = ¥${originalRevenue.toFixed(2)}</div>
                    <div>实际退款：¥${refundedAmount.toFixed(2)}</div>
                    <div>实际收入：¥${actualRevenue.toFixed(2)}</div>
                    <div>实际节数：${countedSessions} 节</div>
                </div>
                <div class="col-md-6">
                    <strong>成本明细：</strong>
                    <div>课程成本：${totalActualSessions} 节 × ¥${courseCostPerSession.toFixed(2)} = ¥${sessionCost.toFixed(2)}</div>
                    <div>其他成本：¥${otherCost.toFixed(2)}</div>
                    ${paymentChannel === '淘宝' ? `<div>手续费：¥${feeAmount.toFixed(2)}</div>` : ''}
                    <div>总成本：¥${totalCost.toFixed(2)}</div>
                </div>
            </div>
            <div class="mt-3 text-center">
                <h5 class="${netProfit >= 0 ? 'profit-positive' : 'profit-negative'}">
                    净利润：¥${netProfit.toFixed(2)}
                </h5>
            </div>
            <div class="mt-2 text-muted text-center" style="font-size: 0.9rem;">
                说明：课程成本基于实际消耗节数计算（${actualSessions} 节 + ${actualGiftSessions} 节 = ${totalActualSessions} 节）
            </div>
        `;
    } else {
        document.getElementById('profitPreviewContent').innerHTML = 
            '<div class="text-muted text-center">请填写购买节数和单节售价</div>';
    }
}

// 保存退费信息（在模态框中）
async function saveRefundInModal(refundId) {
    const btns = document.querySelectorAll('button');
    btns.forEach(b => b.disabled = true);
    
    // 获取所有可编辑的字段
    const sEl = document.getElementById('rf_sessions_' + refundId);
    const aEl = document.getElementById('rf_amount_' + refundId);
    const rEl = document.getElementById('rf_reason_' + refundId);
    const cEl = document.getElementById('rf_channel_' + refundId);
    const fEl = document.getElementById('rf_fee_' + refundId);
    const rmEl = document.getElementById('rf_remark_' + refundId);
    
    try {
        const payload = {};
        if (sEl && sEl.value !== '') payload.refund_sessions = Number(sEl.value);
        if (aEl && aEl.value !== '') {
            // 用户输入的是实际退款金额，需要加上手续费才是原始退费金额
            const actualRefundAmount = Number(aEl.value);
            const fee = Number(fEl.value) || 0;
            payload.refund_amount = actualRefundAmount + fee;
        }
        if (rEl && rEl.value !== '') payload.refund_reason = rEl.value;
        if (cEl && cEl.value !== '') payload.refund_channel = cEl.value;
        if (fEl && fEl.value !== '') payload.refund_fee = Number(fEl.value);
        if (rmEl && rmEl.value !== '') payload.remark = rmEl.value;
        
        const resp = await fetch('/api/courses/refunds/' + refundId, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (!resp.ok || !data.success) {
            showAlert(data.message || '保存失败', 'danger');
        } else {
            showAlert('保存成功！', 'success');
            
            // 更新退费统计信息
            if (data.refund_summary) {
                document.getElementById('refunded_sessions').value = data.refund_summary.total_refunded_sessions;
                // 显示实际退款金额（扣除手续费后的金额）
                const actualRefundAmount = data.refund_summary.total_refunded_amount - data.refund_summary.total_refunded_fees;
                document.getElementById('refunded_amount').value = actualRefundAmount.toFixed(2);
                document.getElementById('refundable_sessions').value = data.refund_summary.refundable_sessions;
            }
            
            // 更新利润预览
            updateProfitPreview();
        }
    } catch (e) {
        showAlert('网络错误，稍后再试', 'danger');
    } finally {
        btns.forEach(b => b.disabled = false);
    }
}

// 保存学员详情
function saveCustomerDetail() {
    const formData = new FormData(document.getElementById('customerDetailForm'));
    const data = Object.fromEntries(formData);
    
    // 根据不同类型调用不同的API
    let apiUrl = '';
    let method = 'PUT';
    
    if (currentDetailData.courseType === 'trial') {
        apiUrl = `/api/trial-courses/${data.course_id}`;
    } else if (currentDetailData.courseType === 'formal') {
        apiUrl = `/api/formal-courses/${data.course_id}`;
    } else {
        apiUrl = `/api/customers/${data.customer_id}`;
    }
    
    // 发送请求
    fetch(apiUrl, {
        method: method,
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert('保存成功', 'success');
            const modal = document.getElementById('customerDetailModal');
            if (modal) {
                modal.style.display = 'none';
            }
            // 刷新页面或更新表格
            setTimeout(() => location.reload(), 500);
        } else {
            showAlert(result.message || '保存失败', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('保存失败：' + error.message, 'danger');
    });
}

// 显示提示信息
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    `;
    document.querySelector('.modal-body').insertBefore(alertDiv, document.querySelector('.modal-body').firstChild);
    
    setTimeout(() => alertDiv.remove(), 3000);
}

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    loadSystemConfigs();
    
    // 添加点击模态框外部关闭的功能
    document.getElementById('customerDetailModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeCustomerDetailModal();
        }
    });
});
</script>