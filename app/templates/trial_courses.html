{% extends "base.html" %}

{% block title %}试听课管理 - 客户管理系统{% endblock %}
{% block page_title %}试听课管理{% endblock %}

{% block content %}
<div class="page-container">
    <!-- 统计卡片 -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-play-circle"></i>
            </div>
            <div class="stat-content">
                <h3>{{ stats.total_trials }}</h3>
                <p>试听课总数</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-money-bill-wave"></i>
            </div>
            <div class="stat-content">
                <h3>¥{{ "%.2f"|format(stats.total_revenue) }}</h3>
                <p>总收入</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-coins"></i>
            </div>
            <div class="stat-content">
                <h3>¥{{ "%.2f"|format(stats.total_cost) }}</h3>
                <p>总成本</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-content">
                <h3>¥{{ "%.2f"|format(stats.total_profit) }}</h3>
                <p>总利润</p>
            </div>
        </div>
    </div>

    <!-- 添加试听课表单 -->
    <div class="form-section">
        <h3><i class="fas fa-plus"></i> 添加试听课记录</h3>
        
        <!-- 选择录入方式 -->
        <div class="input-mode-selector">
            <label class="radio-option">
                <input type="radio" name="input_mode" value="existing" checked>
                <span>选择已有学员</span>
            </label>
            <label class="radio-option">
                <input type="radio" name="input_mode" value="new">
                <span>录入新学员</span>
            </label>
        </div>
        
        <form method="POST" class="form-grid">
            <!-- 选择已有学员 -->
            <div id="existing-customer-section" class="customer-section">
                <div class="form-group">
                    <label for="customer_id">学员姓名 *</label>
                    <select name="customer_id" id="customer_id">
                        <option value="">请选择学员</option>
                        {% for customer in customers %}
                        <option value="{{ customer.id }}">{{ customer.name }} ({{ customer.phone }})</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <!-- 录入新学员 -->
            <div id="new-customer-section" class="customer-section" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label for="new_customer_name">学员姓名 *</label>
                        <input type="text" name="new_customer_name" id="new_customer_name" placeholder="请输入学员姓名">
                    </div>
                    <div class="form-group">
                        <label for="new_customer_phone">联系电话 *</label>
                        <input type="tel" name="new_customer_phone" id="new_customer_phone" placeholder="请输入联系电话">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="new_customer_gender">性别</label>
                        <select name="new_customer_gender" id="new_customer_gender">
                            <option value="">请选择</option>
                            <option value="男">男</option>
                            <option value="女">女</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="new_customer_grade">年级</label>
                        <select name="new_customer_grade" id="new_customer_grade">
                            <option value="">请选择</option>
                            <option value="一年级">一年级</option>
                            <option value="二年级">二年级</option>
                            <option value="三年级">三年级</option>
                            <option value="四年级">四年级</option>
                            <option value="五年级">五年级</option>
                            <option value="六年级">六年级</option>
                            <option value="初一">初一</option>
                            <option value="初二">初二</option>
                            <option value="初三">初三</option>
                            <option value="高一">高一</option>
                            <option value="高二">高二</option>
                            <option value="高三">高三</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="new_customer_region">地区</label>
                        <input type="text" name="new_customer_region" id="new_customer_region" placeholder="请输入地区">
                    </div>
                </div>
            </div>
            
            <!-- 试听课信息 -->
            <div class="form-row">
                <div class="form-group">
                    <label for="trial_price">试听课售价 *</label>
                    <input type="number" name="trial_price" id="trial_price" step="0.01" min="0" required>
                </div>
                
                <div class="form-group">
                    <label for="source">渠道来源 *</label>
                    <select name="source" id="source" required>
                        <option value="">请选择渠道</option>
                        <option value="淘宝">淘宝</option>
                        <option value="视频号">视频号</option>
                        <option value="抖音">抖音</option>
                        <option value="小红书">小红书</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus"></i> 添加试听课
                </button>
            </div>
        </form>
    </div>

    <!-- 试听课列表 -->
    <div class="table-section">
        <div class="table-header">
            <h3><i class="fas fa-list"></i> 试听课记录</h3>
        </div>
        
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>学员姓名</th>
                        <th>性别</th>
                        <th>年级</th>
                        <th>地区</th>
                        <th>联系方式</th>
                        <th>试听课售价</th>
                        <th>渠道来源</th>
                        <th>报名时间</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for course, customer in trial_courses %}
                    <tr>
                        <td>{{ customer.name }}</td>
                        <td>{{ customer.gender or '-' }}</td>
                        <td>{{ customer.grade or '-' }}</td>
                        <td>{{ customer.region or '-' }}</td>
                        <td>{{ customer.phone }}</td>
                        <td>¥{{ "%.2f"|format(course.trial_price) }}</td>
                        <td>{{ course.source or '-' }}</td>
                        <td>{{ course.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            {% if course.converted_to_course %}
                                <span class="status-badge status-converted">已转正课</span>
                            {% else %}
                                <span class="status-badge status-pending">待转化</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="action-buttons">
                                {% if not course.converted_to_course %}
                                <a href="{{ url_for('convert_trial_to_course', trial_id=course.id) }}" 
                                   class="btn btn-sm btn-success" title="转正课">
                                    <i class="fas fa-arrow-right"></i>
                                </a>
                                <button onclick="deleteTrialCourse({{ course.id }})" 
                                        class="btn btn-sm btn-danger" title="删除">
                                    <i class="fas fa-trash"></i>
                                </button>
                                {% else %}
                                <span class="text-muted">已转化</span>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="10" class="text-center">暂无试听课记录</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 消息提示 -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div id="flash-messages">
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<script>
// 删除试听课记录
function deleteTrialCourse(courseId) {
    if (confirm('确定要删除这条试听课记录吗？')) {
        fetch(`/api/trial-courses/${courseId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || '删除失败');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('删除失败');
        });
    }
}

// 页面加载完成后执行
document.addEventListener('DOMContentLoaded', function() {
    console.log('试听课管理页面加载完成');
    
    // 处理录入方式切换
    const inputModeRadios = document.querySelectorAll('input[name="input_mode"]');
    const existingSection = document.getElementById('existing-customer-section');
    const newSection = document.getElementById('new-customer-section');
    const customerSelect = document.getElementById('customer_id');
    const newCustomerInputs = newSection.querySelectorAll('input[required], select[required]');
    
    inputModeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'existing') {
                existingSection.style.display = 'block';
                newSection.style.display = 'none';
                customerSelect.required = true;
                // 移除新客户字段的必填要求
                newCustomerInputs.forEach(input => {
                    input.required = false;
                });
            } else {
                existingSection.style.display = 'none';
                newSection.style.display = 'block';
                customerSelect.required = false;
                customerSelect.value = '';
                // 添加新客户字段的必填要求
                document.getElementById('new_customer_name').required = true;
                document.getElementById('new_customer_phone').required = true;
            }
        });
    });
    
    // 表单提交验证
    const form = document.querySelector('.form-grid');
    form.addEventListener('submit', function(e) {
        const inputMode = document.querySelector('input[name="input_mode"]:checked').value;
        
        if (inputMode === 'existing') {
            if (!customerSelect.value) {
                e.preventDefault();
                alert('请选择学员');
                return;
            }
        } else {
            const name = document.getElementById('new_customer_name').value.trim();
            const phone = document.getElementById('new_customer_phone').value.trim();
            
            if (!name) {
                e.preventDefault();
                alert('请输入学员姓名');
                return;
            }
            
            if (!phone) {
                e.preventDefault();
                alert('请输入联系电话');
                return;
            }
            
            // 验证手机号格式
            const phoneRegex = /^1[3-9]\d{9}$/;
            if (!phoneRegex.test(phone)) {
                e.preventDefault();
                alert('请输入正确的手机号码');
                return;
            }
        }
    });
    
    // 自动隐藏消息提示
    const flashMessages = document.getElementById('flash-messages');
    if (flashMessages) {
        setTimeout(() => {
            flashMessages.style.opacity = '0';
            setTimeout(() => {
                flashMessages.remove();
            }, 300);
        }, 3000);
    }
});
</script>

<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 15px;
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
}

.stat-card:nth-child(1) .stat-icon { background: #007bff; }
.stat-card:nth-child(2) .stat-icon { background: #28a745; }
.stat-card:nth-child(3) .stat-icon { background: #ffc107; }
.stat-card:nth-child(4) .stat-icon { background: #17a2b8; }

.stat-content h3 {
    margin: 0;
    font-size: 24px;
    font-weight: bold;
    color: #333;
}

.stat-content p {
    margin: 5px 0 0 0;
    color: #666;
    font-size: 14px;
}

.form-section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.form-section h3 {
    margin: 0 0 20px 0;
    color: #333;
}

.form-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
    margin-bottom: 30px;
}

.input-mode-selector {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.radio-option {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-weight: 500;
    color: #495057;
}

.radio-option input[type="radio"] {
    margin: 0;
    accent-color: #007bff;
}

.customer-section {
    transition: all 0.3s ease;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    margin-bottom: 5px;
    font-weight: 500;
    color: #333;
}

.form-group input,
.form-group select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

.table-section {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
}

.table-header {
    padding: 20px;
    border-bottom: 1px solid #eee;
}

.table-header h3 {
    margin: 0;
    color: #333;
}

.table-container {
    overflow-x: auto;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.data-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #333;
}

.data-table tbody tr:hover {
    background: #f8f9fa;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}

.status-converted {
    background: #d4edda;
    color: #155724;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
}

.action-buttons {
    display: flex;
    gap: 5px;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 14px;
    transition: all 0.2s;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-success:hover {
    background: #1e7e34;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 12px;
}

.text-center {
    text-align: center;
}

.text-muted {
    color: #6c757d;
}

#flash-messages {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    transition: opacity 0.3s;
}

.alert {
    padding: 12px 20px;
    border-radius: 4px;
    margin-bottom: 10px;
    font-weight: 500;
}

.alert-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.alert-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}
</style>
{% endblock %}