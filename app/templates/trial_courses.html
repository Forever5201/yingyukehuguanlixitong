{% extends "base.html" %}

{% block title %}è¯•å¬è¯¾ç®¡ç† - å®¢æˆ·ç®¡ç†ç³»ç»Ÿ{% endblock %}
{% block page_title %}è¯•å¬è¯¾ç®¡ç†{% endblock %}

{% block content %}
<div class="page-container">
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-play-circle"></i>
            </div>
            <div class="stat-content">
                <h3>{{ stats.total_trials }}</h3>
                <p>è¯•å¬è¯¾æ€»æ•°</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-money-bill-wave"></i>
            </div>
            <div class="stat-content">
                <h3>Â¥{{ "%.2f"|format(stats.total_revenue) }}</h3>
                <p>æ€»æ”¶å…¥</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-coins"></i>
            </div>
            <div class="stat-content">
                <h3>Â¥{{ "%.2f"|format(stats.total_cost) }}</h3>
                <p>æ€»æˆæœ¬</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-content">
                <h3>Â¥{{ "%.2f"|format(stats.total_profit) }}</h3>
                <p>æ€»åˆ©æ¶¦</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-percentage"></i>
            </div>
            <div class="stat-content">
                <h3>Â¥{{ "%.2f"|format(stats.total_fees) }}</h3>
                <p>æ€»æ‰‹ç»­è´¹</p>
            </div>
        </div>
    </div>

    <!-- çŠ¶æ€ç»Ÿè®¡è¯¦æƒ… -->
    <div class="status-stats-section">
        <h3><i class="fas fa-chart-pie"></i> çŠ¶æ€ç»Ÿè®¡è¯¦æƒ…</h3>
        <div class="status-stats-grid">
            <div class="status-stat-card registered">
                <div class="status-stat-header">
                    <i class="fas fa-user-check"></i>
                    <span>å·²æŠ¥åè¯•å¬è¯¾</span>
                </div>
                <div class="status-stat-content">
                    <div class="stat-row">
                        <span>æ•°é‡ï¼š</span>
                        <span>{{ status_stats.registered.count }}</span>
                    </div>
                    <div class="stat-row">
                        <span>æ”¶å…¥ï¼š</span>
                        <span>Â¥{{ "%.2f"|format(status_stats.registered.revenue) }}</span>
                    </div>
                    <div class="stat-row">
                        <span>æˆæœ¬ï¼š</span>
                        <span>Â¥{{ "%.2f"|format(status_stats.registered.cost) }}</span>
                    </div>
                    <div class="stat-row">
                        <span>æ‰‹ç»­è´¹ï¼š</span>
                        <span>Â¥{{ "%.2f"|format(status_stats.registered.fees) }}</span>
                    </div>
                    <div class="stat-row profit">
                        <span>åˆ©æ¶¦ï¼š</span>
                        <span class="{% if status_stats.registered.profit >= 0 %}profit-positive{% else %}profit-negative{% endif %}">
                            Â¥{{ "%.2f"|format(status_stats.registered.profit) }}
                        </span>
                    </div>
                </div>
            </div>

            <div class="status-stat-card not-registered">
                <div class="status-stat-header">
                    <i class="fas fa-user-times"></i>
                    <span>æœªæŠ¥åè¯•å¬è¯¾</span>
                </div>
                <div class="status-stat-content">
                    <div class="stat-row">
                        <span>æ•°é‡ï¼š</span>
                        <span>{{ status_stats.not_registered.count }}</span>
                    </div>
                    <div class="stat-row">
                        <span>æ”¶å…¥ï¼š</span>
                        <span>Â¥{{ "%.2f"|format(status_stats.not_registered.revenue) }}</span>
                    </div>
                    <div class="stat-row">
                        <span>æˆæœ¬ï¼š</span>
                        <span>Â¥{{ "%.2f"|format(status_stats.not_registered.cost) }}</span>
                    </div>
                    <div class="stat-row">
                        <span>æ‰‹ç»­è´¹ï¼š</span>
                        <span>Â¥{{ "%.2f"|format(status_stats.not_registered.fees) }}</span>
                    </div>
                    <div class="stat-row profit">
                        <span>åˆ©æ¶¦ï¼š</span>
                        <span class="{% if status_stats.not_registered.profit >= 0 %}profit-positive{% else %}profit-negative{% endif %}">
                            Â¥{{ "%.2f"|format(status_stats.not_registered.profit) }}
                        </span>
                    </div>
                </div>
            </div>

            <div class="status-stat-card refunded">
                <div class="status-stat-header">
                    <i class="fas fa-undo"></i>
                    <span>è¯•å¬åé€€è´¹</span>
                </div>
                <div class="status-stat-content">
                    <div class="stat-row">
                        <span>æ•°é‡ï¼š</span>
                        <span>{{ status_stats.refunded.count }}</span>
                    </div>
                    <div class="stat-row">
                        <span>æ”¶å…¥ï¼š</span>
                        <span>Â¥{{ "%.2f"|format(status_stats.refunded.revenue) }}</span>
                    </div>
                    <div class="stat-row">
                        <span>æˆæœ¬ï¼š</span>
                        <span>Â¥{{ "%.2f"|format(status_stats.refunded.cost) }}</span>
                    </div>
                    <div class="stat-row">
                        <span>æ‰‹ç»­è´¹ï¼š</span>
                        <span>Â¥{{ "%.2f"|format(status_stats.refunded.fees) }}</span>
                    </div>
                    <div class="stat-row profit">
                        <span>åˆ©æ¶¦ï¼š</span>
                        <span class="{% if status_stats.refunded.profit >= 0 %}profit-positive{% else %}profit-negative{% endif %}">
                            Â¥{{ "%.2f"|format(status_stats.refunded.profit) }}
                        </span>
                    </div>
                </div>
            </div>

            <div class="status-stat-card converted">
                <div class="status-stat-header">
                    <i class="fas fa-arrow-right"></i>
                    <span>è¯•å¬åè½¬æ­£è¯¾</span>
                </div>
                <div class="status-stat-content">
                    <div class="stat-row">
                        <span>æ•°é‡ï¼š</span>
                        <span>{{ status_stats.converted.count }}</span>
                    </div>
                    <div class="stat-row">
                        <span>æ”¶å…¥ï¼š</span>
                        <span>Â¥{{ "%.2f"|format(status_stats.converted.revenue) }}</span>
                    </div>
                    <div class="stat-row">
                        <span>æˆæœ¬ï¼š</span>
                        <span>Â¥{{ "%.2f"|format(status_stats.converted.cost) }}</span>
                    </div>
                    <div class="stat-row">
                        <span>æ‰‹ç»­è´¹ï¼š</span>
                        <span>Â¥{{ "%.2f"|format(status_stats.converted.fees) }}</span>
                    </div>
                    <div class="stat-row profit">
                        <span>åˆ©æ¶¦ï¼š</span>
                        <span class="{% if status_stats.converted.profit >= 0 %}profit-positive{% else %}profit-negative{% endif %}">
                            Â¥{{ "%.2f"|format(status_stats.converted.profit) }}
                        </span>
                    </div>
                </div>
            </div>

            <div class="status-stat-card no-action">
                <div class="status-stat-header">
                    <i class="fas fa-clock"></i>
                    <span>è¯•å¬åæ— æ“ä½œ</span>
                </div>
                <div class="status-stat-content">
                    <div class="stat-row">
                        <span>æ•°é‡ï¼š</span>
                        <span>{{ status_stats.no_action.count }}</span>
                    </div>
                    <div class="stat-row">
                        <span>æ”¶å…¥ï¼š</span>
                        <span>Â¥{{ "%.2f"|format(status_stats.no_action.revenue) }}</span>
                    </div>
                    <div class="stat-row">
                        <span>æˆæœ¬ï¼š</span>
                        <span>Â¥{{ "%.2f"|format(status_stats.no_action.cost) }}</span>
                    </div>
                    <div class="stat-row">
                        <span>æ‰‹ç»­è´¹ï¼š</span>
                        <span>Â¥{{ "%.2f"|format(status_stats.no_action.fees) }}</span>
                    </div>
                    <div class="stat-row profit">
                        <span>åˆ©æ¶¦ï¼š</span>
                        <span class="{% if status_stats.no_action.profit >= 0 %}profit-positive{% else %}profit-negative{% endif %}">
                            Â¥{{ "%.2f"|format(status_stats.no_action.profit) }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ è¯•å¬è¯¾æŒ‰é’® -->
    <div class="form-section">
        <div class="add-trial-header">
            <h3><i class="fas fa-plus"></i> è¯•å¬è¯¾ç®¡ç†</h3>
            <div class="header-actions">
                <button type="button" class="btn btn-info" onclick="exportTrialData()">
                    <i class="fas fa-download"></i> å¯¼å‡ºæ•°æ®
                </button>
                <button type="button" class="btn btn-primary" id="addTrialBtn">
                    <i class="fas fa-user-plus"></i> å½•å…¥æ–°å­¦å‘˜
                </button>
            </div>
        </div>
    </div>

    <!-- å½•å…¥æ–°å­¦å‘˜æ¨¡æ€æ¡† -->
    <div id="addTrialModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4><i class="fas fa-user-plus"></i> å½•å…¥æ–°å­¦å‘˜è¯•å¬è¯¾</h4>
                <span class="close">&times;</span>
            </div>
            <form method="POST" class="modal-form" id="trialForm">
                <div class="modal-body">
                    <!-- æ™ºèƒ½è¯†åˆ«åŒºåŸŸ -->
                    <div class="form-section-modal">
                        <h5><i class="fas fa-magic"></i> æ™ºèƒ½è¯†åˆ« <small style="color: #6c757d;">(å¯é€‰)</small></h5>
                        <div class="smart-input-container">
                            <textarea id="smartInput" placeholder="æ™ºèƒ½è¯†åˆ«å­¦å‘˜ä¿¡æ¯ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«å¹¶å¡«å…¥è¡¨å•...&#10;&#10;æ”¯æŒæ ¼å¼ï¼š&#10;1. å®Œæ•´ä¿¡æ¯ï¼šå¼ ä¸‰ ç”· åˆä¸­ æˆéƒ½ 13812345678&#10;2. å•ç‹¬è¾“å…¥ï¼šæ‰‹æœºå·ã€å§“åã€åœ°åŒºã€å¹´çº§ã€æ€§åˆ«ç­‰ä»»æ„ä¿¡æ¯&#10;3. ç»„åˆè¾“å…¥ï¼šå¼ ä¸‰ 13812345678ã€æˆéƒ½ åˆä¸­ã€æå›› å¥³ç­‰&#10;4. å¹´çº§æ”¯æŒï¼šå°å­¦ã€åˆä¸­ã€é«˜ä¸­ã€å¤§å­¦&#10;5. åœ°åŒºæ”¯æŒï¼šå…¨å›½ä¸»è¦åŸå¸‚è‡ªåŠ¨è¯†åˆ«&#10;&#10;æ³¨ï¼šåªæœ‰è”ç³»æ–¹å¼æ˜¯å¿…å¡«é¡¹ï¼Œå…¶ä»–ä¿¡æ¯å¯é€‰" rows="6"></textarea>
                            <button type="button" id="parseBtn" class="btn btn-info">
                                <i class="fas fa-wand-magic-sparkles"></i> æ™ºèƒ½è§£æ
                            </button>
                        </div>
                    </div>
                    
                    <!-- å­¦å‘˜ä¿¡æ¯ -->
                    <div class="form-section-modal">
                        <h5><i class="fas fa-user"></i> å­¦å‘˜ä¿¡æ¯</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="new_customer_name">å­¦å‘˜å§“å</label>
                                <input type="text" name="new_customer_name" id="new_customer_name" placeholder="è¯·è¾“å…¥å­¦å‘˜å§“å">
                            </div>
                            <div class="form-group">
                                <label for="new_customer_phone">è”ç³»ç”µè¯ *</label>
                                <input type="tel" name="new_customer_phone" id="new_customer_phone" placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="new_customer_gender">æ€§åˆ«</label>
                                <select name="new_customer_gender" id="new_customer_gender">
                                    <option value="">è¯·é€‰æ‹©</option>
                                    <option value="ç”·">ç”·</option>
                                    <option value="å¥³">å¥³</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="new_customer_grade">å¹´çº§</label>
                                <select name="new_customer_grade" id="new_customer_grade">
                                    <option value="">è¯·é€‰æ‹©</option>
                                    <option value="å°å­¦">å°å­¦</option>
                                    <option value="åˆä¸­">åˆä¸­</option>
                                    <option value="é«˜ä¸­">é«˜ä¸­</option>
                                    <option value="å¤§å­¦">å¤§å­¦</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="new_customer_region">åœ°åŒº</label>
                                <input type="text" name="new_customer_region" id="new_customer_region" placeholder="è¯·è¾“å…¥åœ°åŒº">
                            </div>
                        </div>
                        
                        <!-- è‹±è¯­æˆç»©ä¿¡æ¯ -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="english_full_score">è‹±è¯­è¯•å·æ»¡åˆ†</label>
                                <input type="number" name="english_full_score" id="english_full_score" placeholder="å¦‚ï¼š120" min="0">
                            </div>
                            <div class="form-group">
                                <label for="english_current_score">è‹±è¯­å½“å‰åˆ†æ•°</label>
                                <input type="number" name="english_current_score" id="english_current_score" placeholder="å¦‚ï¼š100" min="0">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="has_tutoring_experience">æ˜¯å¦å‚åŠ è¿‡è‹±è¯­è¯¾å¤–è¾…å¯¼</label>
                                <select name="has_tutoring_experience" id="has_tutoring_experience">
                                    <option value="">è¯·é€‰æ‹©</option>
                                    <option value="æ˜¯">æ˜¯</option>
                                    <option value="å¦">å¦</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è¯•å¬è¯¾ä¿¡æ¯ -->
                    <div class="form-section-modal">
                        <h5><i class="fas fa-book"></i> è¯•å¬è¯¾ä¿¡æ¯</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="trial_price">è¯•å¬è¯¾å”®ä»· *</label>
                                <input type="number" name="trial_price" id="trial_price" step="0.01" min="0" placeholder="è¯·è¾“å…¥å”®ä»·" required>
                            </div>
                            <div class="form-group">
                                <label for="source">æ¸ é“æ¥æº *</label>
                                <select name="source" id="source" required>
                                    <option value="">è¯·é€‰æ‹©æ¸ é“</option>
                                    <option value="æ·˜å®">æ·˜å®</option>
                                    <option value="è§†é¢‘å·">è§†é¢‘å·</option>
                                    <option value="æŠ–éŸ³">æŠ–éŸ³</option>
                                    <option value="å°çº¢ä¹¦">å°çº¢ä¹¦</option>
                                    <option value="å…¶ä»–">å…¶ä»–</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="assigned_employee_id">åˆ†é…ç»™å‘˜å·¥</label>
                                <select name="assigned_employee_id" id="assigned_employee_id">
                                    <option value="">æš‚ä¸åˆ†é…ï¼ˆå¯ç¨ååˆ†é…ï¼‰</option>
                                    {% for employee in employees %}
                                    <option value="{{ employee.id }}">{{ employee.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> ä¿å­˜è¯•å¬è¯¾è®°å½•
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç¼–è¾‘è¯•å¬è¯¾æ¨¡æ€æ¡† -->
    <div id="editTrialModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4><i class="fas fa-edit"></i> ç¼–è¾‘è¯•å¬è¯¾ä¿¡æ¯</h4>
                <span class="close-edit">&times;</span>
            </div>
            <form method="POST" class="modal-form" id="editTrialForm">
                <input type="hidden" id="edit_trial_course_id" name="course_id">
                <div class="modal-body">
                    <!-- å­¦å‘˜ä¿¡æ¯ -->
                    <div class="form-section-modal">
                        <h5><i class="fas fa-user"></i> å­¦å‘˜ä¿¡æ¯</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit_trial_customer_name">å­¦å‘˜å§“å *</label>
                                <input type="text" name="customer_name" id="edit_trial_customer_name" placeholder="è¯·è¾“å…¥å­¦å‘˜å§“å" required>
                            </div>
                            <div class="form-group">
                                <label for="edit_trial_customer_phone">è”ç³»ç”µè¯ *</label>
                                <input type="tel" name="customer_phone" id="edit_trial_customer_phone" placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit_trial_customer_gender">æ€§åˆ«</label>
                                <select name="customer_gender" id="edit_trial_customer_gender">
                                    <option value="">è¯·é€‰æ‹©</option>
                                    <option value="ç”·">ç”·</option>
                                    <option value="å¥³">å¥³</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="edit_trial_customer_grade">å¹´çº§</label>
                                <select name="customer_grade" id="edit_trial_customer_grade">
                                    <option value="">è¯·é€‰æ‹©</option>
                                    <option value="å°å­¦">å°å­¦</option>
                                    <option value="åˆä¸­">åˆä¸­</option>
                                    <option value="é«˜ä¸­">é«˜ä¸­</option>
                                    <option value="å¤§å­¦">å¤§å­¦</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit_trial_customer_region">åœ°åŒº</label>
                                <input type="text" name="customer_region" id="edit_trial_customer_region" placeholder="è¯·è¾“å…¥åœ°åŒº">
                            </div>
                            <div class="form-group">
                                <label for="edit_trial_has_tutoring_experience">æ˜¯å¦å‚åŠ è¿‡è‹±è¯­è¯¾å¤–è¾…å¯¼</label>
                                <select name="has_tutoring_experience" id="edit_trial_has_tutoring_experience">
                                    <option value="">è¯·é€‰æ‹©</option>
                                    <option value="æ˜¯">æ˜¯</option>
                                    <option value="å¦">å¦</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è¯•å¬è¯¾ä¿¡æ¯ -->
                    <div class="form-section-modal">
                        <h5><i class="fas fa-book"></i> è¯•å¬è¯¾ä¿¡æ¯</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit_trial_price">è¯•å¬è¯¾å”®ä»· *</label>
                                <input type="number" name="trial_price" id="edit_trial_price" step="0.01" min="0" placeholder="è¯·è¾“å…¥å”®ä»·" required>
                            </div>
                            <div class="form-group">
                                <label for="edit_trial_source">æ¸ é“æ¥æº *</label>
                                <select name="source" id="edit_trial_source" required>
                                    <option value="">è¯·é€‰æ‹©æ¸ é“</option>
                                    <option value="æ·˜å®">æ·˜å®</option>
                                    <option value="è§†é¢‘å·">è§†é¢‘å·</option>
                                    <option value="æŠ–éŸ³">æŠ–éŸ³</option>
                                    <option value="å°çº¢ä¹¦">å°çº¢ä¹¦</option>
                                    <option value="å…¶ä»–">å…¶ä»–</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="editCancelBtn">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> ä¿å­˜ä¿®æ”¹
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- é€€è´¹ä¿¡æ¯æ¨¡æ€æ¡† -->
    <div id="refundModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4><i class="fas fa-money-bill-wave"></i> é€€è´¹ä¿¡æ¯</h4>
                <span class="close" onclick="closeRefundModal()">&times;</span>
            </div>
            <form id="refundForm" class="modal-form">
                <input type="hidden" id="refund_course_id">
                <div class="modal-body">
                    <div class="form-section-modal">
                        <h5><i class="fas fa-calculator"></i> é€€è´¹è¯¦æƒ…</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="refund_amount">é€€è´¹é‡‘é¢ *</label>
                                <input type="number" id="refund_amount" step="0.01" min="0" placeholder="è¯·è¾“å…¥é€€è´¹é‡‘é¢" required>
                            </div>
                            <div class="form-group">
                                <label for="refund_fee">é€€è´¹æ‰‹ç»­è´¹ *</label>
                                <input type="number" id="refund_fee" step="0.01" min="0" placeholder="è¯·è¾“å…¥é€€è´¹æ‰‹ç»­è´¹" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="refund_note">é€€è´¹è¯´æ˜</label>
                                <textarea id="refund_note" rows="3" placeholder="è¯·è¾“å…¥é€€è´¹åŸå› æˆ–è¯´æ˜ï¼ˆå¯é€‰ï¼‰"></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="refund_channel">é€€æ¬¾æ¸ é“ *</label>
                                <select id="refund_channel" required>
                                    <option value="">è¯·é€‰æ‹©æ¸ é“</option>
                                    <option value="å¾®ä¿¡">å¾®ä¿¡</option>
                                    <option value="æ·˜å®">æ·˜å®</option>
                                    <option value="æ”¯ä»˜å®">æ”¯ä»˜å®</option>
                                    <option value="è§†é¢‘å·">è§†é¢‘å·</option>
                                    <option value="æŠ–éŸ³">æŠ–éŸ³</option>
                                    <option value="å°çº¢ä¹¦">å°çº¢ä¹¦</option>
                                    <option value="å…¶ä»–">å…¶ä»–</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeRefundModal()">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-warning" onclick="submitRefund()">
                        <i class="fas fa-check"></i> ç¡®è®¤é€€è´¹
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ•°æ®ç»Ÿè®¡å›¾è¡¨ -->
    <div class="charts-section">
        <div class="charts-grid">
            <div class="chart-card">
                <h4><i class="fas fa-chart-pie"></i> æ¸ é“æ¥æºåˆ†å¸ƒ</h4>
                <canvas id="sourceChart" width="300" height="200"></canvas>
            </div>
            <div class="chart-card">
                <h4><i class="fas fa-chart-bar"></i> è½¬åŒ–ç‡ç»Ÿè®¡</h4>
                <canvas id="conversionChart" width="300" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- è¯•å¬è¯¾åˆ—è¡¨ -->
    <div class="table-section">
        <div class="table-header">
            <h3><i class="fas fa-list"></i> è¯•å¬è¯¾è®°å½•</h3>
            
            <!-- æœç´¢å’Œç­›é€‰ -->
            <div class="search-filter-section">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="æœç´¢å­¦å‘˜å§“åæˆ–ç”µè¯..." class="search-input">
                    <i class="fas fa-search search-icon"></i>
                </div>
                
                <div class="filter-controls">
                    <select id="sourceFilter" class="filter-select">
                        <option value="">å…¨éƒ¨æ¸ é“</option>
                        <option value="æ·˜å®">æ·˜å®</option>
                        <option value="è§†é¢‘å·">è§†é¢‘å·</option>
                        <option value="æŠ–éŸ³">æŠ–éŸ³</option>
                        <option value="å°çº¢ä¹¦">å°çº¢ä¹¦</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                    
                    <select id="statusFilter" class="filter-select">
                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="registered">å·²æŠ¥åè¯•å¬è¯¾</option>
                        <option value="not_registered">æœªæŠ¥åè¯•å¬è¯¾</option>
                        <option value="refunded">è¯•å¬åé€€è´¹</option>
                        <option value="converted">è¯•å¬åè½¬æ­£è¯¾</option>
                        <option value="no_action">è¯•å¬åæ— æ“ä½œ</option>
                    </select>
                    
                    <button id="exportBtn" class="btn btn-outline-primary">
                        <i class="fas fa-download"></i> å¯¼å‡ºæ•°æ®
                    </button>
                </div>
            </div>
        </div>
        
        <!-- æ‰¹é‡æ“ä½œå·¥å…·æ  -->
        <div class="batch-operations mb-3" id="batchOperations" style="display: none;">
            <div class="alert alert-info d-flex align-items-center" style="margin-bottom: 10px;">
                <span style="margin-right: auto;">å·²é€‰æ‹© <strong id="selectedCount">0</strong> ä¸ªè¯•å¬è¯¾</span>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-primary" onclick="batchAssignEmployee()" style="padding: 5px 15px; border-radius: 4px; border: none;">
                        <i class="fas fa-user-tag"></i> æ‰¹é‡åˆ†é…å‘˜å·¥
                    </button>
                    <button class="btn-warning" onclick="batchUnassign()" style="padding: 5px 15px; border-radius: 4px; border: none;">
                        <i class="fas fa-user-slash"></i> æ‰¹é‡å–æ¶ˆåˆ†é…
                    </button>
                    <button class="btn-secondary" onclick="clearSelection()" style="padding: 5px 15px; border-radius: 4px; border: none;">
                        <i class="fas fa-times"></i> å–æ¶ˆé€‰æ‹©
                    </button>
                </div>
            </div>
        </div>

        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th width="40">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        </th>
                        <th>å­¦å‘˜å§“å</th>
                        <th>æ€§åˆ«</th>
                        <th>å¹´çº§</th>
                        <th>åœ°åŒº</th>
                        <th>è”ç³»æ–¹å¼</th>
                        <th>ä½“éªŒæƒ…å†µ</th>
                        <th>è¯•å¬è¯¾å”®ä»·</th>
                        <th>æ¸ é“æ¥æº</th>
                        <th>æ‰‹ç»­è´¹</th>
                        <th>æŠ¥åæ—¶é—´</th>
                        <th>è¯•å¬è¯¾çŠ¶æ€</th>
                        <th>è´Ÿè´£å‘˜å·¥</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for course, customer in trial_courses %}
                    <tr data-course-id="{{ course.id }}">
                        <td>
                            <input type="checkbox" class="course-checkbox" value="{{ course.id }}" onchange="updateSelection()">
                        </td>
                        <td>{{ customer.name }}</td>
                        <td>{{ customer.gender or '-' }}</td>
                        <td>{{ customer.grade or '-' }}</td>
                        <td>{{ customer.region or '-' }}</td>
                        <td>{{ customer.phone }}</td>
                        <td>
                            {% if customer.has_tutoring_experience == 'æ˜¯' %}
                                <span class="status-badge status-experience">æœ‰ä½“éªŒ</span>
                            {% elif customer.has_tutoring_experience == 'å¦' %}
                                <span class="status-badge status-no-experience">æ— ä½“éªŒ</span>
                            {% else %}
                                <span class="text-muted">æœªçŸ¥</span>
                            {% endif %}
                        </td>
                        <td>Â¥{{ "%.2f"|format(course.trial_price) }}</td>
                        <td>{{ course.source or '-' }}</td>
                        <td>
                            {% if course.trial_status == 'refunded' %}
                                {% if (course.refund_channel or '') == 'æ·˜å®' %}
                                    Â¥0.00
                                {% else %}
                                    {% set recorded_fee = (course.refund_fee or 0) %}
                                    {% if recorded_fee > 0 %}
                                        Â¥{{ "%.2f"|format(recorded_fee) }}
                                    {% else %}
                                        {% set fee_amount = (course.trial_price or 0) * (taobao_fee_rate or 0.006) %}
                                        Â¥{{ "%.2f"|format(fee_amount) }}
                                    {% endif %}
                                {% endif %}
                            {% elif course.source == 'æ·˜å®' %}
                                {% set fee_amount = course.trial_price * (taobao_fee_rate or 0.006) %}
                                Â¥{{ "%.2f"|format(fee_amount) }}
                            {% else %}
                                Â¥0.00
                            {% endif %}
                        </td>

                        <td>{{ course.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            <div class="status-management">
                                {% set current_status = course.trial_status or 'registered' %}
                                <select class="status-select" data-course-id="{{ course.id }}" data-trial-price="{{ "%.2f"|format(course.trial_price or 0) }}" onchange="updateTrialStatus('{{ course.id }}', this.value)">
                                    <option value="registered" {% if current_status == 'registered' %}selected{% endif %}>å·²æŠ¥åè¯•å¬è¯¾</option>
                                    <option value="not_registered" {% if current_status == 'not_registered' %}selected{% endif %}>æœªæŠ¥åè¯•å¬è¯¾</option>
                                    <option value="refunded" {% if current_status == 'refunded' %}selected{% endif %}>è¯•å¬åé€€è´¹</option>
                                    <option value="converted" {% if current_status == 'converted' %}selected{% endif %}>è¯•å¬åè½¬æ­£è¯¾</option>
                                    <option value="no_action" {% if current_status == 'no_action' %}selected{% endif %}>è¯•å¬åæ— æ“ä½œ</option>
                                </select>
                                {% if current_status == 'refunded' %}
                                <div class="refund-info">
                                    <small>é€€è´¹ï¼šÂ¥{{ "%.2f"|format(course.refund_amount or 0) }}</small>
                                    <small>æ‰‹ç»­è´¹ï¼šÂ¥{{ "%.2f"|format(course.refund_fee or 0) }}</small>
                                    <small>é€€æ¬¾æ¸ é“ï¼š{{ course.refund_channel or '-' }}</small>
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <div class="employee-assign">
                                <select class="form-control form-control-sm employee-select {% if not course.assigned_employee_id %}text-muted{% endif %}" 
                                        data-course-id="{{ course.id }}" 
                                        data-original-value="{% if course.assigned_employee %}{{ course.assigned_employee.name }}{% else %}æœªåˆ†é…{% endif %}"
                                        onchange="assignEmployee('{{ course.id }}', this.value)">
                                    <option value="" {% if not course.assigned_employee_id %}selected{% endif %}>
                                        ğŸš« æœªåˆ†é…
                                    </option>
                                    {% for employee in employees %}
                                    <option value="{{ employee.id }}" 
                                            {% if course.assigned_employee_id == employee.id %}selected{% endif %}>
                                        âœ… {{ employee.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <!-- æŸ¥çœ‹è¯¦æƒ…æŒ‰é’® -->
                                <button onclick="showCustomerDetail('{{ customer.id }}', '{{ course.id }}', 'trial')" 
                                        class="btn btn-sm btn-outline-info action-btn" title="æŸ¥çœ‹è¯¦æƒ…">
                                    <i class="fas fa-eye"></i>
                                    <span class="btn-text">æŸ¥çœ‹</span>
                                </button>
                                
                                <!-- å¿«é€Ÿç¼–è¾‘æŒ‰é’® -->
                                <button onclick="editTrialCourse('{{ course.id }}')" 
                                        class="btn btn-sm btn-outline-primary action-btn" title="å¿«é€Ÿç¼–è¾‘">
                                    <i class="fas fa-edit"></i>
                                    <span class="btn-text">ç¼–è¾‘</span>
                                </button>
                                
                                <!-- è½¬æ­£è¯¾æŒ‰é’® -->
                                {% if not course.converted_to_course %}
                                <a href="{{ url_for('main.convert_trial_to_course', trial_id=course.id) }}" 
                                   class="btn btn-sm btn-outline-success action-btn" title="è½¬æ­£è¯¾">
                                    <i class="fas fa-arrow-right"></i>
                                    <span class="btn-text">è½¬æ­£</span>
                                </a>
                                {% else %}
                                <span class="btn btn-sm btn-outline-secondary action-btn disabled" title="å·²è½¬æ­£">
                                    <i class="fas fa-check"></i>
                                    <span class="btn-text">å·²è½¬æ­£</span>
                                </span>
                                {% endif %}
                                
                                <!-- åˆ é™¤æŒ‰é’® -->
                                <button onclick="deleteTrialCourse('{{ course.id }}', 'è¯•å¬è¯¾ç”¨æˆ·')" 
                                        class="btn btn-sm btn-outline-danger action-btn" title="åˆ é™¤">
                                    <i class="fas fa-trash"></i>
                                    <span class="btn-text">åˆ é™¤</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="11" class="text-center">æš‚æ— è¯•å¬è¯¾è®°å½•</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- æ¶ˆæ¯æç¤º -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div id="flash-messages">
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<script>
// åˆ é™¤è¯•å¬è¯¾è®°å½•
function deleteTrialCourse(courseId, userType = 'è¯•å¬è¯¾ç”¨æˆ·') {
    // ä½¿ç”¨å…¬å…±æ¨¡å—è¿›è¡Œåˆ é™¤
    CourseManager.deleteTrialCourse(courseId, userType);
}

// æ›´æ–°è¯•å¬è¯¾çŠ¶æ€
function updateTrialStatus(courseId, newStatus) {
    // å¦‚æœæ˜¯é€€è´¹çŠ¶æ€ï¼Œéœ€è¦å¼¹å‡ºé€€è´¹ä¿¡æ¯è¾“å…¥æ¡†
    if (newStatus === 'refunded') {
        showRefundModal(courseId);
        return;
    }
    
    // å…¶ä»–çŠ¶æ€ç›´æ¥æ›´æ–°
    updateStatusAPI(courseId, newStatus);
}

// æ˜¾ç¤ºé€€è´¹ä¿¡æ¯æ¨¡æ€æ¡†
function showRefundModal(courseId) {
    document.getElementById('refund_course_id').value = courseId;

    // ä»å½“å‰è¡Œçš„çŠ¶æ€ä¸‹æ‹‰è¯»å–è¯•å¬å”®ä»·ï¼Œè‡ªåŠ¨å¡«å…¥é€€è´¹é‡‘é¢ï¼›æ‰‹ç»­è´¹å›ºå®šä¸º0
    const selectEl = document.querySelector(`select.status-select[data-course-id="${courseId}"]`);
    const amountInput = document.getElementById('refund_amount');
    const feeInput = document.getElementById('refund_fee');
    let trialPrice = 0;
    if (selectEl && selectEl.dataset.trialPrice) {
        const p = parseFloat(selectEl.dataset.trialPrice);
        trialPrice = isNaN(p) ? 0 : p;
    }
    if (amountInput) {
        amountInput.value = trialPrice.toFixed(2);
        amountInput.readOnly = true;
    }
    if (feeInput) {
        feeInput.value = '0.00';
        feeInput.readOnly = true;
    }

    document.getElementById('refundModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

// å…³é—­é€€è´¹ä¿¡æ¯æ¨¡æ€æ¡†
function closeRefundModal() {
    document.getElementById('refundModal').style.display = 'none';
    document.body.style.overflow = 'auto';
    document.getElementById('refundForm').reset();
}

// æäº¤é€€è´¹ä¿¡æ¯
function submitRefund() {
    const courseId = document.getElementById('refund_course_id').value;
    const refundAmount = document.getElementById('refund_amount').value;
    const refundFee = document.getElementById('refund_fee').value;
    const refundChannel = document.getElementById('refund_channel').value;
    
    if (!refundAmount || refundAmount <= 0) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é€€è´¹é‡‘é¢');
        return;
    }
    
    if (!refundFee || refundFee < 0) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é€€è´¹æ‰‹ç»­è´¹');
        return;
    }
    
    if (!refundChannel) {
        alert('è¯·é€‰æ‹©é€€æ¬¾æ¸ é“');
        return;
    }
    
    updateStatusAPI(courseId, 'refunded', {
        refund_amount: parseFloat(refundAmount),
        refund_fee: parseFloat(refundFee),
        refund_channel: refundChannel
    });
}

// è°ƒç”¨APIæ›´æ–°çŠ¶æ€
function updateStatusAPI(courseId, status, extraData = {}) {
    const requestData = {
        status: status,
        ...extraData
    };
    
    fetch(`/api/trial-courses/${courseId}/status`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (status === 'refunded') {
                closeRefundModal();
            }
            location.reload();
        } else {
            alert(data.message || 'çŠ¶æ€æ›´æ–°å¤±è´¥');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('çŠ¶æ€æ›´æ–°å¤±è´¥');
    });
}

// ç¼–è¾‘è¯•å¬è¯¾è®°å½• - å‚è€ƒåˆ·å•ç®¡ç†çš„ç®€åŒ–å®ç°
function editTrialCourse(courseId) {
    console.log('=== è¯•å¬è¯¾ç¼–è¾‘å‡½æ•°è¢«è°ƒç”¨ ===');
    console.log('courseId:', courseId);
    
    // ç›´æ¥é€šè¿‡APIè·å–æœ€æ–°æ•°æ®ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ä¼ é€’çš„å‚æ•°
    fetch(`/api/trial-courses/${encodeURIComponent(courseId)}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('è·å–åˆ°çš„è¯•å¬è¯¾æ•°æ®:', data);
            
            if (data.success && data.course) {
                const course = data.course;
                const customer = data.customer || {};
                
                // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†æ ‡é¢˜
                const modalTitle = document.querySelector('#editTrialModal .modal-header h4');
                if (modalTitle) {
                    modalTitle.textContent = 'ç¼–è¾‘è¯•å¬è¯¾è®°å½•';
                }
                
                // è®¾ç½®éšè—çš„è¯¾ç¨‹ID
                const courseIdField = document.getElementById('edit_trial_course_id');
                if (courseIdField) {
                    courseIdField.value = course.id;
                }
                
                // å¡«å……è¡¨å•å­—æ®µ
                const fields = {
                    'edit_trial_customer_name': customer.name || '',
                    'edit_trial_customer_phone': customer.phone || '',
                    'edit_trial_customer_gender': customer.gender || '',
                    'edit_trial_customer_grade': customer.grade || '',
                    'edit_trial_customer_region': customer.region || '',
                    'edit_trial_price': course.trial_price || course.price || '',
                    'edit_trial_source': course.source || '',
                    'edit_trial_has_tutoring_experience': customer.has_tutoring_experience || ''
                };
                
                // é€ä¸ªå¡«å……å­—æ®µ
                for (const [fieldId, value] of Object.entries(fields)) {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.value = value;
                        console.log(`å¡«å……å­—æ®µ ${fieldId}:`, value);
                    } else {
                        console.warn(`å­—æ®µ ${fieldId} æœªæ‰¾åˆ°`);
                    }
                }
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                const modal = document.getElementById('editTrialModal');
                if (modal) {
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                    console.log('ç¼–è¾‘æ¨¡æ€æ¡†å·²æ˜¾ç¤º');
                } else {
                    console.error('ç¼–è¾‘æ¨¡æ€æ¡†æœªæ‰¾åˆ°');
                }
            } else {
                console.error('APIè¿”å›å¤±è´¥:', data);
                alert('è·å–è¯¾ç¨‹ä¿¡æ¯å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
            }
        })
        .catch(error => {
            console.error('è·å–è¯•å¬è¯¾æ•°æ®å¤±è´¥:', error);
            alert('è·å–è¯¾ç¨‹ä¿¡æ¯å¤±è´¥: ' + error.message);
        });
}

// é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
document.addEventListener('DOMContentLoaded', function() {
    console.log('è¯•å¬è¯¾ç®¡ç†é¡µé¢åŠ è½½å®Œæˆ');
    
    // æ¨¡æ€æ¡†æ§åˆ¶
     const addTrialBtn = document.getElementById('addTrialBtn');
     const trialModal = document.getElementById('addTrialModal');
     const closeModal = document.querySelector('.close');
     const cancelBtn = document.getElementById('cancelBtn');
     const trialForm = document.getElementById('trialForm');
     
     // æ‰“å¼€æ¨¡æ€æ¡†
     if (addTrialBtn) {
         addTrialBtn.addEventListener('click', function() {
             trialModal.style.display = 'block';
             document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
         });
     }
     
     // å…³é—­æ¨¡æ€æ¡†
     function closeTrialModal() {
         trialModal.style.display = 'none';
         document.body.style.overflow = 'auto';
         trialForm.reset(); // é‡ç½®è¡¨å•
     }
     
     if (closeModal) closeModal.addEventListener('click', closeTrialModal);
     if (cancelBtn) cancelBtn.addEventListener('click', closeTrialModal);
     
     // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
     window.addEventListener('click', function(event) {
         if (event.target === trialModal) {
             closeTrialModal();
         }
     });
     
     // åˆå§‹åŒ–å…¬å…±æ¨¡æ€æ¡†äº‹ä»¶ï¼ˆè¯•å¬è¯¾ç¼–è¾‘ï¼‰
     CourseManager.initModalEvents();
     
     // ç›‘å¬æ¥è‡ªç»„ä»¶çš„ç¼–è¾‘äº‹ä»¶
     document.addEventListener('editTrialCourse', function(event) {
         const { courseId, tableId } = event.detail;
         console.log('ç¼–è¾‘è¯•å¬è¯¾äº‹ä»¶è§¦å‘ï¼Œè¯¾ç¨‹ID:', courseId);
         
         // é€šè¿‡APIè·å–è¯¾ç¨‹è¯¦ç»†ä¿¡æ¯
         fetch(`/api/trial-courses/${courseId}`)
             .then(response => response.json())
             .then(data => {
                 console.log('APIè¿”å›æ•°æ®:', data);
                 
                 if (data.success && data.course) {
                     const course = data.course;
                     const customer = data.customer || {};
                     
                     console.log('è¯¾ç¨‹æ•°æ®:', course);
                     console.log('å®¢æˆ·æ•°æ®:', customer);
                     
                     // æ„é€ è¯¾ç¨‹æ•°æ®å¯¹è±¡
                     const courseData = {
                         customer_name: customer.name || '',
                         customer_phone: customer.phone || '',
                         customer_gender: customer.gender || '',
                         customer_grade: customer.grade || '',
                         customer_region: customer.region || '',
                         trial_price: course.trial_price || course.price || '',
                         price: course.trial_price || course.price || '',
                         source: course.source || '',
                         has_tutoring_experience: customer.has_tutoring_experience || ''
                     };
                     
                     console.log('æ„é€ çš„è¯¾ç¨‹æ•°æ®å¯¹è±¡:', courseData);
                     
                     // ä½¿ç”¨å…¬å…±æ¨¡å—è¿›è¡Œç¼–è¾‘
                     CourseManager.editTrialCourse(courseId, courseData);
                 } else {
                     console.error('APIè¿”å›å¤±è´¥:', data);
                     alert('è·å–è¯¾ç¨‹ä¿¡æ¯å¤±è´¥');
                 }
             })
             .catch(error => {
                 console.error('APIè¯·æ±‚é”™è¯¯:', error);
                 alert('è·å–è¯¾ç¨‹ä¿¡æ¯å¤±è´¥');
             });
     });
     
     // æ™ºèƒ½è¯†åˆ«åŠŸèƒ½
    const smartInput = document.getElementById('smartInput');
    const parseBtn = document.getElementById('parseBtn');
    
    console.log('smartInput:', smartInput);
    console.log('parseBtn:', parseBtn);
    
    if (parseBtn && smartInput) {
        parseBtn.addEventListener('click', function() {
            const text = smartInput.value.trim();
             if (!text) {
                 alert('è¯·å…ˆè¾“å…¥å­¦å‘˜ä¿¡æ¯');
                 return;
             }
             
             // è§£ææ–‡æœ¬å¹¶å¡«å…¥è¡¨å•
             parseStudentInfo(text);
             
             // æ¸…ç©ºæ™ºèƒ½è¯†åˆ«åŒºåŸŸ
             smartInput.value = '';
             
             // æ˜¾ç¤ºæˆåŠŸæç¤º
             showParseSuccess();
         });
     }
     
     // è§£æå­¦å‘˜ä¿¡æ¯çš„å‡½æ•°
     function parseStudentInfo(text) {
         console.log('å¼€å§‹è§£ææ–‡æœ¬:', text);
         
         // å®šä¹‰åŒ¹é…è§„åˆ™
         const patterns = {
             name: [
                 /å­¦å‘˜å§“å[ï¼š:]\s*([^\n\r]+)/i,
                 /å§“å[ï¼š:]\s*([^\n\r]+)/i,
                 /åå­—[ï¼š:]\s*([^\n\r]+)/i
             ],
             gender: [
                 /æ€§åˆ«[ï¼š:]\s*([ç”·å¥³])/i
             ],
             grade: [
                 /å¹´çº§[ï¼š:]\s*([^\n\r]+)/i,
                 /å­¦å¹´[ï¼š:]\s*([^\n\r]+)/i
             ],
             region: [
                 /åœ°åŒº[ï¼š:]\s*([^\n\r]+)/i,
                 /åœ°å€[ï¼š:]\s*([^\n\r]+)/i,
                 /åŸå¸‚[ï¼š:]\s*([^\n\r]+)/i
             ],
             phone: [
                 /è”ç³»æ–¹å¼[ï¼š:]\s*([1][3-9]\d{9})/i,
                 /ç”µè¯[ï¼š:]\s*([1][3-9]\d{9})/i,
                 /æ‰‹æœº[ï¼š:]\s*([1][3-9]\d{9})/i,
                 /([1][3-9]\d{9})/g
             ],
             englishFullScore: [
                 /è‹±è¯­è¯•å·æ»¡åˆ†[ï¼š:]\s*(\d+)/i,
                 /æ»¡åˆ†[ï¼š:]\s*(\d+)/i
             ],
             englishCurrentScore: [
                 /è‹±è¯­å½“å‰åˆ†æ•°[ï¼š:]\s*(\d+)/i,
                 /å½“å‰åˆ†æ•°[ï¼š:]\s*(\d+)/i,
                 /ç°åœ¨åˆ†æ•°[ï¼š:]\s*(\d+)/i
             ],
             hasTutoring: [
                 /æ˜¯å¦å‚åŠ è¿‡è‹±è¯­è¯¾å¤–è¾…å¯¼[ï¼š:]\s*([æ˜¯å¦])/i,
                 /è¯¾å¤–è¾…å¯¼[ï¼š:]\s*([æ˜¯å¦])/i
             ]
         };
         
         // è§£æå„ä¸ªå­—æ®µ
         const results = {};
         
         // å…ˆå°è¯•æ ‡å‡†æ ¼å¼è§£æ
         for (const [field, regexList] of Object.entries(patterns)) {
             for (const regex of regexList) {
                 const match = text.match(regex);
                 if (match && match[1]) {
                     results[field] = match[1].trim();
                     console.log(`åŒ¹é…åˆ°${field}:`, results[field]);
                     break;
                 }
             }
         }
         
         // æ™ºèƒ½è¯†åˆ«ï¼šå¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ä»»ä½•æ ‡å‡†æ ¼å¼ï¼Œå°è¯•æ™ºèƒ½è¯†åˆ«
         if (Object.keys(results).length === 0) {
             console.log('æ ‡å‡†æ ¼å¼è§£æå¤±è´¥ï¼Œå°è¯•æ™ºèƒ½è¯†åˆ«...');
             
             // å»é™¤ç©ºç™½å­—ç¬¦ï¼Œè·å–çº¯æ–‡æœ¬
             const cleanText = text.trim();
             
             // å®šä¹‰å¸¸è§åœ°åŒºã€å¹´çº§ç­‰å…³é”®è¯
             const regions = ['åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿å·', 'æ·±åœ³', 'æ­å·', 'å—äº¬', 'è‹å·', 'æˆéƒ½', 'é‡åº†', 'æ­¦æ±‰', 'è¥¿å®‰', 'å¤©æ´¥', 'é’å²›', 'å¤§è¿', 'å®æ³¢', 'å¦é—¨', 'é•¿æ²™', 'éƒ‘å·', 'æµå—', 'å“ˆå°”æ»¨', 'æ²ˆé˜³', 'é•¿æ˜¥', 'çŸ³å®¶åº„', 'å¤ªåŸ', 'å‘¼å’Œæµ©ç‰¹', 'å…°å·', 'è¥¿å®', 'é“¶å·', 'ä¹Œé²æœ¨é½', 'æ‹‰è¨', 'æ˜†æ˜', 'è´µé˜³', 'å—å®', 'æµ·å£', 'ä¸‰äºš', 'ç¦å·', 'åˆè‚¥', 'å—æ˜Œ', 'æ¸©å·', 'æ— é”¡', 'å¸¸å·', 'å¾å·', 'æ‰¬å·', 'é•‡æ±Ÿ', 'æ³°å·', 'ç›åŸ', 'æ·®å®‰', 'è¿äº‘æ¸¯', 'å®¿è¿'];
             const grades = ['å°å­¦', 'åˆä¸­', 'é«˜ä¸­', 'å¤§å­¦', 'å¹¼å„¿å›­'];
             const genders = ['ç”·', 'å¥³'];
             
             // æ£€æŸ¥æ˜¯å¦åªæ˜¯æ‰‹æœºå·
             const phoneMatch = cleanText.match(/^([1][3-9]\d{9})$/);
             if (phoneMatch) {
                 results.phone = phoneMatch[1];
                 console.log('è¯†åˆ«ä¸ºçº¯æ‰‹æœºå·:', results.phone);
             }
             // æ£€æŸ¥æ˜¯å¦æ˜¯å¹´çº§
             else if (grades.includes(cleanText)) {
                 results.grade = cleanText;
                 console.log('è¯†åˆ«ä¸ºå¹´çº§:', results.grade);
             }
             // æ£€æŸ¥æ˜¯å¦æ˜¯åœ°åŒº
             else if (regions.includes(cleanText)) {
                 results.region = cleanText;
                 console.log('è¯†åˆ«ä¸ºåœ°åŒº:', results.region);
             }
             // æ£€æŸ¥æ˜¯å¦æ˜¯æ€§åˆ«
             else if (genders.includes(cleanText)) {
                 results.gender = cleanText;
                 console.log('è¯†åˆ«ä¸ºæ€§åˆ«:', results.gender);
             }
             // æ£€æŸ¥æ˜¯å¦åªæ˜¯å§“åï¼ˆ2-4ä¸ªä¸­æ–‡å­—ç¬¦ï¼Œä¸åŒ…å«æ•°å­—ï¼Œä¸”ä¸æ˜¯åœ°åŒºã€å¹´çº§ã€æ€§åˆ«ï¼‰
             else if (/^[\u4e00-\u9fa5]{2,4}$/.test(cleanText) && 
                      !regions.includes(cleanText) && 
                      !grades.includes(cleanText) && 
                      !genders.includes(cleanText)) {
                 results.name = cleanText;
                 console.log('è¯†åˆ«ä¸ºçº¯å§“å:', results.name);
             }
             // æ£€æŸ¥æ˜¯å¦åŒ…å«å¤šç§ä¿¡æ¯çš„ç»„åˆ
             else {
                 // æå–æ‰‹æœºå·
                 const phoneInText = cleanText.match(/([1][3-9]\d{9})/);
                 if (phoneInText) {
                     results.phone = phoneInText[1];
                     console.log('ä»æ–‡æœ¬ä¸­æå–æ‰‹æœºå·:', results.phone);
                 }
                 
                 // æå–åœ°åŒº
                 for (const region of regions) {
                     if (cleanText.includes(region)) {
                         results.region = region;
                         console.log('ä»æ–‡æœ¬ä¸­æå–åœ°åŒº:', results.region);
                         break;
                     }
                 }
                 
                 // æå–å¹´çº§
                 for (const grade of grades) {
                     if (cleanText.includes(grade)) {
                         results.grade = grade;
                         console.log('ä»æ–‡æœ¬ä¸­æå–å¹´çº§:', results.grade);
                         break;
                     }
                 }
                 
                 // æå–æ€§åˆ«
                 for (const gender of genders) {
                     if (cleanText.includes(gender)) {
                         results.gender = gender;
                         console.log('ä»æ–‡æœ¬ä¸­æå–æ€§åˆ«:', results.gender);
                         break;
                     }
                 }
                 
                 // æå–å§“åï¼ˆç§»é™¤å·²è¯†åˆ«çš„ä¿¡æ¯åï¼‰
                 let textForName = cleanText;
                 if (results.phone) {
                     textForName = textForName.replace(/([1][3-9]\d{9})/, '').trim();
                 }
                 if (results.region) {
                     textForName = textForName.replace(results.region, '').trim();
                 }
                 if (results.grade) {
                     textForName = textForName.replace(results.grade, '').trim();
                 }
                 if (results.gender) {
                     textForName = textForName.replace(results.gender, '').trim();
                 }
                 
                 // ä»å‰©ä½™æ–‡æœ¬ä¸­æå–å§“å
                 const nameMatch = textForName.match(/[\u4e00-\u9fa5]{2,4}/);
                 if (nameMatch) {
                     results.name = nameMatch[0];
                     console.log('ä»æ–‡æœ¬ä¸­æå–å§“å:', results.name);
                 }
             }
         }
         
         // å¡«å…¥è¡¨å•
         if (results.name) {
             document.getElementById('new_customer_name').value = results.name;
         }
         
         if (results.gender) {
             document.getElementById('new_customer_gender').value = results.gender;
         }
         
         if (results.grade) {
             // å¤„ç†å¹´çº§æ ¼å¼
             let grade = results.grade;
             if (grade.includes('æ–°')) {
                 grade = grade.replace('æ–°', '');
             }
             // å°è¯•åŒ¹é…ä¸‹æ‹‰é€‰é¡¹
             const gradeSelect = document.getElementById('new_customer_grade');
             const options = Array.from(gradeSelect.options);
             const matchedOption = options.find(option => 
                 option.value.includes(grade) || grade.includes(option.value)
             );
             if (matchedOption) {
                 gradeSelect.value = matchedOption.value;
             }
         }
         
         if (results.region) {
             document.getElementById('new_customer_region').value = results.region;
         }
         
         if (results.phone) {
             document.getElementById('new_customer_phone').value = results.phone;
         }
         
         if (results.englishFullScore) {
             document.getElementById('english_full_score').value = results.englishFullScore;
         }
         
         if (results.englishCurrentScore) {
             document.getElementById('english_current_score').value = results.englishCurrentScore;
         }
         
         if (results.hasTutoring) {
             document.getElementById('has_tutoring_experience').value = results.hasTutoring;
         }
         
         console.log('è§£æç»“æœ:', results);
     }
     
     // æ˜¾ç¤ºè§£ææˆåŠŸæç¤º
     function showParseSuccess() {
         const btn = document.getElementById('parseBtn');
         if (btn) {
             const originalText = btn.innerHTML;
             btn.innerHTML = '<i class="fas fa-check"></i> è§£ææˆåŠŸï¼';
             btn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
             
             setTimeout(() => {
                 btn.innerHTML = originalText;
                 btn.style.background = 'linear-gradient(135deg, #17a2b8 0%, #138496 100%)';
             }, 2000);
         }
     }
     
     // è¡¨å•æäº¤éªŒè¯
     if (trialForm) {
         trialForm.addEventListener('submit', function(e) {
             const name = document.getElementById('new_customer_name').value.trim();
             const phone = document.getElementById('new_customer_phone').value.trim();
             const price = document.getElementById('trial_price').value.trim();
             const source = document.getElementById('source').value;
            
            // åªéªŒè¯è”ç³»ç”µè¯ä¸ºå¿…å¡«é¡¹
            if (!phone) {
                e.preventDefault();
                alert('è¯·è¾“å…¥è”ç³»ç”µè¯');
                return;
            }
            
            // éªŒè¯æ‰‹æœºå·æ ¼å¼
            const phoneRegex = /^1[3-9]\d{9}$/;
            if (!phoneRegex.test(phone)) {
                e.preventDefault();
                alert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ');
                return;
            }
            
            if (!price || parseFloat(price) < 0) {
                e.preventDefault();
                alert('è¯·è¾“å…¥æ­£ç¡®çš„è¯•å¬è¯¾å”®ä»·');
                return;
            }
            
            if (!source) {
                e.preventDefault();
                alert('è¯·é€‰æ‹©æ¸ é“æ¥æº');
                return;
            }
         });
    }
    
    // è‡ªåŠ¨éšè—æ¶ˆæ¯æç¤º
    const flashMessages = document.getElementById('flash-messages');
    if (flashMessages) {
        setTimeout(() => {
            flashMessages.style.opacity = '0';
            setTimeout(() => {
                flashMessages.remove();
            }, 300);
        }, 3000);
    }
    
    // å¯¼å‡ºæ•°æ®åŠŸèƒ½
    window.exportTrialData = function() {
        const button = event.target;
        const originalText = button.innerHTML;
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å¯¼å‡ºä¸­...';
        button.disabled = true;
        
        // åˆ›å»ºä¸€ä¸ªéšè—çš„é“¾æ¥æ¥ä¸‹è½½æ–‡ä»¶
        const link = document.createElement('a');
        link.href = '/api/export/trial-courses';
        link.download = '';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        setTimeout(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        }, 2000);
    };
    
    // æœç´¢å’Œç­›é€‰åŠŸèƒ½
    const searchInput = document.getElementById('searchInput');
    const sourceFilter = document.getElementById('sourceFilter');
    const statusFilter = document.getElementById('statusFilter');
    const exportBtn = document.getElementById('exportBtn');
    const tableRows = document.querySelectorAll('.data-table tbody tr');
    
    // åˆå§‹åŒ–å›¾è¡¨
    initCharts();
    
    // æœç´¢åŠŸèƒ½
    function filterTable() {
        const searchTerm = searchInput.value.toLowerCase();
        const sourceValue = sourceFilter.value;
        const statusValue = statusFilter.value;
        
        tableRows.forEach(row => {
             if (row.cells.length === 1) return; // è·³è¿‡"æš‚æ— è®°å½•"è¡Œ
             
             const name = row.cells[0].textContent.toLowerCase(); // å­¦å‘˜å§“å
             const phone = row.cells[4].textContent.toLowerCase(); // è”ç³»æ–¹å¼
             const source = row.cells[7].textContent.trim(); // æ¸ é“æ¥æºï¼ˆç¬¬8åˆ—ï¼‰
             const statusSelect = row.cells[10].querySelector('.status-select'); // çŠ¶æ€ä¸‹æ‹‰ï¼ˆç¬¬11åˆ—ï¼‰
             const status = statusSelect ? statusSelect.value : '';
            
            const matchesSearch = name.includes(searchTerm) || phone.includes(searchTerm);
            const matchesSource = !sourceValue || source === sourceValue;
            const matchesStatus = !statusValue || status === statusValue;
            
            if (matchesSearch && matchesSource && matchesStatus) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯å’Œå›¾è¡¨
        updateFilterStats();
        updateChartsWithFilteredData();
    }
    
    // æ›´æ–°ç­›é€‰åçš„ç»Ÿè®¡ä¿¡æ¯
    function updateFilterStats() {
        const visibleRows = Array.from(tableRows).filter(row => 
            row.style.display !== 'none' && row.cells.length > 1
        );
        
        let totalPrice = 0;
        visibleRows.forEach(row => {
             const priceText = row.cells[6].textContent.replace('Â¥', '').replace(/,/g, '').trim(); // è¯•å¬è¯¾å”®ä»·ï¼ˆç¬¬7åˆ—ï¼‰
             totalPrice += parseFloat(priceText) || 0;
         });
        
        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ˜¾ç¤ºç­›é€‰åç»Ÿè®¡ä¿¡æ¯çš„é€»è¾‘
        console.log(`ç­›é€‰åè®°å½•æ•°: ${visibleRows.length}, æ€»é‡‘é¢: Â¥${totalPrice.toFixed(2)}`);
    }
    
    // ç»‘å®šäº‹ä»¶
    if (searchInput) searchInput.addEventListener('input', filterTable);
    if (sourceFilter) sourceFilter.addEventListener('change', filterTable);
    if (statusFilter) statusFilter.addEventListener('change', filterTable);
    
    // å¯¼å‡ºåŠŸèƒ½
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
        const visibleRows = Array.from(tableRows).filter(row => 
            row.style.display !== 'none' && row.cells.length > 1
        );
        
        if (visibleRows.length === 0) {
            alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
            return;
        }
        
        // æ„å»ºCSVæ•°æ®ï¼ˆæŒ‰æŒ‡å®šåˆ—é¡ºåºè¾“å‡ºï¼‰
        let csvContent = 'å­¦å‘˜å§“å,æ€§åˆ«,å¹´çº§,åœ°åŒº,è”ç³»æ–¹å¼,è¯•å¬è¯¾å”®ä»·,æ¸ é“æ¥æº,æŠ¥åæ—¶é—´,çŠ¶æ€\n';
        
        visibleRows.forEach(row => {
            const pick = idx => (row.cells[idx]?.textContent || '').trim();
            const statusSelect = row.cells[10].querySelector('.status-select');
            const statusTextMap = {
                registered: 'å·²æŠ¥åè¯•å¬è¯¾',
                not_registered: 'æœªæŠ¥åè¯•å¬è¯¾',
                refunded: 'è¯•å¬åé€€è´¹',
                converted: 'è¯•å¬åè½¬æ­£è¯¾',
                no_action: 'è¯•å¬åæ— æ“ä½œ'
            };
            const data = [
                pick(0), // å§“å
                pick(1), // æ€§åˆ«
                pick(2), // å¹´çº§
                pick(3), // åœ°åŒº
                pick(4), // è”ç³»æ–¹å¼
                pick(6).replace(/^Â¥/, ''), // å”®ä»·ï¼ˆå»Â¥ï¼‰
                pick(7), // æ¸ é“æ¥æº
                pick(9), // æŠ¥åæ—¶é—´
                statusTextMap[statusSelect ? statusSelect.value : ''] || '' // çŠ¶æ€
            ];
            const escaped = data.map(text => {
                let t = (text || '').toString();
                if (t.includes(',') || t.includes('"') || t.includes('\n')) {
                    t = '"' + t.replace(/"/g, '""') + '"';
                }
                return t;
            });
            csvContent += escaped.join(',') + '\n';
        });
        
        // ä¸‹è½½æ–‡ä»¶
        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `è¯•å¬è¯¾è®°å½•_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
         document.body.removeChild(link);
         });
     }
     
     // æ ¹æ®ç­›é€‰ç»“æœæ›´æ–°å›¾è¡¨
     function updateChartsWithFilteredData() {
         const visibleRows = Array.from(tableRows).filter(row => 
             row.style.display !== 'none' && row.cells.length > 1
         );
         
         const sourceData = {};
         const conversionData = { total: 0, converted: 0 };
         
         visibleRows.forEach(row => {
             const source = row.cells[7].textContent.trim(); // æ¸ é“æ¥æºï¼ˆç¬¬8åˆ—ï¼‰
             const statusSelect = row.cells[10].querySelector('.status-select'); // çŠ¶æ€ï¼ˆç¬¬11åˆ—ï¼‰
             const isConverted = statusSelect && statusSelect.value === 'converted';
             
             // ç»Ÿè®¡æ¸ é“æ¥æº
             sourceData[source] = (sourceData[source] || 0) + 1;
             
             // ç»Ÿè®¡è½¬åŒ–ç‡
             conversionData.total++;
             if (isConverted) {
                 conversionData.converted++;
             }
         });
         
         // é‡æ–°ç»˜åˆ¶å›¾è¡¨
         drawSourceChart(sourceData);
         drawConversionChart(conversionData);
     }
     
     // å›¾è¡¨åˆå§‹åŒ–å‡½æ•°
     function initCharts() {
        // ç»Ÿè®¡æ•°æ®
        const sourceData = {};
        const conversionData = { total: 0, converted: 0 };
        
        tableRows.forEach(row => {
            if (row.cells.length === 1) return; // è·³è¿‡"æš‚æ— è®°å½•"è¡Œ
            
            const source = row.cells[7].textContent.trim(); // æ¸ é“æ¥æºï¼ˆç¬¬8åˆ—ï¼‰
            const statusSelect = row.cells[10].querySelector('.status-select'); // çŠ¶æ€ï¼ˆç¬¬11åˆ—ï¼‰
            const isConverted = statusSelect && statusSelect.value === 'converted';
            
            // ç»Ÿè®¡æ¸ é“æ¥æº
            sourceData[source] = (sourceData[source] || 0) + 1;
            
            // ç»Ÿè®¡è½¬åŒ–ç‡
            conversionData.total++;
            if (isConverted) {
                conversionData.converted++;
            }
        });
         
         // ç»˜åˆ¶æ¸ é“æ¥æºé¥¼å›¾
         drawSourceChart(sourceData);
         
         // ç»˜åˆ¶è½¬åŒ–ç‡æŸ±çŠ¶å›¾
         drawConversionChart(conversionData);
     }
     
     // ç»˜åˆ¶æ¸ é“æ¥æºé¥¼å›¾
     function drawSourceChart(data) {
         const canvas = document.getElementById('sourceChart');
         const ctx = canvas.getContext('2d');
         const centerX = canvas.width / 2;
         const centerY = canvas.height / 2;
         const radius = Math.min(centerX, centerY) - 20;
         
         // æ¸…ç©ºç”»å¸ƒ
         ctx.clearRect(0, 0, canvas.width, canvas.height);
         
         if (Object.keys(data).length === 0) {
             ctx.fillStyle = '#666';
             ctx.font = '14px Arial';
             ctx.textAlign = 'center';
             ctx.fillText('æš‚æ— æ•°æ®', centerX, centerY);
             return;
         }
         
         const total = Object.values(data).reduce((sum, val) => sum + val, 0);
         const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14'];
         
         let currentAngle = -Math.PI / 2;
         let colorIndex = 0;
         
         // ç»˜åˆ¶é¥¼å›¾
         Object.entries(data).forEach(([source, count]) => {
             const sliceAngle = (count / total) * 2 * Math.PI;
             
             ctx.beginPath();
             ctx.moveTo(centerX, centerY);
             ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
             ctx.closePath();
             ctx.fillStyle = colors[colorIndex % colors.length];
             ctx.fill();
             
             // ç»˜åˆ¶æ ‡ç­¾
             const labelAngle = currentAngle + sliceAngle / 2;
             const labelX = centerX + Math.cos(labelAngle) * (radius * 0.7);
             const labelY = centerY + Math.sin(labelAngle) * (radius * 0.7);
             
             ctx.fillStyle = 'white';
             ctx.font = 'bold 12px Arial';
             ctx.textAlign = 'center';
             ctx.fillText(`${count}`, labelX, labelY);
             
             currentAngle += sliceAngle;
             colorIndex++;
         });
         
         // ç»˜åˆ¶å›¾ä¾‹
         let legendY = 10;
         colorIndex = 0;
         Object.entries(data).forEach(([source, count]) => {
             const percentage = ((count / total) * 100).toFixed(1);
             
             ctx.fillStyle = colors[colorIndex % colors.length];
             ctx.fillRect(canvas.width - 120, legendY, 12, 12);
             
             ctx.fillStyle = '#333';
             ctx.font = '11px Arial';
             ctx.textAlign = 'left';
             ctx.fillText(`${source} (${percentage}%)`, canvas.width - 105, legendY + 9);
             
             legendY += 18;
             colorIndex++;
         });
     }
     
     // ç»˜åˆ¶è½¬åŒ–ç‡æŸ±çŠ¶å›¾
     function drawConversionChart(data) {
         const canvas = document.getElementById('conversionChart');
         const ctx = canvas.getContext('2d');
         
         // æ¸…ç©ºç”»å¸ƒ
         ctx.clearRect(0, 0, canvas.width, canvas.height);
         
         if (data.total === 0) {
             ctx.fillStyle = '#666';
             ctx.font = '14px Arial';
             ctx.textAlign = 'center';
             ctx.fillText('æš‚æ— æ•°æ®', canvas.width / 2, canvas.height / 2);
             return;
         }
         
         const conversionRate = (data.converted / data.total * 100).toFixed(1);
         const pendingRate = (100 - conversionRate).toFixed(1);
         
         const barWidth = 80;
         const maxHeight = canvas.height - 60;
         const spacing = 60;
         
         // ç»˜åˆ¶å·²è½¬åŒ–æŸ±çŠ¶å›¾
         const convertedHeight = (data.converted / data.total) * maxHeight;
         ctx.fillStyle = '#28a745';
         ctx.fillRect(spacing, canvas.height - 40 - convertedHeight, barWidth, convertedHeight);
         
         // ç»˜åˆ¶å¾…è½¬åŒ–æŸ±çŠ¶å›¾
         const pendingCount = data.total - data.converted;
         const pendingHeight = (pendingCount / data.total) * maxHeight;
         ctx.fillStyle = '#ffc107';
         ctx.fillRect(spacing + barWidth + 40, canvas.height - 40 - pendingHeight, barWidth, pendingHeight);
         
         // ç»˜åˆ¶æ ‡ç­¾
         ctx.fillStyle = '#333';
         ctx.font = '12px Arial';
         ctx.textAlign = 'center';
         
         // å·²è½¬åŒ–æ ‡ç­¾
         ctx.fillText('å·²è½¬åŒ–', spacing + barWidth / 2, canvas.height - 20);
         ctx.fillText(`${data.converted}`, spacing + barWidth / 2, canvas.height - 45 - convertedHeight);
         ctx.fillText(`${conversionRate}%`, spacing + barWidth / 2, canvas.height - 5);
         
         // å¾…è½¬åŒ–æ ‡ç­¾
         ctx.fillText('å¾…è½¬åŒ–', spacing + barWidth + 40 + barWidth / 2, canvas.height - 20);
         ctx.fillText(`${pendingCount}`, spacing + barWidth + 40 + barWidth / 2, canvas.height - 45 - pendingHeight);
         ctx.fillText(`${pendingRate}%`, spacing + barWidth + 40 + barWidth / 2, canvas.height - 5);
         
         // ç»˜åˆ¶æ ‡é¢˜
         ctx.font = 'bold 14px Arial';
         ctx.fillText(`æ€»è½¬åŒ–ç‡: ${conversionRate}%`, canvas.width / 2, 20);
     }
});
</script>

<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 15px;
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
}

.stat-card:nth-child(1) .stat-icon { background: #007bff; }
.stat-card:nth-child(2) .stat-icon { background: #28a745; }
.stat-card:nth-child(3) .stat-icon { background: #ffc107; }
.stat-card:nth-child(4) .stat-icon { background: #17a2b8; }

.stat-content h3 {
    margin: 0;
    font-size: 24px;
    font-weight: bold;
    color: #333;
}

.stat-content p {
    margin: 5px 0 0 0;
    color: #666;
    font-size: 14px;
}

.form-section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.charts-section {
    margin-bottom: 30px;
}

.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
}

.chart-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    text-align: center;
}

.chart-card h4 {
    margin: 0 0 15px 0;
    color: #333;
    font-size: 16px;
    font-weight: 600;
}

.chart-card canvas {
    border: 1px solid #eee;
    border-radius: 4px;
    background: #fafafa;
}

.form-section h3 {
    margin: 0 0 20px 0;
    color: #333;
}

.form-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
    margin-bottom: 30px;
}

.input-mode-selector {
    margin-bottom: 25px;
    padding: 20px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    border: 1px solid #dee2e6;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.input-mode-selector h4 {
    margin: 0 0 15px 0;
    color: #495057;
    font-size: 16px;
    font-weight: 600;
}

.mode-options {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.radio-option {
    position: relative;
    cursor: pointer;
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    transition: all 0.3s ease;
    overflow: hidden;
}

.radio-option:hover {
    border-color: #007bff;
    box-shadow: 0 2px 8px rgba(0,123,255,0.15);
    transform: translateY(-1px);
}

.radio-option input[type="radio"] {
    position: absolute;
    top: 12px;
    right: 12px;
    margin: 0;
    accent-color: #007bff;
    transform: scale(1.2);
}

.radio-option input[type="radio"]:checked + .option-content {
    color: #007bff;
}

.radio-option input[type="radio"]:checked {
    background: #007bff;
}

.radio-option:has(input[type="radio"]:checked) {
    border-color: #007bff;
    background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
    box-shadow: 0 2px 8px rgba(0,123,255,0.2);
}

.option-content {
    display: flex;
    flex-direction: column;
    gap: 5px;
    padding-right: 30px;
}

.option-content i {
    font-size: 20px;
    color: #6c757d;
    margin-bottom: 5px;
}

.option-content span {
    font-weight: 600;
    font-size: 14px;
    color: #495057;
}

.option-content small {
    color: #6c757d;
    font-size: 12px;
    line-height: 1.3;
}

.radio-option:has(input[type="radio"]:checked) .option-content i {
    color: #007bff;
}

.radio-option:has(input[type="radio"]:checked) .option-content span {
    color: #007bff;
}

/* é€‰æ‹©å·²æœ‰å­¦å‘˜æ ·å¼ */
.customer-select {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 14px;
    background: white;
    transition: all 0.3s ease;
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 12px center;
    background-repeat: no-repeat;
    background-size: 16px;
    padding-right: 40px;
}

.customer-select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
}

.customer-select option {
    padding: 10px;
    font-size: 14px;
}

.form-help {
    display: block;
    margin-top: 8px;
    color: #6c757d;
    font-size: 12px;
}

.form-help i {
    margin-right: 4px;
    color: #007bff;
}

/* å­¦å‘˜ä¿¡æ¯é¢„è§ˆæ ·å¼ */
.customer-preview {
    margin-top: 20px;
    padding: 16px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px solid #dee2e6;
    border-radius: 8px;
    animation: fadeIn 0.3s ease;
}

.customer-preview h5 {
    margin: 0 0 12px 0;
    color: #495057;
    font-size: 14px;
    font-weight: 600;
}

.customer-preview h5 i {
    margin-right: 6px;
    color: #007bff;
}

.preview-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.preview-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.preview-item label {
    font-weight: 500;
    color: #6c757d;
    font-size: 12px;
    min-width: 40px;
    margin: 0;
}

.preview-item span {
    color: #495057;
    font-size: 13px;
    font-weight: 500;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* æ·»åŠ è¯•å¬è¯¾æŒ‰é’®åŒºåŸŸæ ·å¼ */
.add-trial-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    border: 1px solid #dee2e6;
    margin-bottom: 30px;
}

.add-trial-header h3 {
    margin: 0;
    color: #495057;
    font-size: 18px;
    font-weight: 600;
}

.add-trial-header h3 i {
    margin-right: 8px;
    color: #007bff;
}

/* æ¨¡æ€æ¡†æ ·å¼ */
.modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(3px);
    animation: modalFadeIn 0.3s ease;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: #fff;
    margin: 0;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 25px;
    border-bottom: 1px solid #e9ecef;
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border-radius: 12px 12px 0 0;
}

.modal-header h4 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
}

.modal-header h4 i {
    margin-right: 8px;
}

.close {
    color: white;
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 5px;
    border-radius: 50%;
}

.close:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.1);
}

.modal-body {
    padding: 25px;
}

.form-section-modal {
    margin-bottom: 25px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}

.form-section-modal h5 {
    margin: 0 0 15px 0;
    color: #495057;
    font-size: 16px;
    font-weight: 600;
}

.form-section-modal h5 i {
    margin-right: 8px;
    color: #007bff;
}

/* æ™ºèƒ½è¯†åˆ«åŒºåŸŸæ ·å¼ */
.smart-input-container {
    position: relative;
}

.smart-input-container textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 14px;
    font-family: inherit;
    resize: vertical;
    min-height: 120px;
    transition: all 0.3s ease;
    background: #fff;
}

.smart-input-container textarea:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

.smart-input-container textarea::placeholder {
    color: #6c757d;
    line-height: 1.4;
}

#parseBtn {
    margin-top: 10px;
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

#parseBtn:hover {
    background: linear-gradient(135deg, #138496 0%, #117a8b 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
}

#parseBtn:active {
    transform: translateY(0);
}

.btn-info {
    background: #17a2b8;
    color: white;
}

.modal-form .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
}

.modal-form .form-group {
    display: flex;
    flex-direction: column;
}

.modal-form .form-group:last-child {
    grid-column: 1 / -1;
}

.modal-form label {
    margin-bottom: 5px;
    font-weight: 500;
    color: #495057;
    font-size: 14px;
}

.modal-form input,
.modal-form select {
    padding: 10px 12px;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    font-size: 14px;
    transition: all 0.3s ease;
}

.modal-form input:focus,
.modal-form select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 20px 25px;
    border-top: 1px solid #e9ecef;
    background: #f8f9fa;
    border-radius: 0 0 12px 12px;
}

.btn-secondary {
    background: #6c757d;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-secondary:hover {
    background: #5a6268;
    transform: translateY(-1px);
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-50px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .modal-content {
        width: 95%;
        margin: 5% auto;
    }
    
    .modal-form .form-row {
        grid-template-columns: 1fr;
    }
    
    .add-trial-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
}

.customer-section {
    transition: all 0.3s ease;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    margin-bottom: 5px;
    font-weight: 500;
    color: #333;
}

.form-group input,
.form-group select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

.table-section {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
}

.table-header {
    padding: 20px;
    border-bottom: 1px solid #eee;
}

.table-header h3 {
    margin: 0 0 20px 0;
    color: #333;
}

.search-filter-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
}

.search-box {
    position: relative;
    flex: 1;
    min-width: 250px;
}

.search-input {
    width: 100%;
    padding: 10px 40px 10px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.2s;
}

.search-input:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

.search-icon {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
    pointer-events: none;
}

.filter-controls {
    display: flex;
    gap: 10px;
    align-items: center;
}

.filter-select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    background: white;
    min-width: 120px;
}

.filter-select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

.btn-outline-primary {
    background: transparent;
    color: #007bff;
    border: 1px solid #007bff;
}

.btn-outline-primary:hover {
    background: #007bff;
    color: white;
}

.btn-outline-danger {
    background: transparent;
    color: #dc3545;
    border: 1px solid #dc3545;
}

.btn-outline-danger:hover {
    background: #dc3545;
    color: white;
}

.batch-checkbox,
.row-checkbox {
    cursor: pointer;
    transform: scale(1.2);
}

.data-table th:first-child,
.data-table td:first-child {
    width: 40px;
    text-align: center;
}

.table-container {
    overflow-x: auto;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.data-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #333;
}

.data-table tbody tr:hover {
    background: #f8f9fa;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}

.status-converted {
    background: #d4edda;
    color: #155724;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
}

.status-experience {
    background: #d1ecf1;
    color: #0c5460;
}

.status-no-experience {
    background: #f8d7da;
    color: #721c24;
}

.employee-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
    background: #e3f2fd;
    color: #1565c0;
    border: 1px solid #bbdefb;
}

.action-buttons {
    display: flex;
    gap: 5px;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 14px;
    transition: all 0.2s;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-success:hover {
    background: #1e7e34;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

.btn-warning {
    background: #ffc107;
    color: #212529;
}

.btn-warning:hover {
    background: #e0a800;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 12px;
}

.text-center {
    text-align: center;
}

.text-muted {
    color: #6c757d;
}

#flash-messages {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    transition: opacity 0.3s;
}

.alert {
    padding: 12px 20px;
    border-radius: 4px;
    margin-bottom: 10px;
    font-weight: 500;
}

.alert-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.alert-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

/* çŠ¶æ€ç®¡ç†æ ·å¼ */
.status-management {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.status-select {
    padding: 6px 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 13px;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
}

.status-select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

.status-select:hover {
    border-color: #007bff;
}

.refund-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
    margin-top: 5px;
    padding: 5px;
    background: #fff3cd;
    border-radius: 3px;
    border-left: 3px solid #ffc107;
}

.refund-info small {
    font-size: 11px;
    color: #856404;
    font-weight: 500;
}

/* çŠ¶æ€ç»Ÿè®¡è¯¦æƒ…æ ·å¼ */
.status-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.status-stat-card {
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-left: 4px solid #007bff;
    transition: transform 0.2s, box-shadow 0.2s;
}

.status-stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.status-stat-card.registered {
    border-left-color: #28a745;
}

.status-stat-card.not-registered {
    border-left-color: #6c757d;
}

.status-stat-card.refunded {
    border-left-color: #dc3545;
}

.status-stat-card.converted {
    border-left-color: #007bff;
}

.status-stat-card.no-action {
    border-left-color: #ffc107;
}

.status-stat-card h4 {
    margin: 0 0 10px 0;
    font-size: 14px;
    color: #666;
    font-weight: 600;
}

.status-stat-card .stat-value {
    font-size: 18px;
    font-weight: bold;
    color: #333;
    margin-bottom: 5px;
}

.status-stat-card .stat-details {
    display: flex;
    flex-direction: column;
    gap: 3px;
}

.status-stat-card .stat-details span {
    font-size: 12px;
    color: #666;
}

.status-stat-card .stat-details .positive {
    color: #28a745;
}

.status-stat-card .stat-details .negative {
    color: #dc3545;
}

/* å…¨å®½è¡¨å•ç»„æ ·å¼ */
.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group textarea {
    padding: 10px 12px;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    font-size: 14px;
    font-family: inherit;
    resize: vertical;
    transition: all 0.3s ease;
}

.form-group textarea:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

/* å‘˜å·¥åˆ†é…ä¸‹æ‹‰æ¡†æ ·å¼ */
.employee-select {
    min-width: 100px;
    padding: 2px 8px;
    font-size: 12px;
}

.employee-assign {
    display: flex;
    align-items: center;
    justify-content: center;
}
</style>

<script>
    // ä¸ºç¼–è¾‘è¡¨å•æ·»åŠ æäº¤äº‹ä»¶å¤„ç†å™¨
    document.addEventListener('DOMContentLoaded', function() {
        const editTrialForm = document.getElementById('editTrialForm');
        if (editTrialForm) {
            editTrialForm.addEventListener('submit', function(e) {
                e.preventDefault(); // é˜»æ­¢é»˜è®¤æäº¤
                
                const formData = new FormData(this);
                const courseId = formData.get('course_id');
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¿å­˜ä¸­...';
                submitBtn.disabled = true;
                
                // å‘é€AJAXè¯·æ±‚
                fetch('/trial-courses', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // æ›´æ–°é¡µé¢å†…å®¹
                        updateTrialCourseRow(courseId, formData);
                        updateStatistics();
                        
                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        showAlert('ä¿å­˜æˆåŠŸï¼', 'success');
                        
                        // å…³é—­æ¨¡æ€æ¡†
                        closeEditModal();
                    } else {
                        showAlert(data.message || 'ä¿å­˜å¤±è´¥', 'danger');
                    }
                })
                .catch(error => {
                    console.error('ä¿å­˜å¤±è´¥:', error);
                    showAlert('ä¿å­˜å¤±è´¥ï¼š' + error.message, 'danger');
                })
                .finally(() => {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                });
            });
        }
    });

    // æ›´æ–°è¡¨æ ¼è¡Œæ•°æ®
    function updateTrialCourseRow(courseId, formData) {
        const row = document.querySelector(`tr[data-course-id="${courseId}"]`);
        if (row) {
            // æ›´æ–°å­¦å‘˜å§“å
            const nameCell = row.cells[0];
            if (nameCell) nameCell.textContent = formData.get('customer_name');
            
            // æ›´æ–°æ€§åˆ«
            const genderCell = row.cells[1];
            if (genderCell) genderCell.textContent = formData.get('customer_gender') || '-';
            
            // æ›´æ–°å¹´çº§
            const gradeCell = row.cells[2];
            if (gradeCell) gradeCell.textContent = formData.get('customer_grade') || '-';
            
            // æ›´æ–°åœ°åŒº
            const regionCell = row.cells[3];
            if (regionCell) regionCell.textContent = formData.get('customer_region') || '-';
            
            // æ›´æ–°è¯•å¬è¯¾å”®ä»·
            const priceCell = row.cells[6];
            if (priceCell) priceCell.textContent = 'Â¥' + parseFloat(formData.get('trial_price')).toFixed(2);
            
            // æ›´æ–°æ¸ é“æ¥æº
            const sourceCell = row.cells[7];
            if (sourceCell) sourceCell.textContent = formData.get('source');
        }
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStatistics() {
        // é‡æ–°è®¡ç®—ç»Ÿè®¡æ•°æ®
        const tableRows = document.querySelectorAll('.data-table tbody tr');
        let totalRevenue = 0;
        
        tableRows.forEach(row => {
            if (row.cells.length > 1) {
                const price = parseFloat(row.cells[6].textContent.replace('Â¥', '')) || 0;
                totalRevenue += price;
            }
        });
        
        // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
        const revenueCard = document.querySelector('.stat-card:nth-child(2) h3');
        if (revenueCard) revenueCard.textContent = 'Â¥' + totalRevenue.toFixed(2);
        
        // æ›´æ–°çŠ¶æ€ç»Ÿè®¡
        updateStatusStatistics();
    }

    // æ›´æ–°çŠ¶æ€ç»Ÿè®¡
    function updateStatusStatistics() {
        const tableRows = document.querySelectorAll('.data-table tbody tr');
        const statusStats = {
            'registered': { count: 0, revenue: 0 },
            'not_registered': { count: 0, revenue: 0 },
            'refunded': { count: 0, revenue: 0 },
            'converted': { count: 0, revenue: 0 },
            'no_action': { count: 0, revenue: 0 }
        };
        
        tableRows.forEach(row => {
            if (row.cells.length > 1) {
                const statusSelect = row.cells[10].querySelector('.status-select');
                const price = parseFloat(row.cells[6].textContent.replace('Â¥', '')) || 0;
                
                if (statusSelect) {
                    const status = statusSelect.value;
                    if (statusStats[status]) {
                        statusStats[status].count++;
                        statusStats[status].revenue += price;
                    }
                }
            }
        });
        
        // æ›´æ–°çŠ¶æ€ç»Ÿè®¡æ˜¾ç¤º
        Object.keys(statusStats).forEach(status => {
            const countElement = document.querySelector(`.status-stat-card.${status} .stat-row:nth-child(1) span:last-child`);
            const revenueElement = document.querySelector(`.status-stat-card.${status} .stat-row:nth-child(2) span:last-child`);
            
            if (countElement) countElement.textContent = statusStats[status].count;
            if (revenueElement) revenueElement.textContent = 'Â¥' + statusStats[status].revenue.toFixed(2);
        });
    }

    // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
    function closeEditModal() {
        const modal = document.getElementById('editTrialModal');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    }

    // åˆ†é…å‘˜å·¥
function assignEmployee(courseId, employeeId, forceUpdate = false) {
    // è·å–selectå…ƒç´  - ä¼˜å…ˆä»eventè·å–ï¼Œå¦åˆ™é€šè¿‡courseIdæŸ¥æ‰¾
    let selectElement = null;
    if (typeof event !== 'undefined' && event && event.target) {
        selectElement = event.target;
    } else {
        // æŸ¥æ‰¾å‘˜å·¥åˆ†é…çš„selectå…ƒç´  - éœ€è¦æ›´ç²¾ç¡®çš„é€‰æ‹©å™¨
        selectElement = document.querySelector(`select.employee-select[data-course-id="${courseId}"]`);
    }
    
    // ç¡®ä¿æ‰¾åˆ°äº†selectå…ƒç´ 
    if (!selectElement) {
        console.error(`æ— æ³•æ‰¾åˆ°è¯¾ç¨‹ID ${courseId} çš„å‘˜å·¥é€‰æ‹©æ¡†`);
        showAlert('æ“ä½œå¤±è´¥ï¼šæ— æ³•æ‰¾åˆ°å‘˜å·¥é€‰æ‹©æ¡†', 'danger');
        return;
    }
    
    // ç¡®ä¿æ˜¯selectå…ƒç´ å¹¶ä¸”æœ‰options
    if (!selectElement.tagName || selectElement.tagName.toLowerCase() !== 'select' || !selectElement.options) {
        console.error(`æ‰¾åˆ°çš„å…ƒç´ ä¸æ˜¯æœ‰æ•ˆçš„selectå…ƒç´ `, selectElement);
        showAlert('æ“ä½œå¤±è´¥ï¼šé€‰æ‹©æ¡†æ— æ•ˆ', 'danger');
        return;
    }
    
    // è·å–å‘˜å·¥åç§° - éœ€è¦æ›´å®‰å…¨çš„æ–¹å¼
    let selectedText = "æœªåˆ†é…";
    if (employeeId) {
        // æŸ¥æ‰¾å¯¹åº”çš„option
        const option = Array.from(selectElement.options).find(opt => opt.value === String(employeeId));
        if (option) {
            selectedText = option.text.replace('âœ… ', '').replace('ğŸš« ', '').trim();
        } else {
            // å¦‚æœåœ¨selectä¸­æ‰¾ä¸åˆ°ï¼Œå¯èƒ½æ˜¯å› ä¸ºå‘˜å·¥åˆ—è¡¨ä¸å®Œæ•´
            selectedText = `å‘˜å·¥ID: ${employeeId}`;
        }
    }
    
    const currentText = selectElement.getAttribute('data-original-value') || 
                       (selectElement.options[0].selected ? "æœªåˆ†é…" : selectElement.options[selectElement.selectedIndex].text.replace('âœ… ', '').replace('ğŸš« ', '').trim());
    
    // å¦‚æœä¸æ˜¯å¼ºåˆ¶æ›´æ–°ï¼Œå…ˆç¡®è®¤
    if (!forceUpdate) {
        // æ„å»ºç¡®è®¤æ¶ˆæ¯
        let confirmMessage = '';
        if (employeeId) {
            confirmMessage = `ç¡®å®šè¦å°†è¯¥è¯•å¬è¯¾åˆ†é…ç»™ã€${selectedText}ã€‘å—ï¼Ÿ`;
        } else {
            confirmMessage = `ç¡®å®šè¦å–æ¶ˆè¯¥è¯•å¬è¯¾çš„å‘˜å·¥åˆ†é…å—ï¼Ÿ\nå½“å‰è´Ÿè´£å‘˜å·¥ï¼š${currentText}`;
        }
        
        confirmMessage += '\n\næ³¨æ„ï¼šå¦‚æœè¯¥è¯•å¬è¯¾å·²è½¬åŒ–ä¸ºæ­£è¯¾ï¼Œç›¸å…³çš„æ­£è¯¾å’Œç»­è¯¾ä¹Ÿå°†åŒæ—¶æ›´æ–°ã€‚';
        
        if (!confirm(confirmMessage)) {
            // æ¢å¤åŸé€‰é¡¹
            location.reload();
            return;
        }
    }
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    selectElement.disabled = true;
    
    fetch(`/api/trial-courses/${courseId}/assign`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            employee_id: employeeId || null,
            force_update: forceUpdate
        })
    })
    .then(response => {
        if (response.status === 409) {
            // å¤„ç†å†²çªæƒ…å†µ
            return response.json().then(data => {
                handleAssignmentConflict(courseId, employeeId, data);
                selectElement.disabled = false;
            });
        }
        return response.json();
    })
    .then(data => {
        if (data && data.success) {
            showAlert(data.message || 'åˆ†é…æˆåŠŸ', 'success');
            // æ˜¾ç¤ºæ›´æ–°è¯¦æƒ…
            if (data.details && data.details.updated_courses_count > 1) {
                showAlert(`å…±æ›´æ–°äº† ${data.details.updated_courses_count} ä¸ªç›¸å…³è¯¾ç¨‹`, 'info');
            }
            // æ›´æ–°åŸå§‹å€¼å±æ€§
            selectElement.setAttribute('data-original-value', selectedText);
            selectElement.disabled = false;
            
            // å¦‚æœè§£å†³äº†å†²çªï¼Œåˆ·æ–°é¡µé¢
            if (data.details && data.details.resolved_conflict) {
                setTimeout(() => location.reload(), 1500);
            }
        } else if (data && !data.conflict) {
            showAlert(data.message || 'åˆ†é…å¤±è´¥', 'danger');
            location.reload();
        }
    })
    .catch(error => {
        showAlert('åˆ†é…å¤±è´¥ï¼š' + error.message, 'danger');
        location.reload();
    });
}

// å¤„ç†å‘˜å·¥åˆ†é…å†²çª
function handleAssignmentConflict(courseId, newEmployeeId, conflictData) {
    const message = conflictData.conflict_info.message;
    
    // è·å–æ–°å‘˜å·¥åç§° - ä»å½“å‰é¡µé¢çš„å‘˜å·¥åˆ—è¡¨ä¸­æŸ¥æ‰¾
    let newEmployeeName = "æœªçŸ¥å‘˜å·¥";
    if (newEmployeeId) {
        // å°è¯•ä»ä»»æ„ä¸€ä¸ªå‘˜å·¥selectä¸­æ‰¾åˆ°å‘˜å·¥åç§°
        const anyEmployeeSelect = document.querySelector('select.employee-select');
        if (anyEmployeeSelect && anyEmployeeSelect.options) {
            const option = Array.from(anyEmployeeSelect.options).find(opt => opt.value === String(newEmployeeId));
            if (option) {
                newEmployeeName = option.text.replace('âœ… ', '').replace('ğŸš« ', '').trim();
            }
        }
    }
    
    // ä¿å­˜å¿…è¦ä¿¡æ¯åˆ°å¯¹è¯æ¡†å…ƒç´ ä¸Š
    const dialogId = 'conflictDialog';
    
    // åˆ›å»ºå†²çªè§£å†³å¯¹è¯æ¡†
    const dialog = `
        <div id="${dialogId}" 
             data-course-id="${courseId}" 
             data-employee-id="${newEmployeeId || ''}"
             data-employee-name="${newEmployeeName}"
             style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                    background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    z-index: 1000; min-width: 400px; max-width: 500px;">
            <h4 style="color: #ff6b6b; margin-bottom: 15px;">
                <i class="fas fa-exclamation-triangle"></i> å‘ç°æ•°æ®ä¸ä¸€è‡´
            </h4>
            <p style="margin-bottom: 15px;">${message}</p>
            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                <small>
                    <strong>è¯´æ˜ï¼š</strong>è¿™ä¸ªè¯•å¬è¯¾å¯¹åº”çš„æ­£è¯¾å·²ç»åˆ†é…ç»™äº†å…¶ä»–å‘˜å·¥ã€‚
                    è¿™å¯èƒ½æ˜¯å†å²æ•°æ®å¯¼è‡´çš„ã€‚æ‚¨å¯ä»¥é€‰æ‹©ï¼š
                </small>
            </div>
            <div style="text-align: right;">
                <button onclick="closeConflictDialog()" class="btn btn-secondary" style="margin-right: 10px;">
                    ä¿æŒç°çŠ¶
                </button>
                <button onclick="forceAssignEmployeeFromDialog()" class="btn btn-warning">
                    <i class="fas fa-sync"></i> ç»Ÿä¸€æ›´æ–°ä¸ºæ–°å‘˜å·¥
                </button>
            </div>
        </div>
        <div id="conflictOverlay" onclick="closeConflictDialog()" 
             style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                    background: rgba(0,0,0,0.5); z-index: 999;"></div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', dialog);
}

// å…³é—­å†²çªå¯¹è¯æ¡†
function closeConflictDialog() {
    const overlay = document.getElementById('conflictOverlay');
    const dialog = document.getElementById('conflictDialog');
    if (overlay) overlay.remove();
    if (dialog) dialog.remove();
}

// å¼ºåˆ¶åˆ†é…å‘˜å·¥ï¼ˆè§£å†³å†²çªï¼‰
function forceAssignEmployee(courseId, employeeId) {
    closeConflictDialog();
    assignEmployee(courseId, employeeId, true);
}

// ä»å¯¹è¯æ¡†è§¦å‘å¼ºåˆ¶åˆ†é…
function forceAssignEmployeeFromDialog() {
    const dialog = document.getElementById('conflictDialog');
    if (!dialog) {
        console.error('æ— æ³•æ‰¾åˆ°å†²çªå¯¹è¯æ¡†');
        return;
    }
    
    const courseId = dialog.getAttribute('data-course-id');
    const employeeId = dialog.getAttribute('data-employee-id') || null;
    const employeeName = dialog.getAttribute('data-employee-name');
    
    console.log(`å¼ºåˆ¶åˆ†é…: è¯¾ç¨‹ID=${courseId}, å‘˜å·¥ID=${employeeId}, å‘˜å·¥åç§°=${employeeName}`);
    
    closeConflictDialog();
    
    // ç›´æ¥å‘é€è¯·æ±‚ï¼Œé¿å…å†æ¬¡æŸ¥æ‰¾DOMå…ƒç´ 
    fetch(`/api/trial-courses/${courseId}/assign`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            employee_id: employeeId || null,
            force_update: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data && data.success) {
            showAlert(data.message || 'åˆ†é…æˆåŠŸ', 'success');
            // æ˜¾ç¤ºæ›´æ–°è¯¦æƒ…
            if (data.details && data.details.updated_courses_count > 1) {
                showAlert(`å…±æ›´æ–°äº† ${data.details.updated_courses_count} ä¸ªç›¸å…³è¯¾ç¨‹`, 'info');
            }
            // åˆ·æ–°é¡µé¢
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert(data.message || 'åˆ†é…å¤±è´¥', 'danger');
            location.reload();
        }
    })
    .catch(error => {
        showAlert('åˆ†é…å¤±è´¥ï¼š' + error.message, 'danger');
        location.reload();
    });
}

// æ˜¾ç¤ºæç¤ºä¿¡æ¯
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => alertDiv.remove(), 3000);
}

// ========== æ‰¹é‡æ“ä½œåŠŸèƒ½ ==========
let selectedCourses = new Set();

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.course-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
        if (selectAll.checked) {
            selectedCourses.add(checkbox.value);
        } else {
            selectedCourses.delete(checkbox.value);
        }
    });
    
    updateSelection();
}

function updateSelection() {
    selectedCourses.clear();
    const checkboxes = document.querySelectorAll('.course-checkbox:checked');
    
    checkboxes.forEach(checkbox => {
        selectedCourses.add(checkbox.value);
    });
    
    const count = selectedCourses.size;
    document.getElementById('selectedCount').textContent = count;
    document.getElementById('batchOperations').style.display = count > 0 ? 'block' : 'none';
    
    // æ›´æ–°å…¨é€‰æ¡†çŠ¶æ€
    const allCheckboxes = document.querySelectorAll('.course-checkbox');
    const selectAll = document.getElementById('selectAll');
    selectAll.checked = count > 0 && count === allCheckboxes.length;
    selectAll.indeterminate = count > 0 && count < allCheckboxes.length;
}

function clearSelection() {
    selectedCourses.clear();
    document.querySelectorAll('.course-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    document.getElementById('selectAll').checked = false;
    updateSelection();
}

function batchAssignEmployee() {
    if (selectedCourses.size === 0) return;
    
    // åˆ›å»ºå‘˜å·¥é€‰æ‹©å¯¹è¯æ¡†
    const employees = [
        {% for employee in employees %}
        {id: {{ employee.id }}, name: '{{ employee.name }}'},
        {% endfor %}
    ];
    
    let options = employees.map(emp => 
        `<option value="${emp.id}">${emp.name}</option>`
    ).join('');
    
    const dialog = `
        <div id="batchAssignDialog" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                    background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    z-index: 1000; min-width: 300px;">
            <h4>æ‰¹é‡åˆ†é…å‘˜å·¥</h4>
            <p>å°†é€‰ä¸­çš„ ${selectedCourses.size} ä¸ªè¯•å¬è¯¾åˆ†é…ç»™ï¼š</p>
            <select id="batchEmployeeSelect" class="form-control">
                <option value="">é€‰æ‹©å‘˜å·¥</option>
                ${options}
            </select>
            <div style="margin-top: 15px; text-align: right;">
                <button onclick="closeBatchDialog()" class="btn btn-secondary" style="margin-right: 10px;">å–æ¶ˆ</button>
                <button onclick="confirmBatchAssign()" class="btn btn-primary">ç¡®è®¤åˆ†é…</button>
            </div>
        </div>
        <div id="dialogOverlay" onclick="closeBatchDialog()" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                                       background: rgba(0,0,0,0.5); z-index: 999;"></div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', dialog);
}

function batchUnassign() {
    if (selectedCourses.size === 0) return;
    
    if (!confirm(`ç¡®å®šè¦å–æ¶ˆè¿™ ${selectedCourses.size} ä¸ªè¯•å¬è¯¾çš„å‘˜å·¥åˆ†é…å—ï¼Ÿ\n\næ³¨æ„ï¼šç›¸å…³çš„æ­£è¯¾å’Œç»­è¯¾ä¹Ÿå°†åŒæ—¶å–æ¶ˆåˆ†é…ã€‚`)) {
        return;
    }
    
    processBatchUpdate(null);
}

function closeBatchDialog() {
    const overlay = document.getElementById('dialogOverlay');
    const dialog = document.getElementById('batchAssignDialog');
    if (overlay) overlay.remove();
    if (dialog) dialog.remove();
}

function confirmBatchAssign() {
    const employeeId = document.getElementById('batchEmployeeSelect').value;
    if (!employeeId) {
        alert('è¯·é€‰æ‹©å‘˜å·¥');
        return;
    }
    
    closeBatchDialog();
    processBatchUpdate(employeeId);
}

function processBatchUpdate(employeeId) {
    const courseIds = Array.from(selectedCourses);
    let completed = 0;
    let failed = 0;
    
    // æ˜¾ç¤ºè¿›åº¦
    showAlert(`æ­£åœ¨å¤„ç† ${courseIds.length} ä¸ªè¯•å¬è¯¾...`, 'info');
    
    // ä¾æ¬¡å¤„ç†æ¯ä¸ªè¯¾ç¨‹
    courseIds.forEach((courseId, index) => {
        setTimeout(() => {
            fetch(`/api/trial-courses/${courseId}/assign`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({employee_id: employeeId || null})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    completed++;
                } else {
                    failed++;
                }
                
                // å¤„ç†å®Œæˆ
                if (completed + failed === courseIds.length) {
                    if (failed === 0) {
                        showAlert(`æˆåŠŸå¤„ç† ${completed} ä¸ªè¯•å¬è¯¾`, 'success');
                    } else {
                        showAlert(`å¤„ç†å®Œæˆï¼šæˆåŠŸ ${completed} ä¸ªï¼Œå¤±è´¥ ${failed} ä¸ª`, 'warning');
                    }
                    
                    // åˆ·æ–°é¡µé¢
                    setTimeout(() => location.reload(), 1500);
                }
            })
            .catch(error => {
                failed++;
                if (completed + failed === courseIds.length) {
                    showAlert(`å¤„ç†å‡ºé”™ï¼Œè¯·é‡è¯•`, 'danger');
                }
            });
        }, index * 100); // æ¯ä¸ªè¯·æ±‚é—´éš”100msï¼Œé¿å…å¹¶å‘è¿‡å¤š
    });
}
</script>

<!-- å¼•å…¥å­¦å‘˜è¯¦æƒ…æ¨¡æ€æ¡† -->
{% include 'components/customer_detail_modal.html' %}

{% endblock %}