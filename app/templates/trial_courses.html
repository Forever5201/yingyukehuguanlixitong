{% extends "base.html" %}

{% block title %}试听课管理 - 客户管理系统{% endblock %}
{% block page_title %}试听课管理{% endblock %}

{% block content %}
<div class="page-container">
    <!-- 统计卡片 -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-play-circle"></i>
            </div>
            <div class="stat-content">
                <h3>{{ stats.total_trials }}</h3>
                <p>试听课总数</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-money-bill-wave"></i>
            </div>
            <div class="stat-content">
                <h3>¥{{ "%.2f"|format(stats.total_revenue) }}</h3>
                <p>总收入</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-coins"></i>
            </div>
            <div class="stat-content">
                <h3>¥{{ "%.2f"|format(stats.total_cost) }}</h3>
                <p>总成本</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-content">
                <h3>¥{{ "%.2f"|format(stats.total_profit) }}</h3>
                <p>总利润</p>
            </div>
        </div>
    </div>

    <!-- 添加试听课表单 -->
    <div class="form-section">
        <h3><i class="fas fa-plus"></i> 添加试听课记录</h3>
        
        <!-- 选择录入方式 -->
        <div class="input-mode-selector">
            <h4><i class="fas fa-user-plus"></i> 录入方式</h4>
            <div class="mode-options">
                <label class="radio-option">
                    <input type="radio" name="input_mode" value="existing" checked>
                    <div class="option-content">
                        <i class="fas fa-users"></i>
                        <span>选择已有学员</span>
                        <small>从现有学员中选择</small>
                    </div>
                </label>
                <label class="radio-option">
                    <input type="radio" name="input_mode" value="new">
                    <div class="option-content">
                        <i class="fas fa-user-plus"></i>
                        <span>录入新学员</span>
                        <small>添加新的学员信息</small>
                    </div>
                </label>
            </div>
        </div>
        
        <form method="POST" class="form-grid">
            <!-- 选择已有学员 -->
            <div id="existing-customer-section" class="customer-section">
                <div class="form-group">
                    <label for="customer_id">
                        <i class="fas fa-user"></i> 选择学员 *
                    </label>
                    <select name="customer_id" id="customer_id" class="customer-select">
                        <option value="">请选择学员...</option>
                        {% for customer in customers %}
                        <option value="{{ customer.id }}" 
                                data-name="{{ customer.name }}" 
                                data-phone="{{ customer.phone }}"
                                data-grade="{{ customer.grade or '' }}"
                                data-region="{{ customer.region or '' }}">
                            {{ customer.name }} - {{ customer.phone }}
                            {% if customer.grade %} ({{ customer.grade }}){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <small class="form-help">
                        <i class="fas fa-info-circle"></i> 
                        共有 {{ customers|length }} 位学员可选择
                    </small>
                </div>
                
                <!-- 选中学员信息预览 -->
                <div id="customer-preview" class="customer-preview" style="display: none;">
                    <h5><i class="fas fa-eye"></i> 学员信息预览</h5>
                    <div class="preview-grid">
                        <div class="preview-item">
                            <label>姓名：</label>
                            <span id="preview-name">-</span>
                        </div>
                        <div class="preview-item">
                            <label>电话：</label>
                            <span id="preview-phone">-</span>
                        </div>
                        <div class="preview-item">
                            <label>年级：</label>
                            <span id="preview-grade">-</span>
                        </div>
                        <div class="preview-item">
                            <label>地区：</label>
                            <span id="preview-region">-</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 录入新学员 -->
            <div id="new-customer-section" class="customer-section" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label for="new_customer_name">学员姓名 *</label>
                        <input type="text" name="new_customer_name" id="new_customer_name" placeholder="请输入学员姓名">
                    </div>
                    <div class="form-group">
                        <label for="new_customer_phone">联系电话 *</label>
                        <input type="tel" name="new_customer_phone" id="new_customer_phone" placeholder="请输入联系电话">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="new_customer_gender">性别</label>
                        <select name="new_customer_gender" id="new_customer_gender">
                            <option value="">请选择</option>
                            <option value="男">男</option>
                            <option value="女">女</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="new_customer_grade">年级</label>
                        <select name="new_customer_grade" id="new_customer_grade">
                            <option value="">请选择</option>
                            <option value="一年级">一年级</option>
                            <option value="二年级">二年级</option>
                            <option value="三年级">三年级</option>
                            <option value="四年级">四年级</option>
                            <option value="五年级">五年级</option>
                            <option value="六年级">六年级</option>
                            <option value="初一">初一</option>
                            <option value="初二">初二</option>
                            <option value="初三">初三</option>
                            <option value="高一">高一</option>
                            <option value="高二">高二</option>
                            <option value="高三">高三</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="new_customer_region">地区</label>
                        <input type="text" name="new_customer_region" id="new_customer_region" placeholder="请输入地区">
                    </div>
                </div>
            </div>
            
            <!-- 试听课信息 -->
            <div class="form-row">
                <div class="form-group">
                    <label for="trial_price">试听课售价 *</label>
                    <input type="number" name="trial_price" id="trial_price" step="0.01" min="0" required>
                </div>
                
                <div class="form-group">
                    <label for="source">渠道来源 *</label>
                    <select name="source" id="source" required>
                        <option value="">请选择渠道</option>
                        <option value="淘宝">淘宝</option>
                        <option value="视频号">视频号</option>
                        <option value="抖音">抖音</option>
                        <option value="小红书">小红书</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus"></i> 添加试听课
                </button>
            </div>
        </form>
    </div>

    <!-- 数据统计图表 -->
    <div class="charts-section">
        <div class="charts-grid">
            <div class="chart-card">
                <h4><i class="fas fa-chart-pie"></i> 渠道来源分布</h4>
                <canvas id="sourceChart" width="300" height="200"></canvas>
            </div>
            <div class="chart-card">
                <h4><i class="fas fa-chart-bar"></i> 转化率统计</h4>
                <canvas id="conversionChart" width="300" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- 试听课列表 -->
    <div class="table-section">
        <div class="table-header">
            <h3><i class="fas fa-list"></i> 试听课记录</h3>
            
            <!-- 搜索和筛选 -->
            <div class="search-filter-section">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="搜索学员姓名或电话..." class="search-input">
                    <i class="fas fa-search search-icon"></i>
                </div>
                
                <div class="filter-controls">
                    <select id="sourceFilter" class="filter-select">
                        <option value="">全部渠道</option>
                        <option value="淘宝">淘宝</option>
                        <option value="视频号">视频号</option>
                        <option value="抖音">抖音</option>
                        <option value="小红书">小红书</option>
                        <option value="其他">其他</option>
                    </select>
                    
                    <select id="statusFilter" class="filter-select">
                        <option value="">全部状态</option>
                        <option value="pending">待转化</option>
                        <option value="converted">已转正课</option>
                    </select>
                    
                    <button id="exportBtn" class="btn btn-outline-primary">
                        <i class="fas fa-download"></i> 导出数据
                    </button>
                    
                    <button id="batchDeleteBtn" class="btn btn-outline-danger" style="display: none;">
                        <i class="fas fa-trash"></i> 批量删除
                    </button>
                </div>
            </div>
        </div>
        
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAll" class="batch-checkbox">
                        </th>
                        <th>学员姓名</th>
                        <th>性别</th>
                        <th>年级</th>
                        <th>地区</th>
                        <th>联系方式</th>
                        <th>试听课售价</th>
                        <th>渠道来源</th>
                        <th>报名时间</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for course, customer in trial_courses %}
                    <tr>
                        <td>
                            <input type="checkbox" class="row-checkbox" data-course-id="{{ course.id }}">
                        </td>
                        <td>{{ customer.name }}</td>
                        <td>{{ customer.gender or '-' }}</td>
                        <td>{{ customer.grade or '-' }}</td>
                        <td>{{ customer.region or '-' }}</td>
                        <td>{{ customer.phone }}</td>
                        <td>¥{{ "%.2f"|format(course.trial_price) }}</td>
                        <td>{{ course.source or '-' }}</td>
                        <td>{{ course.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            {% if course.converted_to_course %}
                                <span class="status-badge status-converted">已转正课</span>
                            {% else %}
                                <span class="status-badge status-pending">待转化</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="action-buttons">
                                {% if not course.converted_to_course %}
                                <a href="{{ url_for('convert_trial_to_course', trial_id=course.id) }}" 
                                   class="btn btn-sm btn-success" title="转正课">
                                    <i class="fas fa-arrow-right"></i>
                                </a>
                                <button onclick="deleteTrialCourse({{ course.id }})" 
                                        class="btn btn-sm btn-danger" title="删除">
                                    <i class="fas fa-trash"></i>
                                </button>
                                {% else %}
                                <span class="text-muted">已转化</span>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="11" class="text-center">暂无试听课记录</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 消息提示 -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div id="flash-messages">
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<script>
// 删除试听课记录
function deleteTrialCourse(courseId) {
    if (confirm('确定要删除这条试听课记录吗？')) {
        fetch(`/api/trial-courses/${courseId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || '删除失败');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('删除失败');
        });
    }
}

// 页面加载完成后执行
document.addEventListener('DOMContentLoaded', function() {
    console.log('试听课管理页面加载完成');
    
    // 处理录入方式切换
    const inputModeRadios = document.querySelectorAll('input[name="input_mode"]');
    const existingSection = document.getElementById('existing-customer-section');
    const newSection = document.getElementById('new-customer-section');
    const customerSelect = document.getElementById('customer_id');
    const customerPreview = document.getElementById('customer-preview');
    const newCustomerInputs = newSection.querySelectorAll('input[required], select[required]');
    
    inputModeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'existing') {
                existingSection.style.display = 'block';
                newSection.style.display = 'none';
                customerSelect.required = true;
                // 移除新客户字段的必填要求
                newCustomerInputs.forEach(input => {
                    input.required = false;
                });
            } else {
                existingSection.style.display = 'none';
                newSection.style.display = 'block';
                customerPreview.style.display = 'none';
                customerSelect.required = false;
                customerSelect.value = '';
                // 添加新客户字段的必填要求
                document.getElementById('new_customer_name').required = true;
                document.getElementById('new_customer_phone').required = true;
            }
        });
    });
    
    // 学员选择变化处理
    customerSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        
        if (this.value && selectedOption.dataset.name) {
            // 显示学员信息预览
            document.getElementById('preview-name').textContent = selectedOption.dataset.name || '-';
            document.getElementById('preview-phone').textContent = selectedOption.dataset.phone || '-';
            document.getElementById('preview-grade').textContent = selectedOption.dataset.grade || '-';
            document.getElementById('preview-region').textContent = selectedOption.dataset.region || '-';
            
            customerPreview.style.display = 'block';
        } else {
            customerPreview.style.display = 'none';
        }
    });
    
    // 表单提交验证
    const form = document.querySelector('.form-grid');
    form.addEventListener('submit', function(e) {
        const inputMode = document.querySelector('input[name="input_mode"]:checked').value;
        
        if (inputMode === 'existing') {
            if (!customerSelect.value) {
                e.preventDefault();
                alert('请选择学员');
                return;
            }
        } else {
            const name = document.getElementById('new_customer_name').value.trim();
            const phone = document.getElementById('new_customer_phone').value.trim();
            
            if (!name) {
                e.preventDefault();
                alert('请输入学员姓名');
                return;
            }
            
            if (!phone) {
                e.preventDefault();
                alert('请输入联系电话');
                return;
            }
            
            // 验证手机号格式
            const phoneRegex = /^1[3-9]\d{9}$/;
            if (!phoneRegex.test(phone)) {
                e.preventDefault();
                alert('请输入正确的手机号码');
                return;
            }
        }
    });
    
    // 自动隐藏消息提示
    const flashMessages = document.getElementById('flash-messages');
    if (flashMessages) {
        setTimeout(() => {
            flashMessages.style.opacity = '0';
            setTimeout(() => {
                flashMessages.remove();
            }, 300);
        }, 3000);
    }
    
    // 搜索和筛选功能
    const searchInput = document.getElementById('searchInput');
    const sourceFilter = document.getElementById('sourceFilter');
    const statusFilter = document.getElementById('statusFilter');
    const exportBtn = document.getElementById('exportBtn');
    const batchDeleteBtn = document.getElementById('batchDeleteBtn');
    const selectAllCheckbox = document.getElementById('selectAll');
    const rowCheckboxes = document.querySelectorAll('.row-checkbox');
    const tableRows = document.querySelectorAll('.data-table tbody tr');
    
    // 初始化图表
    initCharts();
    
    // 搜索功能
    function filterTable() {
        const searchTerm = searchInput.value.toLowerCase();
        const sourceValue = sourceFilter.value;
        const statusValue = statusFilter.value;
        
        tableRows.forEach(row => {
             if (row.cells.length === 1) return; // 跳过"暂无记录"行
             
             const name = row.cells[1].textContent.toLowerCase(); // 调整索引
             const phone = row.cells[5].textContent.toLowerCase(); // 调整索引
             const source = row.cells[7].textContent; // 调整索引
             const statusElement = row.cells[9].querySelector('.status-badge'); // 调整索引
             const status = statusElement ? (statusElement.classList.contains('status-converted') ? 'converted' : 'pending') : '';
            
            const matchesSearch = name.includes(searchTerm) || phone.includes(searchTerm);
            const matchesSource = !sourceValue || source === sourceValue;
            const matchesStatus = !statusValue || status === statusValue;
            
            if (matchesSearch && matchesSource && matchesStatus) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
        
        // 更新统计信息和图表
        updateFilterStats();
        updateChartsWithFilteredData();
    }
    
    // 更新筛选后的统计信息
    function updateFilterStats() {
        const visibleRows = Array.from(tableRows).filter(row => 
            row.style.display !== 'none' && row.cells.length > 1
        );
        
        let totalPrice = 0;
        visibleRows.forEach(row => {
             const priceText = row.cells[6].textContent.replace('¥', ''); // 调整索引
             totalPrice += parseFloat(priceText) || 0;
         });
        
        // 可以在这里添加显示筛选后统计信息的逻辑
        console.log(`筛选后记录数: ${visibleRows.length}, 总金额: ¥${totalPrice.toFixed(2)}`);
    }
    
    // 绑定事件
    searchInput.addEventListener('input', filterTable);
    sourceFilter.addEventListener('change', filterTable);
    statusFilter.addEventListener('change', filterTable);
    
    // 导出功能
    exportBtn.addEventListener('click', function() {
        const visibleRows = Array.from(tableRows).filter(row => 
            row.style.display !== 'none' && row.cells.length > 1
        );
        
        if (visibleRows.length === 0) {
            alert('没有数据可导出');
            return;
        }
        
        // 构建CSV数据
        let csvContent = '学员姓名,性别,年级,地区,联系方式,试听课售价,渠道来源,报名时间,状态\n';
        
        visibleRows.forEach(row => {
             const cells = Array.from(row.cells).slice(1, 10); // 排除复选框列和操作列
            const rowData = cells.map(cell => {
                let text = cell.textContent.trim();
                // 处理状态列
                if (cell.querySelector('.status-badge')) {
                    text = cell.querySelector('.status-badge').textContent.trim();
                }
                // 转义CSV特殊字符
                if (text.includes(',') || text.includes('"') || text.includes('\n')) {
                    text = '"' + text.replace(/"/g, '""') + '"';
                }
                return text;
            });
            csvContent += rowData.join(',') + '\n';
        });
        
        // 下载文件
        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `试听课记录_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
         document.body.removeChild(link);
     });
     
     // 批量操作功能
     function updateBatchDeleteButton() {
         const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
         if (checkedBoxes.length > 0) {
             batchDeleteBtn.style.display = 'inline-flex';
             batchDeleteBtn.textContent = `批量删除 (${checkedBoxes.length})`;
         } else {
             batchDeleteBtn.style.display = 'none';
         }
     }
     
     // 全选/取消全选
     selectAllCheckbox.addEventListener('change', function() {
         const visibleCheckboxes = Array.from(rowCheckboxes).filter(checkbox => {
             const row = checkbox.closest('tr');
             return row.style.display !== 'none';
         });
         
         visibleCheckboxes.forEach(checkbox => {
             checkbox.checked = this.checked;
         });
         
         updateBatchDeleteButton();
     });
     
     // 单个复选框变化
     rowCheckboxes.forEach(checkbox => {
         checkbox.addEventListener('change', function() {
             updateBatchDeleteButton();
             
             // 更新全选状态
             const visibleCheckboxes = Array.from(rowCheckboxes).filter(checkbox => {
                 const row = checkbox.closest('tr');
                 return row.style.display !== 'none';
             });
             
             const checkedCount = visibleCheckboxes.filter(cb => cb.checked).length;
             selectAllCheckbox.checked = checkedCount === visibleCheckboxes.length && visibleCheckboxes.length > 0;
             selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < visibleCheckboxes.length;
         });
     });
     
     // 批量删除
     batchDeleteBtn.addEventListener('click', function() {
         const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
         const courseIds = Array.from(checkedBoxes).map(checkbox => checkbox.dataset.courseId);
         
         if (courseIds.length === 0) {
             alert('请选择要删除的记录');
             return;
         }
         
         if (confirm(`确定要删除选中的 ${courseIds.length} 条试听课记录吗？`)) {
             // 批量删除API调用
             Promise.all(courseIds.map(id => 
                 fetch(`/api/trial-courses/${id}`, {
                     method: 'DELETE',
                     headers: {
                         'Content-Type': 'application/json',
                     }
                 })
             )).then(responses => {
                 const allSuccessful = responses.every(response => response.ok);
                 if (allSuccessful) {
                     location.reload();
                 } else {
                     alert('部分删除失败，请刷新页面查看结果');
                 }
             }).catch(error => {
                 console.error('Error:', error);
                 alert('批量删除失败');
             });
         }
     });
     
     // 根据筛选结果更新图表
      function updateChartsWithFilteredData() {
          const visibleRows = Array.from(tableRows).filter(row => 
              row.style.display !== 'none' && row.cells.length > 1
          );
          
          const sourceData = {};
          const conversionData = { total: 0, converted: 0 };
          
          visibleRows.forEach(row => {
              const source = row.cells[7].textContent.trim();
              const statusElement = row.cells[9].querySelector('.status-badge');
              const isConverted = statusElement && statusElement.classList.contains('status-converted');
              
              // 统计渠道来源
              sourceData[source] = (sourceData[source] || 0) + 1;
              
              // 统计转化率
              conversionData.total++;
              if (isConverted) {
                  conversionData.converted++;
              }
          });
          
          // 重新绘制图表
          drawSourceChart(sourceData);
          drawConversionChart(conversionData);
      }
      
      // 图表初始化函数
      function initCharts() {
         // 统计数据
         const sourceData = {};
         const conversionData = { total: 0, converted: 0 };
         
         tableRows.forEach(row => {
             if (row.cells.length === 1) return; // 跳过"暂无记录"行
             
             const source = row.cells[7].textContent.trim();
             const statusElement = row.cells[9].querySelector('.status-badge');
             const isConverted = statusElement && statusElement.classList.contains('status-converted');
             
             // 统计渠道来源
             sourceData[source] = (sourceData[source] || 0) + 1;
             
             // 统计转化率
             conversionData.total++;
             if (isConverted) {
                 conversionData.converted++;
             }
         });
         
         // 绘制渠道来源饼图
         drawSourceChart(sourceData);
         
         // 绘制转化率柱状图
         drawConversionChart(conversionData);
     }
     
     // 绘制渠道来源饼图
     function drawSourceChart(data) {
         const canvas = document.getElementById('sourceChart');
         const ctx = canvas.getContext('2d');
         const centerX = canvas.width / 2;
         const centerY = canvas.height / 2;
         const radius = Math.min(centerX, centerY) - 20;
         
         // 清空画布
         ctx.clearRect(0, 0, canvas.width, canvas.height);
         
         if (Object.keys(data).length === 0) {
             ctx.fillStyle = '#666';
             ctx.font = '14px Arial';
             ctx.textAlign = 'center';
             ctx.fillText('暂无数据', centerX, centerY);
             return;
         }
         
         const total = Object.values(data).reduce((sum, val) => sum + val, 0);
         const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14'];
         
         let currentAngle = -Math.PI / 2;
         let colorIndex = 0;
         
         // 绘制饼图
         Object.entries(data).forEach(([source, count]) => {
             const sliceAngle = (count / total) * 2 * Math.PI;
             
             ctx.beginPath();
             ctx.moveTo(centerX, centerY);
             ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
             ctx.closePath();
             ctx.fillStyle = colors[colorIndex % colors.length];
             ctx.fill();
             
             // 绘制标签
             const labelAngle = currentAngle + sliceAngle / 2;
             const labelX = centerX + Math.cos(labelAngle) * (radius * 0.7);
             const labelY = centerY + Math.sin(labelAngle) * (radius * 0.7);
             
             ctx.fillStyle = 'white';
             ctx.font = 'bold 12px Arial';
             ctx.textAlign = 'center';
             ctx.fillText(`${count}`, labelX, labelY);
             
             currentAngle += sliceAngle;
             colorIndex++;
         });
         
         // 绘制图例
         let legendY = 10;
         colorIndex = 0;
         Object.entries(data).forEach(([source, count]) => {
             const percentage = ((count / total) * 100).toFixed(1);
             
             ctx.fillStyle = colors[colorIndex % colors.length];
             ctx.fillRect(canvas.width - 120, legendY, 12, 12);
             
             ctx.fillStyle = '#333';
             ctx.font = '11px Arial';
             ctx.textAlign = 'left';
             ctx.fillText(`${source} (${percentage}%)`, canvas.width - 105, legendY + 9);
             
             legendY += 18;
             colorIndex++;
         });
     }
     
     // 绘制转化率柱状图
     function drawConversionChart(data) {
         const canvas = document.getElementById('conversionChart');
         const ctx = canvas.getContext('2d');
         
         // 清空画布
         ctx.clearRect(0, 0, canvas.width, canvas.height);
         
         if (data.total === 0) {
             ctx.fillStyle = '#666';
             ctx.font = '14px Arial';
             ctx.textAlign = 'center';
             ctx.fillText('暂无数据', canvas.width / 2, canvas.height / 2);
             return;
         }
         
         const conversionRate = (data.converted / data.total * 100).toFixed(1);
         const pendingRate = (100 - conversionRate).toFixed(1);
         
         const barWidth = 80;
         const maxHeight = canvas.height - 60;
         const spacing = 60;
         
         // 绘制已转化柱状图
         const convertedHeight = (data.converted / data.total) * maxHeight;
         ctx.fillStyle = '#28a745';
         ctx.fillRect(spacing, canvas.height - 40 - convertedHeight, barWidth, convertedHeight);
         
         // 绘制待转化柱状图
         const pendingCount = data.total - data.converted;
         const pendingHeight = (pendingCount / data.total) * maxHeight;
         ctx.fillStyle = '#ffc107';
         ctx.fillRect(spacing + barWidth + 40, canvas.height - 40 - pendingHeight, barWidth, pendingHeight);
         
         // 绘制标签
         ctx.fillStyle = '#333';
         ctx.font = '12px Arial';
         ctx.textAlign = 'center';
         
         // 已转化标签
         ctx.fillText('已转化', spacing + barWidth / 2, canvas.height - 20);
         ctx.fillText(`${data.converted}`, spacing + barWidth / 2, canvas.height - 45 - convertedHeight);
         ctx.fillText(`${conversionRate}%`, spacing + barWidth / 2, canvas.height - 5);
         
         // 待转化标签
         ctx.fillText('待转化', spacing + barWidth + 40 + barWidth / 2, canvas.height - 20);
         ctx.fillText(`${pendingCount}`, spacing + barWidth + 40 + barWidth / 2, canvas.height - 45 - pendingHeight);
         ctx.fillText(`${pendingRate}%`, spacing + barWidth + 40 + barWidth / 2, canvas.height - 5);
         
         // 绘制标题
         ctx.font = 'bold 14px Arial';
         ctx.fillText(`总转化率: ${conversionRate}%`, canvas.width / 2, 20);
     }
});
</script>

<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 15px;
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
}

.stat-card:nth-child(1) .stat-icon { background: #007bff; }
.stat-card:nth-child(2) .stat-icon { background: #28a745; }
.stat-card:nth-child(3) .stat-icon { background: #ffc107; }
.stat-card:nth-child(4) .stat-icon { background: #17a2b8; }

.stat-content h3 {
    margin: 0;
    font-size: 24px;
    font-weight: bold;
    color: #333;
}

.stat-content p {
    margin: 5px 0 0 0;
    color: #666;
    font-size: 14px;
}

.form-section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.charts-section {
    margin-bottom: 30px;
}

.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
}

.chart-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    text-align: center;
}

.chart-card h4 {
    margin: 0 0 15px 0;
    color: #333;
    font-size: 16px;
    font-weight: 600;
}

.chart-card canvas {
    border: 1px solid #eee;
    border-radius: 4px;
    background: #fafafa;
}

.form-section h3 {
    margin: 0 0 20px 0;
    color: #333;
}

.form-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
    margin-bottom: 30px;
}

.input-mode-selector {
    margin-bottom: 25px;
    padding: 20px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    border: 1px solid #dee2e6;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.input-mode-selector h4 {
    margin: 0 0 15px 0;
    color: #495057;
    font-size: 16px;
    font-weight: 600;
}

.mode-options {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.radio-option {
    position: relative;
    cursor: pointer;
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    transition: all 0.3s ease;
    overflow: hidden;
}

.radio-option:hover {
    border-color: #007bff;
    box-shadow: 0 2px 8px rgba(0,123,255,0.15);
    transform: translateY(-1px);
}

.radio-option input[type="radio"] {
    position: absolute;
    top: 12px;
    right: 12px;
    margin: 0;
    accent-color: #007bff;
    transform: scale(1.2);
}

.radio-option input[type="radio"]:checked + .option-content {
    color: #007bff;
}

.radio-option input[type="radio"]:checked {
    background: #007bff;
}

.radio-option:has(input[type="radio"]:checked) {
    border-color: #007bff;
    background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
    box-shadow: 0 2px 8px rgba(0,123,255,0.2);
}

.option-content {
    display: flex;
    flex-direction: column;
    gap: 5px;
    padding-right: 30px;
}

.option-content i {
    font-size: 20px;
    color: #6c757d;
    margin-bottom: 5px;
}

.option-content span {
    font-weight: 600;
    font-size: 14px;
    color: #495057;
}

.option-content small {
    color: #6c757d;
    font-size: 12px;
    line-height: 1.3;
}

.radio-option:has(input[type="radio"]:checked) .option-content i {
    color: #007bff;
}

.radio-option:has(input[type="radio"]:checked) .option-content span {
    color: #007bff;
}

/* 选择已有学员样式 */
.customer-select {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 14px;
    background: white;
    transition: all 0.3s ease;
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 12px center;
    background-repeat: no-repeat;
    background-size: 16px;
    padding-right: 40px;
}

.customer-select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
}

.customer-select option {
    padding: 10px;
    font-size: 14px;
}

.form-help {
    display: block;
    margin-top: 8px;
    color: #6c757d;
    font-size: 12px;
}

.form-help i {
    margin-right: 4px;
    color: #007bff;
}

/* 学员信息预览样式 */
.customer-preview {
    margin-top: 20px;
    padding: 16px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px solid #dee2e6;
    border-radius: 8px;
    animation: fadeIn 0.3s ease;
}

.customer-preview h5 {
    margin: 0 0 12px 0;
    color: #495057;
    font-size: 14px;
    font-weight: 600;
}

.customer-preview h5 i {
    margin-right: 6px;
    color: #007bff;
}

.preview-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.preview-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.preview-item label {
    font-weight: 500;
    color: #6c757d;
    font-size: 12px;
    min-width: 40px;
    margin: 0;
}

.preview-item span {
    color: #495057;
    font-size: 13px;
    font-weight: 500;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.customer-section {
    transition: all 0.3s ease;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    margin-bottom: 5px;
    font-weight: 500;
    color: #333;
}

.form-group input,
.form-group select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

.table-section {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
}

.table-header {
    padding: 20px;
    border-bottom: 1px solid #eee;
}

.table-header h3 {
    margin: 0 0 20px 0;
    color: #333;
}

.search-filter-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
}

.search-box {
    position: relative;
    flex: 1;
    min-width: 250px;
}

.search-input {
    width: 100%;
    padding: 10px 40px 10px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.2s;
}

.search-input:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

.search-icon {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
    pointer-events: none;
}

.filter-controls {
    display: flex;
    gap: 10px;
    align-items: center;
}

.filter-select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    background: white;
    min-width: 120px;
}

.filter-select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

.btn-outline-primary {
    background: transparent;
    color: #007bff;
    border: 1px solid #007bff;
}

.btn-outline-primary:hover {
    background: #007bff;
    color: white;
}

.btn-outline-danger {
    background: transparent;
    color: #dc3545;
    border: 1px solid #dc3545;
}

.btn-outline-danger:hover {
    background: #dc3545;
    color: white;
}

.batch-checkbox,
.row-checkbox {
    cursor: pointer;
    transform: scale(1.2);
}

.data-table th:first-child,
.data-table td:first-child {
    width: 40px;
    text-align: center;
}

.table-container {
    overflow-x: auto;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.data-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #333;
}

.data-table tbody tr:hover {
    background: #f8f9fa;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}

.status-converted {
    background: #d4edda;
    color: #155724;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
}

.action-buttons {
    display: flex;
    gap: 5px;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 14px;
    transition: all 0.2s;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-success:hover {
    background: #1e7e34;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 12px;
}

.text-center {
    text-align: center;
}

.text-muted {
    color: #6c757d;
}

#flash-messages {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    transition: opacity 0.3s;
}

.alert {
    padding: 12px 20px;
    border-radius: 4px;
    margin-bottom: 10px;
    font-weight: 500;
}

.alert-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.alert-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}
</style>
{% endblock %}