{% extends "base.html" %}

{% block title %}首页 - 客户管理系统{% endblock %}
{% block page_title %}控制面板{% endblock %}

{% block content %}
<div class="dashboard animate-in">
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-info">
                <h3>总客户数</h3>
                <p class="stat-number">{{ total_customers }}</p>
                <span class="stat-change">
                    <i class="fas fa-arrow-up"></i> 本月新增 {{ new_customers }}
                </span>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon" style="background: var(--success-gradient);">
                <i class="fas fa-user-plus"></i>
            </div>
            <div class="stat-info">
                <h3>本月新增</h3>
                <p class="stat-number">{{ new_customers }}</p>
                <span class="stat-change positive">
                    <i class="fas fa-chart-line"></i> 环比增长
                </span>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="stat-info">
                <h3>试听课成本</h3>
                <p class="stat-number">¥{{ trial_cost }}</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-percentage"></i>
            </div>
            <div class="stat-info">
                <h3>淘宝手续费率</h3>
                <p class="stat-number">{{ taobao_fee_rate }}%</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-shopping-cart"></i>
            </div>
            <div class="stat-info">
                <h3>刷单订单</h3>
                <p class="stat-number">{{ total_orders }}</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-info">
                <h3>刷单总额</h3>
                <p class="stat-number">¥{{ total_order_amount }}</p>
            </div>
        </div>
    </div>

    <!-- 图表区域 -->
    <div class="charts-section">
        <div class="chart-container">
            <div class="chart-header">
                <h3 class="chart-title">收入趋势</h3>
                <div class="chart-controls">
                    <button class="btn btn-sm" onclick="updateChart('week')">周</button>
                    <button class="btn btn-sm active" onclick="updateChart('month')">月</button>
                    <button class="btn btn-sm" onclick="updateChart('year')">年</button>
                </div>
            </div>
            <canvas id="revenueChart"></canvas>
        </div>
        
        <div class="chart-container">
            <div class="chart-header">
                <h3 class="chart-title">课程分布</h3>
            </div>
            <canvas id="courseDistributionChart"></canvas>
        </div>
    </div>

    <div class="recent-section">
        <div class="section-header">
            <h2><i class="fas fa-clock"></i> 最近添加的客户</h2>
            <a href="{{ url_for('main.manage_customers') }}" class="btn btn-primary">
                查看全部 <i class="fas fa-arrow-right"></i>
            </a>
        </div>
        
        <div class="table-container">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th>客户信息</th>
                        <th>联系方式</th>
                        <th>年级</th>
                        <th>地区</th>
                        <th>添加时间</th>
                        <th>状态</th>
                    </tr>
                </thead>
                <tbody>
                    {% for customer in recent_customers %}
                    <tr class="animate__animated animate__fadeIn">
                        <td>
                            <div class="user-info">
                                <div class="user-avatar">
                                    <i class="fas fa-user-circle"></i>
                                </div>
                                <div class="user-details">
                                    <span class="user-name">{{ customer.name }}</span>
                                    <span class="user-meta">{{ customer.source or '未知来源' }}</span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="contact-info">
                                <i class="fas fa-phone"></i>
                                {{ customer.phone }}
                            </div>
                        </td>
                        <td><span class="badge badge-info">{{ customer.grade or '未设置' }}</span></td>
                        <td>
                            <div class="location-info">
                                <i class="fas fa-map-marker-alt"></i>
                                {{ customer.region or '未设置' }}
                            </div>
                        </td>
                        <td>
                            <div class="date-info">
                                <i class="fas fa-calendar"></i>
                                {{ customer.created_at.strftime('%Y-%m-%d') if customer.created_at else '未知' }}
                            </div>
                        </td>
                        <td>
                            <span class="badge badge-success">新客户</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
/* 首页专属样式增强 */
.charts-section {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
    margin: 30px 0;
}

.chart-controls {
    display: flex;
    gap: 5px;
}

.chart-controls .btn {
    padding: 5px 12px;
    font-size: 12px;
    background: #f0f0f0;
    color: #666;
    border-radius: 20px;
}

.chart-controls .btn.active {
    background: var(--primary-gradient);
    color: white;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--primary-gradient);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}

.user-details {
    display: flex;
    flex-direction: column;
}

.user-name {
    font-weight: 600;
    color: var(--text-primary);
}

.user-meta {
    font-size: 12px;
    color: var(--text-secondary);
}

.contact-info,
.location-info,
.date-info {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--text-secondary);
}

.contact-info i,
.location-info i,
.date-info i {
    font-size: 14px;
    color: var(--primary-color);
}

@media (max-width: 768px) {
    .charts-section {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// 初始化图表
document.addEventListener('DOMContentLoaded', function() {
    // 收入趋势图
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    const revenueChart = new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
            datasets: [{
                label: '收入',
                data: [12000, 19000, 15000, 25000, 22000, 30000],
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true,
                pointBackgroundColor: '#667eea',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    padding: 12,
                    cornerRadius: 8,
                    callbacks: {
                        label: function(context) {
                            return '收入: ¥' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return '¥' + value.toLocaleString();
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // 课程分布饼图
    const courseCtx = document.getElementById('courseDistributionChart').getContext('2d');
    const courseChart = new Chart(courseCtx, {
        type: 'doughnut',
        data: {
            labels: ['试听课', '正课', '续课'],
            datasets: [{
                data: [30, 50, 20],
                backgroundColor: [
                    '#667eea',
                    '#764ba2',
                    '#f093fb'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed + '%';
                        }
                    }
                }
            }
        }
    });

    // 图表更新函数
    window.updateChart = function(period) {
        // 更新按钮状态
        document.querySelectorAll('.chart-controls .btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        // 根据周期更新数据
        let labels, data;
        switch(period) {
            case 'week':
                labels = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];
                data = [3000, 4500, 3200, 5000, 4200, 6000, 5500];
                break;
            case 'month':
                labels = ['1月', '2月', '3月', '4月', '5月', '6月'];
                data = [12000, 19000, 15000, 25000, 22000, 30000];
                break;
            case 'year':
                labels = ['2023', '2024'];
                data = [180000, 220000];
                break;
        }

        revenueChart.data.labels = labels;
        revenueChart.data.datasets[0].data = data;
        revenueChart.update();
    };
});
</script>
{% endblock %}