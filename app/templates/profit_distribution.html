{% extends "base.html" %}

{% block title %}股东利润分配报表{% endblock %}

{% block content %}
<div class="profit-distribution-container">
    <div class="header-section">
        <h1><i class="fas fa-chart-pie"></i> 股东利润分配报表</h1>
        
        <!-- 时间选择 -->
        <div class="period-selector">
            <button class="btn btn-period active" data-period="month">本月</button>
            <button class="btn btn-period" data-period="quarter">本季度</button>
            <button class="btn btn-period" data-period="year">本年度</button>
            <button class="btn btn-period" data-period="custom">自定义</button>
            
            <div class="custom-date-range" style="display: none;">
                <input type="date" id="startDate" class="form-control">
                <span>至</span>
                <input type="date" id="endDate" class="form-control">
                <button class="btn btn-primary" onclick="loadReport()">查询</button>
            </div>
        </div>
    </div>
    
    <!-- 加载动画 -->
    <div class="loading" id="loading" style="display: none;">
        <div class="spinner"></div>
        <p>正在生成报表...</p>
    </div>
    
    <!-- 报表内容 -->
    <div id="reportContent" style="display: none;">
        <!-- 概览卡片 -->
        <div class="summary-cards">
            <div class="card revenue-card">
                <h3>总收入</h3>
                <p class="amount" id="totalRevenue">¥0</p>
                <div class="details">
                    <span>课程收入: <em id="courseRevenue">¥0</em></span>
                    <span>刷单金额: <em id="taobaoRevenue">¥0</em></span>
                </div>
            </div>
            
            <div class="card cost-card">
                <h3>总成本</h3>
                <p class="amount" id="totalCost">¥0</p>
                <div class="details">
                    <span>课程成本: <em id="courseCost">¥0</em></span>
                    <span>刷单费用: <em id="taobaoCost">¥0</em></span>
                    <span>员工成本: <em id="employeeCost">¥0</em></span>
                </div>
            </div>
            
            <div class="card profit-card">
                <h3>净利润</h3>
                <p class="amount" id="netProfit">¥0</p>
                <div class="details">
                    <span>利润率: <em id="profitMargin">0%</em></span>
                </div>
            </div>
        </div>
        
        <!-- 收入明细 -->
        <div class="section revenue-detail">
            <h2><i class="fas fa-coins"></i> 收入明细</h2>
            <table class="detail-table">
                <tr>
                    <td>试听课收入</td>
                    <td class="amount" id="trialRevenue">¥0</td>
                </tr>
                <tr>
                    <td>新课收入</td>
                    <td class="amount" id="newCourseRevenue">¥0</td>
                </tr>
                <tr>
                    <td>续课收入</td>
                    <td class="amount" id="renewalRevenue">¥0</td>
                </tr>
                <tr>
                    <td>刷单金额</td>
                    <td class="amount" id="taobaoAmount">¥0</td>
                </tr>
                <tr class="subtotal">
                    <td>小计</td>
                    <td class="amount" id="revenueSubtotal">¥0</td>
                </tr>
                <tr class="deduction">
                    <td>退费金额（实际退款）</td>
                    <td class="amount negative" id="refundAmount">-¥0</td>
                </tr>
                <tr class="total">
                    <td>总收入</td>
                    <td class="amount" id="totalRevenueDetail">¥0</td>
                </tr>
            </table>
        </div>
        
        <!-- 成本明细 -->
        <div class="section cost-detail">
            <h2><i class="fas fa-calculator"></i> 成本明细</h2>
            <table class="detail-table">
                <tr>
                    <td>课程成本</td>
                    <td class="amount" id="courseCostDetail">¥0</td>
                </tr>
                <tr>
                    <td>渠道手续费</td>
                    <td class="amount" id="totalFee">¥0</td>
                </tr>
                <tr>
                    <td>刷单金额（成本）</td>
                    <td class="amount" id="taobaoOrderAmount">¥0</td>
                </tr>
                <tr>
                    <td>刷单佣金</td>
                    <td class="amount" id="taobaoCommission">¥0</td>
                </tr>
                <tr>
                    <td>刷单手续费</td>
                    <td class="amount" id="taobaoFee">¥0</td>
                </tr>
                <tr>
                    <td>员工基本工资</td>
                    <td class="amount" id="employeeSalary">¥0</td>
                </tr>
                <tr>
                    <td>员工提成</td>
                    <td class="amount" id="employeeCommission">¥0</td>
                </tr>
                <tr class="total">
                    <td>总成本</td>
                    <td class="amount" id="totalCostDetail">¥0</td>
                </tr>
            </table>
        </div>
        
        <!-- 股东分配 -->
        <div class="section shareholder-distribution">
            <h2><i class="fas fa-users"></i> 股东利润分配</h2>
            
            <div class="distribution-cards">
                <!-- 新课分配 -->
                <div class="dist-card">
                    <h3>新课利润分配</h3>
                    <p class="profit-amount">利润: <span id="newCourseProfitAmount">¥0</span></p>
                    <div class="shareholder-items">
                        <div class="shareholder-item">
                            <span class="name">股东A (<em id="newCourseRatioA">50</em>%)</span>
                            <span class="amount" id="newCourseShareholderA">¥0</span>
                        </div>
                        <div class="shareholder-item">
                            <span class="name">股东B (<em id="newCourseRatioB">50</em>%)</span>
                            <span class="amount" id="newCourseShareholderB">¥0</span>
                        </div>
                    </div>
                </div>
                
                <!-- 续课分配 -->
                <div class="dist-card">
                    <h3>续课利润分配</h3>
                    <p class="profit-amount">利润: <span id="renewalProfitAmount">¥0</span></p>
                    <div class="shareholder-items">
                        <div class="shareholder-item">
                            <span class="name">股东A (<em id="renewalRatioA">40</em>%)</span>
                            <span class="amount" id="renewalShareholderA">¥0</span>
                        </div>
                        <div class="shareholder-item">
                            <span class="name">股东B (<em id="renewalRatioB">60</em>%)</span>
                            <span class="amount" id="renewalShareholderB">¥0</span>
                        </div>
                    </div>
                </div>
                
                <!-- 总计 -->
                <div class="dist-card total-card">
                    <h3>股东分配总计</h3>
                    <div class="shareholder-items">
                        <div class="shareholder-item">
                            <span class="name">股东A 总计</span>
                            <span class="amount" id="totalShareholderA">¥0</span>
                        </div>
                        <div class="shareholder-item">
                            <span class="name">股东B 总计</span>
                            <span class="amount" id="totalShareholderB">¥0</span>
                        </div>
                        <div class="shareholder-item total">
                            <span class="name">已分配总额</span>
                            <span class="amount" id="totalDistributed">¥0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 导出按钮 -->
        <div class="export-section">
            <button class="btn btn-success" onclick="exportReport()">
                <i class="fas fa-download"></i> 导出报表
            </button>
        </div>
    </div>
</div>

<style>
.profit-distribution-container {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
}

.header-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.header-section h1 {
    margin: 0;
    color: #333;
}

.period-selector {
    display: flex;
    gap: 10px;
    align-items: center;
}

.btn-period {
    padding: 8px 20px;
    border: 1px solid #ddd;
    background: white;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.3s;
}

.btn-period:hover {
    background: #f5f5f5;
}

.btn-period.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.custom-date-range {
    display: flex;
    gap: 10px;
    align-items: center;
}

.loading {
    text-align: center;
    padding: 50px;
}

.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #007bff;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* 概览卡片 */
.summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.card h3 {
    margin: 0 0 15px 0;
    font-size: 16px;
    color: #666;
}

.card .amount {
    font-size: 32px;
    font-weight: bold;
    margin: 10px 0;
}

.revenue-card .amount { color: #28a745; }
.cost-card .amount { color: #dc3545; }
.profit-card .amount { color: #007bff; }

.card .details {
    display: flex;
    flex-direction: column;
    gap: 5px;
    font-size: 14px;
    color: #666;
}

.card .details em {
    font-style: normal;
    font-weight: 500;
    color: #333;
}

/* 详细表格 */
.section {
    background: white;
    padding: 25px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.section h2 {
    margin: 0 0 20px 0;
    color: #333;
    font-size: 20px;
}

.detail-table {
    width: 100%;
    border-collapse: collapse;
}

.detail-table td {
    padding: 12px;
    border-bottom: 1px solid #eee;
}

.detail-table td:last-child {
    text-align: right;
    font-weight: 500;
}

.detail-table .subtotal td {
    border-top: 2px solid #ddd;
    font-weight: 600;
}

.detail-table .deduction td {
    color: #dc3545;
}

.detail-table .total td {
    border-top: 3px double #333;
    font-weight: bold;
    font-size: 16px;
}

.amount.negative {
    color: #dc3545;
}

/* 股东分配 */
.distribution-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
}

.dist-card {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.dist-card h3 {
    margin: 0 0 15px 0;
    color: #495057;
    font-size: 18px;
}

.profit-amount {
    margin: 10px 0 20px;
    color: #666;
}

.profit-amount span {
    font-weight: bold;
    color: #007bff;
    font-size: 20px;
}

.shareholder-items {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.shareholder-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    background: white;
    border-radius: 4px;
}

.shareholder-item .name {
    color: #666;
}

.shareholder-item .amount {
    font-weight: bold;
    color: #28a745;
    font-size: 18px;
}

.total-card {
    background: #e3f2fd;
    border-color: #2196f3;
}

.shareholder-item.total {
    background: #1976d2;
    color: white;
}

.shareholder-item.total .name,
.shareholder-item.total .amount {
    color: white;
}

/* 导出按钮 */
.export-section {
    text-align: center;
    margin-top: 30px;
}

.btn {
    padding: 10px 30px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}
</style>

<script>
let currentPeriod = 'month';
let currentReport = null;

// 页面加载完成后自动加载报表
document.addEventListener('DOMContentLoaded', function() {
    loadReport();
    
    // 绑定时间选择按钮事件
    document.querySelectorAll('.btn-period').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.btn-period').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            currentPeriod = this.dataset.period;
            
            if (currentPeriod === 'custom') {
                document.querySelector('.custom-date-range').style.display = 'flex';
            } else {
                document.querySelector('.custom-date-range').style.display = 'none';
                loadReport();
            }
        });
    });
});

// 加载报表
function loadReport() {
    const loading = document.getElementById('loading');
    const content = document.getElementById('reportContent');
    
    loading.style.display = 'block';
    content.style.display = 'none';
    
    let url = `/api/comprehensive-profit-report?period=${currentPeriod}`;
    
    if (currentPeriod === 'custom') {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        if (!startDate || !endDate) {
            alert('请选择开始和结束日期');
            loading.style.display = 'none';
            return;
        }
        
        url = `/api/comprehensive-profit-report?period=custom&start_date=${startDate}&end_date=${endDate}`;
    }
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentReport = data.data;
                displayReport(data.data);
                loading.style.display = 'none';
                content.style.display = 'block';
            } else {
                alert('加载报表失败: ' + data.message);
                loading.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('加载报表失败');
            loading.style.display = 'none';
        });
}

// 显示报表数据
function displayReport(report) {
    // 概览卡片
    document.getElementById('totalRevenue').textContent = formatCurrency(report.revenue.total_revenue);
    document.getElementById('courseRevenue').textContent = formatCurrency(report.revenue.course_revenue);
    document.getElementById('taobaoRevenue').textContent = formatCurrency(report.revenue.taobao_revenue);
    
    document.getElementById('totalCost').textContent = formatCurrency(report.cost.total_cost);
    document.getElementById('courseCost').textContent = formatCurrency(report.cost.course_cost);
    document.getElementById('taobaoCost').textContent = formatCurrency(report.cost.taobao_commission + report.cost.taobao_fee);
    document.getElementById('employeeCost').textContent = formatCurrency(report.cost.employee_salary + report.cost.employee_commission);
    
    document.getElementById('netProfit').textContent = formatCurrency(report.profit.net_profit);
    document.getElementById('profitMargin').textContent = report.profit.profit_margin.toFixed(2) + '%';
    
    // 收入明细
    document.getElementById('trialRevenue').textContent = formatCurrency(report.revenue.trial_revenue);
    document.getElementById('newCourseRevenue').textContent = formatCurrency(report.revenue.new_course_revenue);
    document.getElementById('renewalRevenue').textContent = formatCurrency(report.revenue.renewal_revenue);
    document.getElementById('taobaoAmount').textContent = formatCurrency(report.revenue.taobao_revenue);
    document.getElementById('revenueSubtotal').textContent = formatCurrency(
        report.revenue.trial_revenue + report.revenue.new_course_revenue + 
        report.revenue.renewal_revenue + report.revenue.taobao_revenue
    );
    document.getElementById('refundAmount').textContent = '-' + formatCurrency(report.revenue.refund_amount);
    document.getElementById('totalRevenueDetail').textContent = formatCurrency(report.revenue.total_revenue);
    
    // 成本明细
    document.getElementById('courseCostDetail').textContent = formatCurrency(report.cost.course_cost);
    document.getElementById('totalFee').textContent = formatCurrency(report.cost.total_fee);
    document.getElementById('taobaoOrderAmount').textContent = formatCurrency(report.cost.taobao_order_amount);
    document.getElementById('taobaoCommission').textContent = formatCurrency(report.cost.taobao_commission);
    document.getElementById('taobaoFee').textContent = formatCurrency(report.cost.taobao_fee);
    document.getElementById('employeeSalary').textContent = formatCurrency(report.cost.employee_salary);
    document.getElementById('employeeCommission').textContent = formatCurrency(report.cost.employee_commission);
    document.getElementById('totalCostDetail').textContent = formatCurrency(report.cost.total_cost);
    
    // 股东分配
    // 新课
    document.getElementById('newCourseProfitAmount').textContent = formatCurrency(report.shareholder_distribution.new_course.profit);
    document.getElementById('newCourseRatioA').textContent = report.shareholder_distribution.new_course.ratio_a;
    document.getElementById('newCourseRatioB').textContent = report.shareholder_distribution.new_course.ratio_b;
    document.getElementById('newCourseShareholderA').textContent = formatCurrency(report.shareholder_distribution.new_course.shareholder_a);
    document.getElementById('newCourseShareholderB').textContent = formatCurrency(report.shareholder_distribution.new_course.shareholder_b);
    
    // 续课
    document.getElementById('renewalProfitAmount').textContent = formatCurrency(report.shareholder_distribution.renewal.profit);
    document.getElementById('renewalRatioA').textContent = report.shareholder_distribution.renewal.ratio_a;
    document.getElementById('renewalRatioB').textContent = report.shareholder_distribution.renewal.ratio_b;
    document.getElementById('renewalShareholderA').textContent = formatCurrency(report.shareholder_distribution.renewal.shareholder_a);
    document.getElementById('renewalShareholderB').textContent = formatCurrency(report.shareholder_distribution.renewal.shareholder_b);
    
    // 总计
    document.getElementById('totalShareholderA').textContent = formatCurrency(report.shareholder_distribution.total.shareholder_a);
    document.getElementById('totalShareholderB').textContent = formatCurrency(report.shareholder_distribution.total.shareholder_b);
    document.getElementById('totalDistributed').textContent = formatCurrency(report.shareholder_distribution.total.total_distributed);
}

// 格式化货币
function formatCurrency(amount) {
    return '¥' + Number(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

// 导出报表
function exportReport() {
    if (!currentReport) {
        alert('请先加载报表');
        return;
    }
    
    // 创建CSV内容
    let csv = '股东利润分配报表\n';
    csv += `报表期间,${currentReport.period.start_date} 至 ${currentReport.period.end_date}\n\n`;
    
    csv += '收入明细\n';
    csv += '项目,金额\n';
    csv += `试听课收入,${currentReport.revenue.trial_revenue}\n`;
    csv += `新课收入,${currentReport.revenue.new_course_revenue}\n`;
    csv += `续课收入,${currentReport.revenue.renewal_revenue}\n`;
    csv += `刷单金额,${currentReport.revenue.taobao_revenue}\n`;
    csv += `退费金额（实际退款）,-${currentReport.revenue.refund_amount}\n`;
    csv += `总收入,${currentReport.revenue.total_revenue}\n\n`;
    
    csv += '成本明细\n';
    csv += '项目,金额\n';
    csv += `课程成本,${currentReport.cost.course_cost}\n`;
    csv += `渠道手续费,${currentReport.cost.total_fee}\n`;
    csv += `刷单金额（成本）,${currentReport.cost.taobao_order_amount}\n`;
    csv += `刷单佣金,${currentReport.cost.taobao_commission}\n`;
    csv += `刷单手续费,${currentReport.cost.taobao_fee}\n`;
    csv += `员工工资,${currentReport.cost.employee_salary}\n`;
    csv += `员工提成,${currentReport.cost.employee_commission}\n`;
    csv += `总成本,${currentReport.cost.total_cost}\n\n`;
    
    csv += '利润\n';
    csv += `净利润,${currentReport.profit.net_profit}\n`;
    csv += `利润率,${currentReport.profit.profit_margin}%\n\n`;
    
    csv += '股东分配\n';
    csv += '类型,股东A,股东B\n';
    csv += `新课利润分配,${currentReport.shareholder_distribution.new_course.shareholder_a},${currentReport.shareholder_distribution.new_course.shareholder_b}\n`;
    csv += `续课利润分配,${currentReport.shareholder_distribution.renewal.shareholder_a},${currentReport.shareholder_distribution.renewal.shareholder_b}\n`;
    csv += `合计,${currentReport.shareholder_distribution.total.shareholder_a},${currentReport.shareholder_distribution.total.shareholder_b}\n`;
    
    // 下载CSV
    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `股东利润分配报表_${currentReport.period.start_date}_${currentReport.period.end_date}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
{% endblock %}