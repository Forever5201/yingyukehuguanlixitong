{% extends "base.html" %}

{% block title %}股东利润分配报表{% endblock %}

{% block head %}
<style>
/* 利润分配页面专属样式 */
.profit-distribution-container {
    padding: 20px;
}

.header-section {
    margin-bottom: 30px;
}

.header-section h1 {
    font-size: 28px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 20px;
}

.period-selector {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}

.btn-period {
    padding: 8px 20px;
    border: 1px solid var(--border-color);
    background: white;
    color: var(--text-secondary);
    border-radius: 20px;
    transition: all var(--transition-fast) ease;
    cursor: pointer;
}

.btn-period:hover {
    border-color: var(--primary-color);
    color: var(--primary-color);
}

.btn-period.active {
    background: var(--primary-gradient);
    color: white;
    border-color: transparent;
}

.custom-date-range {
    display: flex;
    gap: 10px;
    align-items: center;
}

/* 增强的卡片样式 */
.summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
    gap: 16px;
}

.card-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    flex-shrink: 0;
}

.revenue-card .card-icon {
    background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
    color: white;
}

.cost-card .card-icon {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    color: white;
}

.profit-card .card-icon {
    background: var(--primary-gradient);
    color: white;
}

.card-content {
    flex: 1;
}

.card h3 {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 8px;
    font-weight: 500;
}

.card .amount {
    font-size: 28px;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
}

.card .details {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-top: 8px;
}

.card .details span {
    font-size: 12px;
    color: var(--text-secondary);
}

.card .details em {
    font-style: normal;
    font-weight: 600;
    color: var(--text-primary);
}

.card-chart {
    position: absolute;
    top: 10px;
    right: 10px;
    opacity: 0.6;
}

.card-trend {
    position: absolute;
    top: 20px;
    right: 20px;
    font-size: 14px;
    font-weight: 600;
    color: var(--success-color);
    display: flex;
    align-items: center;
    gap: 4px;
}

.card-trend.negative {
    color: var(--danger-color);
}

/* 图表区域 */
.charts-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 30px;
}

@media (max-width: 968px) {
    .charts-row {
        grid-template-columns: 1fr;
    }
}

/* 详细表格样式 */
.section {
    background: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.section h2 {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 20px;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
}

.detail-table {
    width: 100%;
    border-collapse: collapse;
}

.detail-table td {
    padding: 12px 16px;
    border-bottom: 1px solid #f0f0f0;
}

.detail-table td:last-child {
    text-align: right;
    font-weight: 600;
}

.detail-table tr:last-child td {
    border-bottom: none;
}

.detail-table .total-row {
    font-weight: 700;
    font-size: 16px;
    border-top: 2px solid var(--border-color);
    background: #f8f9fa;
}

/* 导出按钮 */
.export-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: var(--success-gradient);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast) ease;
}

.export-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}
</style>
{% endblock %}

{% block content %}
<div class="profit-distribution-container">
    <div class="header-section">
        <h1><i class="fas fa-chart-pie"></i> 股东利润分配报表</h1>
        
        <!-- 时间选择 -->
        <div class="period-selector">
            <button class="btn btn-period active" data-period="month">本月</button>
            <button class="btn btn-period" data-period="quarter">本季度</button>
            <button class="btn btn-period" data-period="year">本年度</button>
            <button class="btn btn-period" data-period="custom">自定义</button>
            
            <div class="custom-date-range" style="display: none;">
                <input type="date" id="startDate" class="form-control">
                <span>至</span>
                <input type="date" id="endDate" class="form-control">
                <button class="btn btn-primary" onclick="loadReport()">查询</button>
            </div>
        </div>
    </div>
    
    <!-- 加载动画 -->
    <div class="loading" id="loading" style="display: none;">
        <div class="spinner"></div>
        <p>正在生成报表...</p>
    </div>
    
    <!-- 报表内容 -->
    <div id="reportContent" style="display: none;">
        <!-- 概览卡片 -->
        <div class="summary-cards">
            <div class="card revenue-card animate__animated animate__fadeInUp">
                <div class="card-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="card-content">
                    <h3>总收入</h3>
                    <p class="amount" id="totalRevenue">¥0</p>
                    <div class="details">
                        <span>课程收入: <em id="courseRevenue">¥0</em></span>
                    </div>
                </div>
                <div class="card-chart">
                    <canvas id="revenueSparkline" width="100" height="40"></canvas>
                </div>
            </div>
            
            <div class="card cost-card animate__animated animate__fadeInUp" style="animation-delay: 0.1s;">
                <div class="card-icon">
                    <i class="fas fa-calculator"></i>
                </div>
                <div class="card-content">
                    <h3>总成本</h3>
                    <p class="amount" id="totalCost">¥0</p>
                    <div class="details">
                        <span>课程成本: <em id="courseCost">¥0</em></span>
                        <span>刷单费用: <em id="taobaoCost">¥0</em></span>
                        <span>员工成本: <em id="employeeCost">¥0</em></span>
                    </div>
                </div>
            </div>
            
            <div class="card profit-card animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
                <div class="card-icon">
                    <i class="fas fa-coins"></i>
                </div>
                <div class="card-content">
                    <h3>净利润</h3>
                    <p class="amount" id="netProfit">¥0</p>
                    <div class="details">
                        <span>利润率: <em id="profitMargin">0%</em></span>
                    </div>
                </div>
                <div class="card-trend" id="profitTrend">
                    <i class="fas fa-arrow-up"></i> +15%
                </div>
            </div>
        </div>
        
        <!-- 图表区域 -->
        <div class="charts-row">
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">收入构成分析</h3>
                    <button class="btn btn-sm export-chart-btn" data-chart-id="revenueChart">
                        <i class="fas fa-download"></i> 导出
                    </button>
                </div>
                <canvas id="revenueCompositionChart"></canvas>
            </div>
            
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">成本结构分析</h3>
                    <button class="btn btn-sm export-chart-btn" data-chart-id="costChart">
                        <i class="fas fa-download"></i> 导出
                    </button>
                </div>
                <canvas id="costStructureChart"></canvas>
            </div>
        </div>
        
        <!-- 收入明细 -->
        <div class="section revenue-detail">
            <h2><i class="fas fa-coins"></i> 收入明细</h2>
            <table class="detail-table">
                <tr>
                    <td>试听课收入</td>
                    <td class="amount" id="trialRevenue">¥0</td>
                </tr>
                <tr>
                    <td>新课收入</td>
                    <td class="amount" id="newCourseRevenue">¥0</td>
                </tr>
                <tr>
                    <td>续课收入</td>
                    <td class="amount" id="renewalRevenue">¥0</td>
                </tr>

                <tr class="subtotal">
                    <td>小计</td>
                    <td class="amount" id="revenueSubtotal">¥0</td>
                </tr>
                <tr class="deduction">
                    <td>退费金额（实际退款）</td>
                    <td class="amount negative" id="refundAmount">-¥0</td>
                </tr>
                <tr class="total">
                    <td>总收入</td>
                    <td class="amount" id="totalRevenueDetail">¥0</td>
                </tr>
            </table>
        </div>
        
        <!-- 成本明细 -->
        <div class="section cost-detail">
            <h2><i class="fas fa-calculator"></i> 成本明细</h2>
            <table class="detail-table">
                <tr>
                    <td>课程成本</td>
                    <td class="amount" id="courseCostDetail">¥0</td>
                </tr>
                <tr>
                    <td>总手续费</td>
                    <td class="amount" id="totalFee">¥0</td>
                </tr>
                <tr>
                    <td>刷单佣金</td>
                    <td class="amount" id="taobaoCommission">¥0</td>
                </tr>
                <tr>
                    <td>员工基本工资</td>
                    <td class="amount" id="employeeSalary">¥0</td>
                </tr>
                <tr>
                    <td>员工提成</td>
                    <td class="amount" id="employeeCommission">¥0</td>
                </tr>
                <tr>
                    <td>运营成本</td>
                    <td class="amount" id="operationalCost">¥0</td>
                </tr>
                <tr class="total">
                    <td>总成本</td>
                    <td class="amount" id="totalCostDetail">¥0</td>
                </tr>
            </table>
        </div>
        
        <!-- 股东分配 -->
        <div class="section shareholder-distribution">
            <h2><i class="fas fa-users"></i> 股东利润分配</h2>
            
            <div class="distribution-cards">
                <div class="dist-card total-card">
                    <h3>股东净利润分配</h3>
                    <div class="shareholder-items">
                        <div class="shareholder-item">
                            <span class="name"><strong>股东A 净利润</strong></span>
                            <span class="amount" id="shareholderAProfit">¥0</span>
                        </div>
                        <div class="shareholder-item">
                            <span class="name"><strong>股东B 净利润</strong></span>
                            <span class="amount" id="shareholderBProfit">¥0</span>
                        </div>
                        <div class="shareholder-item total">
                            <span class="name">净利润总额</span>
                            <span class="amount" id="totalDistributed">¥0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 导出按钮 -->
        <div class="export-section">
            <button class="btn btn-success" onclick="exportReport()">
                <i class="fas fa-download"></i> 导出报表
            </button>
        </div>
    </div>
</div>

<style>
.profit-distribution-container {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
}

.header-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.header-section h1 {
    margin: 0;
    color: #333;
}

.period-selector {
    display: flex;
    gap: 10px;
    align-items: center;
}

.btn-period {
    padding: 8px 20px;
    border: 1px solid #ddd;
    background: white;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.3s;
}

.btn-period:hover {
    background: #f5f5f5;
}

.btn-period.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.custom-date-range {
    display: flex;
    gap: 10px;
    align-items: center;
}

.loading {
    text-align: center;
    padding: 50px;
}

.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #007bff;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* 概览卡片 */
.summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.card h3 {
    margin: 0 0 15px 0;
    font-size: 16px;
    color: #666;
}

.card .amount {
    font-size: 32px;
    font-weight: bold;
    margin: 10px 0;
}

.revenue-card .amount { color: #28a745; }
.cost-card .amount { color: #dc3545; }
.profit-card .amount { color: #007bff; }

.card .details {
    display: flex;
    flex-direction: column;
    gap: 5px;
    font-size: 14px;
    color: #666;
}

.card .details em {
    font-style: normal;
    font-weight: 500;
    color: #333;
}

/* 详细表格 */
.section {
    background: white;
    padding: 25px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.section h2 {
    margin: 0 0 20px 0;
    color: #333;
    font-size: 20px;
}

.detail-table {
    width: 100%;
    border-collapse: collapse;
}

.detail-table td {
    padding: 12px;
    border-bottom: 1px solid #eee;
}

.detail-table td:last-child {
    text-align: right;
    font-weight: 500;
}

.detail-table .subtotal td {
    border-top: 2px solid #ddd;
    font-weight: 600;
}

.detail-table .deduction td {
    color: #dc3545;
}

.detail-table .total td {
    border-top: 3px double #333;
    font-weight: bold;
    font-size: 16px;
}

.amount.negative {
    color: #dc3545;
}

/* 股东分配 */
.distribution-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
}

.dist-card {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.dist-card h3 {
    margin: 0 0 15px 0;
    color: #495057;
    font-size: 18px;
}

.profit-amount {
    margin: 10px 0 20px;
    color: #666;
}

.profit-amount span {
    font-weight: bold;
    color: #007bff;
    font-size: 20px;
}

.shareholder-items {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.shareholder-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    background: white;
    border-radius: 4px;
}

.shareholder-item .name {
    color: #666;
}

.shareholder-item .amount {
    font-weight: bold;
    color: #28a745;
    font-size: 18px;
}

.total-card {
    background: #e3f2fd;
    border-color: #2196f3;
}

.shareholder-item.total {
    background: #1976d2;
    color: white;
}

.shareholder-item.total .name,
.shareholder-item.total .amount {
    color: white;
}

/* 导出按钮 */
.export-section {
    text-align: center;
    margin-top: 30px;
}

.btn {
    padding: 10px 30px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}
</style>

<script>
let currentPeriod = 'month';
let currentReport = null;

// 页面加载完成后自动加载报表
document.addEventListener('DOMContentLoaded', function() {
    loadReport();
    
    // 绑定时间选择按钮事件
    document.querySelectorAll('.btn-period').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.btn-period').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            currentPeriod = this.dataset.period;
            
            if (currentPeriod === 'custom') {
                document.querySelector('.custom-date-range').style.display = 'flex';
            } else {
                document.querySelector('.custom-date-range').style.display = 'none';
                loadReport();
            }
        });
    });
});

// 加载报表
function loadReport() {
    const loading = document.getElementById('loading');
    const content = document.getElementById('reportContent');
    
    loading.style.display = 'block';
    content.style.display = 'none';
    
    let url = `/api/comprehensive-profit-report?period=${currentPeriod}`;
    
    if (currentPeriod === 'custom') {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        if (!startDate || !endDate) {
            alert('请选择开始和结束日期');
            loading.style.display = 'none';
            return;
        }
        
        url = `/api/comprehensive-profit-report?period=custom&start_date=${startDate}&end_date=${endDate}`;
    }
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentReport = data.data;
                displayReport(data.data);
                loading.style.display = 'none';
                content.style.display = 'block';
            } else {
                alert('加载报表失败: ' + data.message);
                loading.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('加载报表失败: ' + error.message);
            loading.style.display = 'none';
        });
}

// 显示报表数据
function displayReport(report) {
    try {
        // 概览卡片
        document.getElementById('totalRevenue').textContent = formatCurrency(report.revenue.total_revenue);
        document.getElementById('courseRevenue').textContent = formatCurrency(report.revenue.course_revenue);
    
    document.getElementById('totalCost').textContent = formatCurrency(report.cost.total_cost);
    document.getElementById('courseCost').textContent = formatCurrency(report.cost.course_cost);
    document.getElementById('taobaoCost').textContent = formatCurrency(report.cost.taobao_commission + report.cost.taobao_fee);
    document.getElementById('employeeCost').textContent = formatCurrency(report.cost.employee_salary + report.cost.employee_commission);
    
    document.getElementById('netProfit').textContent = formatCurrency(report.profit.net_profit);
    document.getElementById('profitMargin').textContent = report.profit.profit_margin.toFixed(2) + '%';
    
    // 收入明细
    document.getElementById('trialRevenue').textContent = formatCurrency(report.revenue.trial_revenue);
    document.getElementById('newCourseRevenue').textContent = formatCurrency(report.revenue.new_course_revenue);
    document.getElementById('renewalRevenue').textContent = formatCurrency(report.revenue.renewal_revenue);
    document.getElementById('revenueSubtotal').textContent = formatCurrency(
        report.revenue.trial_revenue + report.revenue.new_course_revenue + 
        report.revenue.renewal_revenue
    );
    document.getElementById('refundAmount').textContent = '-' + formatCurrency(report.revenue.refund_amount);
    document.getElementById('totalRevenueDetail').textContent = formatCurrency(report.revenue.total_revenue);
    
    // 成本明细
    document.getElementById('courseCostDetail').textContent = formatCurrency(report.cost.course_cost);
    document.getElementById('totalFee').textContent = formatCurrency(report.cost.total_fee);
    document.getElementById('taobaoCommission').textContent = formatCurrency(report.cost.taobao_commission);
    document.getElementById('employeeSalary').textContent = formatCurrency(report.cost.employee_salary);
    document.getElementById('employeeCommission').textContent = formatCurrency(report.cost.employee_commission);
    document.getElementById('operationalCost').textContent = formatCurrency(report.cost.operational_cost);
    document.getElementById('totalCostDetail').textContent = formatCurrency(report.cost.total_cost);
    
    // 股东分配（简化版）
    document.getElementById('shareholderAProfit').textContent = formatCurrency(report.shareholder_distribution.shareholder_a_net_profit);
    document.getElementById('shareholderBProfit').textContent = formatCurrency(report.shareholder_distribution.shareholder_b_net_profit);
    document.getElementById('totalDistributed').textContent = formatCurrency(report.shareholder_distribution.total_distributed);
    
    // 初始化图表
    initCharts(report);
    
    } catch (error) {
        console.error('显示报表时出错:', error);
        console.error('报表数据:', report);
        alert('显示报表时出错: ' + error.message);
    }
}

// 格式化货币
function formatCurrency(amount) {
    return '¥' + Number(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

// 初始化图表
let revenueChart = null;
let costChart = null;

function initCharts(data) {
    // 使用新的统一图表组件
    
    // 收入构成图表
    if (revenueChart) {
        ChartManager.destroyChart(revenueChart);
    }
    
    revenueChart = initPieChart('revenueCompositionChart', {
        labels: ['试听课收入', '新课收入', '续课收入'],
        datasets: [{
            data: [
                data.revenue.trial_revenue,
                data.revenue.new_course_revenue,
                data.revenue.renewal_revenue
            ],
            isCurrency: true
        }]
    }, {
        plugins: {
            title: {
                display: true,
                text: '收入构成分析'
            }
        }
    });
    
    // 成本结构图表
    if (costChart) {
        ChartManager.destroyChart(costChart);
    }
    
    costChart = initPieChart('costStructureChart', {
        labels: ['课程成本', '总手续费', '刷单佣金', '员工工资', '员工提成'],
        datasets: [{
            data: [
                data.cost.course_cost,
                data.cost.total_fee,
                data.cost.taobao_commission,
                data.cost.employee_salary,
                data.cost.employee_commission
            ],
            isCurrency: true
        }]
    }, {
        type: 'doughnut',
        plugins: {
            title: {
                display: true,
                text: '成本结构分析'
            }
        }
    });
    
    // 添加导出按钮功能
    document.querySelectorAll('.export-chart-btn').forEach(btn => {
        btn.onclick = function() {
            const chartId = this.dataset.chartId;
            const chart = chartId === 'revenueChart' ? revenueChart : costChart;
            if (chart) {
                exportChartDataAsCSV(chart, chartId + '_' + new Date().toISOString().split('T')[0]);
            }
        };
    });
    
    // 原有的图表代码（注释掉）
    /*
                backgroundColor: [
                    '#ef4444',
                    '#f59e0b',
                    '#10b981',
                    '#3b82f6',
                    '#8b5cf6'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        usePointStyle: true,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = formatCurrency(context.parsed);
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    
    // 创建迷你图表
    const sparklineCtx = document.getElementById('revenueSparkline').getContext('2d');
    new Chart(sparklineCtx, {
        type: 'line',
        data: {
            labels: ['', '', '', '', '', ''],
            datasets: [{
                data: [65, 78, 66, 80, 76, 85],
                borderColor: '#667eea',
                borderWidth: 2,
                tension: 0.4,
                pointRadius: 0,
                fill: false
            }]
        },
        options: {
            responsive: false,
            plugins: {
                legend: { display: false },
                tooltip: { enabled: false }
            },
            scales: {
                x: { display: false },
                y: { display: false }
            }
        }
    });
    */
}

// 导出报表
function exportReport() {
    if (!currentReport) {
        alert('请先加载报表');
        return;
    }
    
    // 创建CSV内容
    let csv = '股东利润分配报表\n';
    csv += `报表期间,${currentReport.period.start_date} 至 ${currentReport.period.end_date}\n\n`;
    
    csv += '收入明细\n';
    csv += '项目,金额\n';
    csv += `试听课收入,${currentReport.revenue.trial_revenue}\n`;
    csv += `新课收入,${currentReport.revenue.new_course_revenue}\n`;
    csv += `续课收入,${currentReport.revenue.renewal_revenue}\n`;

    csv += `退费金额（实际退款）,-${currentReport.revenue.refund_amount}\n`;
    csv += `总收入,${currentReport.revenue.total_revenue}\n\n`;
    
    csv += '成本明细\n';
    csv += '项目,金额\n';
    csv += `课程成本,${currentReport.cost.course_cost}\n`;
    csv += `总手续费,${currentReport.cost.total_fee}\n`;
    csv += `刷单佣金,${currentReport.cost.taobao_commission}\n`;
    csv += `员工工资,${currentReport.cost.employee_salary}\n`;
    csv += `员工提成,${currentReport.cost.employee_commission}\n`;
    csv += `运营成本,${currentReport.cost.operational_cost}\n`;
    csv += `总成本,${currentReport.cost.total_cost}\n\n`;
    
    csv += '利润\n';
    csv += `净利润,${currentReport.profit.net_profit}\n`;
    csv += `利润率,${currentReport.profit.profit_margin}%\n\n`;
    
    csv += '股东利润分配\n';
    csv += '股东,净利润\n';
    csv += `股东A,${currentReport.shareholder_distribution.shareholder_a_net_profit}\n`;
    csv += `股东B,${currentReport.shareholder_distribution.shareholder_b_net_profit}\n`;
    csv += `合计,${currentReport.shareholder_distribution.total_distributed}\n`;
    
    // 下载CSV
    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `股东利润分配报表_${currentReport.period.start_date}_${currentReport.period.end_date}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
{% endblock %}