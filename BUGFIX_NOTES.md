# Bug 修复记录

## 问题描述
用户反馈频繁显示 OperationalError 页面，影响正常使用体验。

## 根本原因分析
1. **数据库结构不匹配**: 代码中的模型定义包含 `taobao_fee` 字段，但现有数据库表中没有此字段
2. **SQL 查询错误**: 在首页统计查询中，同时查询 Customer 和 TaobaoOrder 表但没有 JOIN 条件，导致笛卡尔积警告

## 解决方案

### 1. 数据库结构修复
- 为现有的 `taobao_order` 表添加缺失的 `taobao_fee` 字段
- 设置默认值为 0，类型为 FLOAT

### 2. SQL 查询优化
- 将原来的联合查询拆分为两个独立查询
- 客户统计和订单统计分别查询，避免笛卡尔积

### 3. 自动化迁移机制
- 在 `run.py` 中添加启动前数据库检查
- 自动检测并添加缺失的字段
- 创建独立的迁移脚本 `migrate_db.py`

## 预防措施
1. **启动检查**: 每次启动应用时自动检查数据库结构
2. **版本控制**: 未来模型变更时，同步更新迁移脚本
3. **错误处理**: 改进错误页面显示，提供更友好的用户体验

## 技术细节
- 使用 SQLite 的 `ALTER TABLE` 语句添加字段
- 使用 `PRAGMA table_info()` 检查表结构
- 分离查询避免 SQLAlchemy 警告

## 测试验证
- ✅ 数据库字段添加成功
- ✅ 应用正常启动，无错误页面
- ✅ 统计功能正常工作
- ✅ 自动迁移机制生效